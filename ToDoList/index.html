<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€±é–“ToDoã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ctext%20y%3D%22.9em%22%20font-size%3D%2290%22%3E%E2%9C%85%3C%2Ftext%3E%3C%2Fsvg%3E">
    <style>
        /* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
        html, body { height: 100%; margin: 0; overflow: hidden; }
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background-color: #f4f4f4; height: 100%; }
        .container { width: 100%; max-width: none; flex-grow: 1; display: flex; flex-direction: column; background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); padding: 15px; box-sizing: border-box; overflow: hidden; }
        h1 { margin-top: 0; margin-bottom: 15px; text-align: center; flex-shrink: 0; }

        /* --- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ --- */
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px; flex-shrink: 0; }
        .action-group-left, .action-group-right { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .controls button, .controls label.data-load-label { padding: 8px 15px; height: 38px; line-height: 1.5; box-sizing: border-box; cursor: pointer; border: none; border-radius: 4px; color: white; transition: background-color 0.2s; white-space: nowrap; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .week-navigation button, #saveDataBtn { background-color: #007bff; } .week-navigation button:hover, #saveDataBtn:hover { background-color: #0056b3; }
        #goToTodayBtn { background-color: #6c757d; } #goToTodayBtn:hover { background-color: #5a6268; }
        #showAddTodoDialogBtn { background-color: #17a2b8; } #showAddTodoDialogBtn:hover { background-color: #117a8b; }
        #settingsBtn { background-color: #ffc107; color: #333; } #settingsBtn:hover { background-color: #e0a800; }
        label.data-load-label { background-color: #28a745; } label.data-load-label:hover { background-color: #218838; }
        #currentWeekDisplay { font-size: 1.2em; font-weight: bold; margin: 0 10px; white-space: nowrap; }
        #loadDataInput { display: none; }

        /* --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); grid-template-rows: auto 1fr; gap: 5px; border: 1px solid #ddd; padding: 5px; background-color: #f9f9f9; flex-grow: 1; overflow: hidden; min-height: 200px; }
        .day-header { font-weight: bold; text-align: center; background-color: #f0f0f0; padding: 8px; min-height: auto; border: 1px solid #eee; }
        .day-cell { padding: 8px; border: 1px solid #eee; background-color: #fff; position: relative; display: flex; flex-direction: column; gap: 5px; overflow-y: auto; min-height: 100px; }
        .day-number-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 5px; flex-shrink: 0; text-align: center; }
        .day-number { font-size: 0.9em; color: #555; font-weight: bold; }
        .holiday-name { font-size: 0.75em; color: #dc3545; font-weight: normal; margin-top: 2px; line-height: 1.1; max-width: 95%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .sunday { background-color: #fff0e6; } .saturday { background-color: #e6f7ff; } .holiday { background-color: #ffeeee; } .today { background-color: #e6ffe6; }
        .day-header.sunday { background-color: #ffcc99; } .day-header.saturday { background-color: #b3e0ff; }

        /* --- ToDoã‚¢ã‚¤ãƒ†ãƒ  --- */
        .todo-item { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; box-shadow: 1px 1px 3px rgba(0,0,0,0.1); word-wrap: break-word; display: flex; flex-direction: column; gap: 4px; flex-shrink: 0; cursor: pointer; }
        .todo-item:hover { border-color: #aaa; }
        .todo-priority-high-bg { background-color: #ffe8cc; }
        .todo-priority-medium-bg { background-color: #ffffcc; }
        .todo-priority-low-bg { background-color: #e6f7ff; }
        .todo-item.todo-overdue-bg { background-color: #ffcccc; border-color: #f5c6cb; }
        .todo-item.completed .todo-title, .todo-item.completed .todo-details { text-decoration: line-through; color: #888; }
        .todo-details { font-size: 0.8em; color: #555; }
        .todo-priority-High { color: #e67e22; font-weight: bold; }
        .todo-priority-Medium { color: #f0ad4e; }
        .todo-priority-Low { color: #5bc0de; }
        .todo-actions { display: flex; align-items: center; justify-content: flex-start; gap: 8px; margin-top: 5px; cursor: default; }
        .todo-actions input[type="checkbox"] { cursor: pointer; margin-right: 0; }
        .completion-timestamp { font-size: 0.75em; color: #28a745; white-space: nowrap; display: none; }
        .todo-item.completed .completion-timestamp { display: inline; }
        .action-buttons { margin-left: auto; display: flex; gap: 5px; }
        .edit-todo-btn, .delete-todo-btn { background: none; border: none; cursor: pointer; font-size: 0.9em; padding: 0 3px; }
        .edit-todo-btn { color: #007bff; } .edit-todo-btn:hover { color: #0056b3; }
        .delete-todo-btn { color: #dc3545; } .delete-todo-btn:hover { color: #c82333; }

        /* --- ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å…±é€š --- */
        .dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; overflow-y: auto; padding: 20px 0;}
        .dialog-content { background-color: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); width: 90%; max-width: 480px; display: flex; flex-direction: column; gap: 15px; transition: background-color 0.3s ease; margin: auto; }
        .dialog-content h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.4em; text-align: center; }
        .dialog-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }
        .dialog-buttons button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .dialog-content label { display: block; margin-bottom: 5px; font-weight: bold; }
        .dialog-content input[type="text"], .dialog-content textarea, .dialog-content input[type="date"], .dialog-content input[type="time"], .dialog-content select, .dialog-content input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; font-size: 1em; margin-bottom: 10px; }
        .dialog-content textarea { min-height: 80px; resize: vertical; line-height: 1.6; }
        .dialog-content input[type="date"], .dialog-content input[type="time"] { height: 38px; padding: 8px; width: auto; margin-bottom: 0;}
        .dialog-content input:disabled, .dialog-content textarea:disabled, .dialog-content select:disabled { background-color: rgba(233, 236, 239, 0.5); cursor: not-allowed; }

        /* --- ToDoãƒ€ã‚¤ã‚¢ãƒ­ã‚° --- */
        .todo-dialog.dialog-priority-high-bg { background-color: #fff4e6; } .todo-dialog.dialog-priority-medium-bg { background-color: #fffff0; } .todo-dialog.dialog-priority-low-bg { background-color: #f0f8ff; }
        .datetime-input-wrapper { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        #dialogTodoDueDate { flex: 2 1 150px; }
        #dialogTodoDueTime { flex: 1 1 100px; }
        #dialogTodoDueDate:focus, #dialogTodoDueTime:focus { border-color: #86b7fe; outline: 0; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .datetime-input-wrapper.disabled #dialogTodoDueDate, .datetime-input-wrapper.disabled #dialogTodoDueTime { background-color: rgba(233, 236, 239, 0.5); cursor: not-allowed; border-color: #ced4da; box-shadow: none; }
        .recurrence-section { border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px; }
        .todo-dialog.mode-view .recurrence-section, .todo-dialog.mode-edit .recurrence-section { display: none; }
        .recurrence-options { display: none; padding-left: 15px; border-left: 3px solid #eee; margin-top: 10px; }
        .recurrence-options.visible { display: block; }
        .recurrence-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .recurrence-row input[type="number"], .recurrence-row input[type="date"], .recurrence-row select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; height: 38px; box-sizing: border-box; width: auto; margin-bottom: 0; }
        #recurrenceInterval { width: 70px; } #recurrenceDayOfMonth { width: 70px; }
        .days-of-week label { display: inline-block; margin-right: 8px; font-weight: normal; }
        .days-of-week input[type="checkbox"] { margin-right: 3px; vertical-align: middle; width: auto; margin-bottom: 0; }
        .recurrence-section input:disabled, .recurrence-section select:disabled, .recurrence-section .days-of-week input:disabled + label { opacity: 0.6; cursor: not-allowed; }
        .recurrence-section .days-of-week input:disabled { pointer-events: none;}
        .hidden { display: none; }
        .priority-palette { display: flex; justify-content: space-around; gap: 10px; margin-top: 5px; margin-bottom: 10px; }
        .priority-option { flex-grow: 1; padding: 10px 5px; border: 2px solid #ccc; border-radius: 4px; cursor: pointer; text-align: center; font-weight: bold; transition: border-color 0.2s, transform 0.1s, opacity 0.2s; color: #333; background: none; }
        .priority-option:hover { border-color: #888; }
        .priority-option.selected { border-color: #007bff; transform: scale(1.05); box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); }
        .priority-option[data-priority="High"] { background-color: #ffe8cc; } .priority-option[data-priority="Medium"] { background-color: #ffffcc; } .priority-option[data-priority="Low"] { background-color: #e6f7ff; }
        .todo-dialog.mode-view .priority-option:not(.selected) { opacity: 0.7; }
        .todo-dialog.mode-view .priority-option:hover:not(.selected) { border-color: #ccc; }
        #dialogCompletionInfo { font-size: 0.85em; color: #28a745; font-weight: bold; text-align: right; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; }
        #saveTodoDialogBtn { background-color: #28a745; color: white; } #saveTodoDialogBtn:hover { background-color: #218838; }
        #cancelTodoDialogBtn { background-color: #6c757d; color: white; } #cancelTodoDialogBtn:hover { background-color: #5a6268; }
        #editTodoDialogBtn { background-color: #ffc107; color: #333; } #editTodoDialogBtn:hover { background-color: #e0a800; }
        #closeViewDialogBtn { background-color: #6c757d; color: white; } #closeViewDialogBtn:hover { background-color: #5a6268; }

        /* --- å‰Šé™¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ€ã‚¤ã‚¢ãƒ­ã‚° --- */
        .delete-options-dialog { max-width: 400px; }
        .delete-options-dialog h2 { font-size: 1.3em; }
        .delete-options-form label { display: block; margin-bottom: 12px; font-weight: normal; cursor: pointer; }
        .delete-options-form input[type="radio"] { margin-right: 8px; vertical-align: middle; width: auto; margin-bottom: 0; }
        #confirmDeleteBtn { background-color: #dc3545; color: white; } #confirmDeleteBtn:hover { background-color: #c82333; }
        #cancelDeleteBtn { background-color: #6c757d; color: white; } #cancelDeleteBtn:hover { background-color: #5a6268; }

        /* --- è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚° --- */
        .settings-dialog { max-width: 400px; }
        .settings-dialog .settings-group { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .settings-dialog .settings-group:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .settings-dialog .settings-group legend { font-weight: bold; margin-bottom: 10px; font-size: 1.1em; }
        .settings-dialog label { display: block; margin-bottom: 8px; font-weight: normal; cursor: pointer; }
        .settings-dialog input[type="radio"] { margin-right: 8px; vertical-align: middle; width: auto; margin-bottom: 0; }
        #saveSettingsBtn { background-color: #007bff; color: white; } #saveSettingsBtn:hover { background-color: #0056b3; }
        #cancelSettingsBtn { background-color: #6c757d; color: white; } #cancelSettingsBtn:hover { background-color: #5a6268; }

    </style>
</head>
<body>
    <div class="container">
        <h1>é€±é–“ToDoã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
        <div class="controls">
             <div class="action-group-left">
                 <div class="week-navigation">
                     <button id="prevWeekBtn">&lt; å‰é€±</button>
                     <span id="currentWeekDisplay"></span>
                     <button id="nextWeekBtn">æ¬¡é€± &gt;</button>
                 </div>
                 <button id="goToTodayBtn">ä»Šæ—¥ã¸</button>
                 <button id="showAddTodoDialogBtn">ToDoè¿½åŠ </button>
                 <button id="settingsBtn">âš™ï¸ è¨­å®š</button>
             </div>
             <div class="action-group-right">
                 <button id="saveDataBtn">ğŸ’¾ ä¿å­˜</button>
                 <input type="file" id="loadDataInput" accept=".json">
                 <label for="loadDataInput" class="data-load-label">ğŸ“‚ èª­è¾¼</label>
             </div>
        </div>
        <div class="calendar-grid" id="calendarGrid">
            <!-- æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ã¯JSã§ç”Ÿæˆ -->
        </div>
    </div>

    <!-- ToDoè©³ç´°/ç·¨é›†/è¿½åŠ ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div class="dialog-overlay" id="dialogOverlay">
        <div class="todo-dialog dialog-content" id="todoDialog">
            <h2 id="dialogTitle">ToDo</h2>
            <input type="hidden" id="todoEditId">
            <input type="hidden" id="todoInstanceDate">
            <div><label for="dialogTodoTitle">ã‚¿ã‚¤ãƒˆãƒ«:</label><input type="text" id="dialogTodoTitle" required></div>
            <div>
                <label for="dialogTodoDueDate">æœŸé™æ—¥æ™‚:</label>
                <div class="datetime-input-wrapper" id="datetimeInputWrapper">
                    <input type="date" id="dialogTodoDueDate" required>
                    <input type="time" id="dialogTodoDueTime">
                </div>
                <small>â€»æ—¥ä»˜ã®ã¿æŒ‡å®šã—ãŸå ´åˆã€ãã®æ—¥ã®çµ‚ã‚ã‚ŠãŒæœŸé™ã«ãªã‚Šã¾ã™ã€‚</small>
            </div>
            <div>
                <label>å„ªå…ˆåº¦:</label>
                <div class="priority-palette" id="dialogPriorityPalette">
                    <button type="button" class="priority-option" data-priority="High">é«˜</button>
                    <button type="button" class="priority-option" data-priority="Medium">ä¸­</button>
                    <button type="button" class="priority-option" data-priority="Low">ä½</button>
                </div>
            </div>
            <div>
                <label for="dialogTodoContent">å†…å®¹:</label>
                <textarea id="dialogTodoContent" rows="4" placeholder="è©³ç´°ãªå†…å®¹ã‚’è¨˜å…¥..."></textarea>
            </div>
            <!-- ç¹°ã‚Šè¿”ã—è¨­å®š (æ–°è¦è¿½åŠ æ™‚ã®ã¿è¡¨ç¤º) -->
            <div class="recurrence-section" style="display: none;">
                <label for="recurrenceType">ç¹°ã‚Šè¿”ã—:</label>
                <select id="recurrenceType">
                    <option value="none">ã—ãªã„</option>
                    <option value="daily">æ¯æ—¥</option>
                    <option value="weekly">æ¯é€±</option>
                    <option value="monthly">æ¯æœˆ</option>
                </select>
                <div id="recurrenceOptions" class="recurrence-options">
                     <div class="recurrence-row"> <input type="number" id="recurrenceInterval" value="1" min="1"> <span id="recurrenceIntervalUnit">æ—¥é–“éš”</span> </div>
                     <div id="weeklyOptions" class="hidden recurrence-row"> <label>æ›œæ—¥:</label> <div class="days-of-week"> <label><input type="checkbox" name="daysOfWeek" value="0">æ—¥</label> <label><input type="checkbox" name="daysOfWeek" value="1">æœˆ</label> <label><input type="checkbox" name="daysOfWeek" value="2">ç«</label> <label><input type="checkbox" name="daysOfWeek" value="3">æ°´</label> <label><input type="checkbox" name="daysOfWeek" value="4">æœ¨</label> <label><input type="checkbox" name="daysOfWeek" value="5">é‡‘</label> <label><input type="checkbox" name="daysOfWeek" value="6">åœŸ</label> </div> </div>
                     <div id="monthlyOptions" class="hidden recurrence-row"> <label for="recurrenceDayOfMonth">æ—¥ä»˜:</label> <input type="number" id="recurrenceDayOfMonth" min="1" max="31"> æ—¥ </div>
                     <div class="recurrence-row"> <label for="recurrenceEndType">çµ‚äº†:</label> <select id="recurrenceEndType"> <option value="never">ã—ãªã„</option> <option value="onDate">æŒ‡å®šæ—¥</option> </select> <input type="date" id="recurrenceEndDate" class="hidden"> </div>
                </div>
            </div>
            <div id="dialogCompletionInfo" class="hidden"></div>
            <div class="dialog-buttons dialog-edit-buttons" id="dialogEditButtons"><button id="saveTodoDialogBtn">ä¿å­˜</button><button id="cancelTodoDialogBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div>
            <div class="dialog-buttons dialog-view-buttons" id="dialogViewButtons"><button id="editTodoDialogBtn">ç·¨é›†</button><button id="closeViewDialogBtn">é–‰ã˜ã‚‹</button></div>
        </div>
    </div>

    <!-- å‰Šé™¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div class="dialog-overlay" id="deleteOptionsDialogOverlay">
        <div class="delete-options-dialog dialog-content">
            <h2>å‰Šé™¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³</h2>
            <form id="deleteOptionsForm">
                <input type="hidden" id="deleteTargetId">
                <input type="hidden" id="deleteTargetInstanceDate">
                <div id="deleteOptionThisWrapper">
                    <label>
                        <input type="radio" name="deleteOption" value="this" checked> ã“ã®äºˆå®šã®ã¿å‰Šé™¤
                    </label>
                </div>
                <div id="deleteOptionFutureWrapper">
                    <label>
                        <input type="radio" name="deleteOption" value="future"> ã“ã‚Œä»¥é™ã®ã™ã¹ã¦ã®äºˆå®šã‚’å‰Šé™¤
                    </label>
                </div>
                <div id="deleteOptionAllWrapper">
                    <label>
                        <input type="radio" name="deleteOption" value="all"> ã™ã¹ã¦ã®ç¹°ã‚Šè¿”ã—äºˆå®šã‚’å‰Šé™¤
                    </label>
                </div>
            </form>
            <div class="dialog-buttons delete-options-buttons">
                <button id="confirmDeleteBtn">å‰Šé™¤å®Ÿè¡Œ</button>
                <button id="cancelDeleteBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div class="dialog-overlay" id="settingsDialogOverlay">
        <div class="settings-dialog dialog-content">
            <h2>è¨­å®š</h2>
            <form id="settingsForm">
                <fieldset class="settings-group">
                    <legend>é€±ã®é–‹å§‹æ›œæ—¥</legend>
                    <label>
                        <input type="radio" name="weekStart" value="0"> æ—¥æ›œå§‹ã¾ã‚Š
                    </label>
                    <label>
                        <input type="radio" name="weekStart" value="1"> æœˆæ›œå§‹ã¾ã‚Š
                    </label>
                </fieldset>
                <fieldset class="settings-group">
                    <legend>ToDoè¿½åŠ æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸé™æ—¥</legend>
                    <label>
                        <input type="radio" name="defaultDueDate" value="today"> ä»Šæ—¥
                    </label>
                    <label>
                        <input type="radio" name="defaultDueDate" value="week"> 1é€±é–“å¾Œ
                    </label>
                    <label>
                        <input type="radio" name="defaultDueDate" value="month"> 1ãƒ¶æœˆå¾Œ
                    </label>
                </fieldset>
            </form>
            <div class="dialog-buttons settings-buttons">
                <button id="saveSettingsBtn">ä¿å­˜</button>
                <button id="cancelSettingsBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
            let currentDate = new Date(); // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹é€±ã®åŸºæº–æ—¥
            let todos = []; // å…¨ã¦ã®ToDoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ {id, title, dueDate, priority, content, recurrence, completedDates, exceptionDates}
            let holidays = {}; // ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ {'YYYY-MM-DD': 'ç¥æ—¥å'}
            let editingTodoId = null; // ç·¨é›†/è¡¨ç¤ºä¸­ã®ToDoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID
            let editingInstanceDate = null; // ç·¨é›†/è¡¨ç¤ºä¸­ã®ToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æ—¥ä»˜ (YYYY-MM-DD)
            let selectedPriorityInDialog = 'Medium'; // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§é¸æŠä¸­ã®å„ªå…ˆåº¦
            let currentDialogMode = 'add'; // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ãƒ¢ãƒ¼ãƒ‰ ('add', 'edit', 'view')

            // --- å®šæ•° ---
            const SETTINGS_KEY = 'todoCalendarSettings'; // LocalStorageã‚­ãƒ¼
            const PRIORITY_MAP = { High: 'é«˜', Medium: 'ä¸­', Low: 'ä½' };
            const DAY_NAMES = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ']; // æ—¥æœ¬èªæ›œæ—¥å (getDay()ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«å¯¾å¿œ)
            const DEFAULT_PRIORITY = 'Medium'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå„ªå…ˆåº¦
            const DEFAULT_TIME_FOR_DATE_ONLY = '23:59'; // æ—¥ä»˜ã®ã¿æŒ‡å®šã—ãŸå ´åˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚åˆ»
            const CURRENT_DATA_VERSION = 1; // ä¿å­˜ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³

            // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤) ---
            let settings = {
                weekStartDay: 0, // 0: æ—¥æ›œå§‹ã¾ã‚Š, 1: æœˆæ›œå§‹ã¾ã‚Š
                defaultDueDateOffset: 'today' // 'today', 'week', 'month'
            };

            // --- DOMè¦ç´ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ ---
            const prevWeekBtn = document.getElementById('prevWeekBtn');
            const nextWeekBtn = document.getElementById('nextWeekBtn');
            const currentWeekDisplay = document.getElementById('currentWeekDisplay');
            const calendarGrid = document.getElementById('calendarGrid');
            const saveDataBtn = document.getElementById('saveDataBtn');
            const loadDataInput = document.getElementById('loadDataInput');
            const showAddTodoDialogBtn = document.getElementById('showAddTodoDialogBtn');
            const goToTodayBtn = document.getElementById('goToTodayBtn');
            const settingsBtn = document.getElementById('settingsBtn');
            // ToDoãƒ€ã‚¤ã‚¢ãƒ­ã‚°é–¢é€£
            const dialogOverlay = document.getElementById('dialogOverlay');
            const todoDialog = document.getElementById('todoDialog');
            const dialogTitle = document.getElementById('dialogTitle');
            const todoEditIdInput = document.getElementById('todoEditId');
            const todoInstanceDateInput = document.getElementById('todoInstanceDate');
            const dialogTodoTitleInput = document.getElementById('dialogTodoTitle');
            const dialogTodoDueDate = document.getElementById('dialogTodoDueDate');
            const dialogTodoDueTime = document.getElementById('dialogTodoDueTime');
            const datetimeInputWrapper = document.getElementById('datetimeInputWrapper');
            const dialogPriorityPalette = document.getElementById('dialogPriorityPalette');
            const priorityOptions = dialogPriorityPalette.querySelectorAll('.priority-option');
            const dialogTodoContent = document.getElementById('dialogTodoContent');
            const recurrenceSection = document.querySelector('.recurrence-section');
            const recurrenceTypeSelect = document.getElementById('recurrenceType');
            const recurrenceOptionsDiv = document.getElementById('recurrenceOptions');
            const recurrenceIntervalInput = document.getElementById('recurrenceInterval');
            const recurrenceIntervalUnitSpan = document.getElementById('recurrenceIntervalUnit');
            const weeklyOptionsDiv = document.getElementById('weeklyOptions');
            const daysOfWeekCheckboxes = document.querySelectorAll('input[name="daysOfWeek"]');
            const monthlyOptionsDiv = document.getElementById('monthlyOptions');
            const recurrenceDayOfMonthInput = document.getElementById('recurrenceDayOfMonth');
            const recurrenceEndTypeSelect = document.getElementById('recurrenceEndType');
            const recurrenceEndDateInput = document.getElementById('recurrenceEndDate');
            const dialogCompletionInfo = document.getElementById('dialogCompletionInfo');
            const dialogEditButtons = document.getElementById('dialogEditButtons');
            const dialogViewButtons = document.getElementById('dialogViewButtons');
            const saveTodoDialogBtn = document.getElementById('saveTodoDialogBtn');
            const cancelTodoDialogBtn = document.getElementById('cancelTodoDialogBtn');
            const editTodoDialogBtn = document.getElementById('editTodoDialogBtn');
            const closeViewDialogBtn = document.getElementById('closeViewDialogBtn');
            // å‰Šé™¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ€ã‚¤ã‚¢ãƒ­ã‚°é–¢é€£
            const deleteOptionsDialogOverlay = document.getElementById('deleteOptionsDialogOverlay');
            const deleteOptionsDialog = document.querySelector('.delete-options-dialog');
            const deleteOptionThisWrapper = document.getElementById('deleteOptionThisWrapper');
            const deleteOptionFutureWrapper = document.getElementById('deleteOptionFutureWrapper');
            const deleteOptionAllWrapper = document.getElementById('deleteOptionAllWrapper');
            const deleteTargetIdInput = document.getElementById('deleteTargetId');
            const deleteTargetInstanceDateInput = document.getElementById('deleteTargetInstanceDate');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            // è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°é–¢é€£
            const settingsDialogOverlay = document.getElementById('settingsDialogOverlay');
            const settingsDialog = document.querySelector('.settings-dialog');
            const settingsForm = document.getElementById('settingsForm');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const cancelSettingsBtn = document.getElementById('cancelSettingsBtn');


            // ==================================================================
            // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
            // ==================================================================

            /**
             * Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æŒ‡å®šã•ã‚ŒãŸå½¢å¼ã®æ–‡å­—åˆ—ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¾ã™ã€‚
             * @param {Date} d - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
             * @param {string} [f='YYYY-MM-DD'] - å‡ºåŠ›å½¢å¼ ('YYYY-MM-DD', 'MM/DD', 'HH:MM', 'YYYY/MM/DD HH:MM', 'YYYY-MM-DDTHH:mm')ã€‚
             * @returns {string} ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸæ—¥ä»˜æ–‡å­—åˆ—ã€‚å¤±æ•—ã—ãŸå ´åˆã¯ç©ºæ–‡å­—åˆ—ã€‚
             */
            function formatDate(d, f = 'YYYY-MM-DD') {
                try {
                    if (!(d instanceof Date) || isNaN(d.getTime())) return '';
                    const y = d.getFullYear(),
                          m = String(d.getMonth() + 1).padStart(2, '0'),
                          dt = String(d.getDate()).padStart(2, '0'),
                          h = String(d.getHours()).padStart(2, '0'),
                          min = String(d.getMinutes()).padStart(2, '0');
                    switch (f) {
                        case 'YYYY-MM-DD': return `${y}-${m}-${dt}`;
                        case 'MM/DD': return `${m}/${dt}`;
                        case 'HH:MM': return `${h}:${min}`;
                        case 'YYYY/MM/DD HH:MM': return `${y}/${m}/${dt} ${h}:${min}`;
                        case 'YYYY-MM-DDTHH:mm': return `${y}-${m}-${dt}T${h}:${min}`;
                        default: return `${y}/${m}/${dt}`;
                    }
                } catch (e) {
                    console.error("æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼:", d, e);
                    return '';
                }
            }

            /**
             * ToDoãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®èƒŒæ™¯è‰²ã‚’å„ªå…ˆåº¦ã«å¿œã˜ã¦æ›´æ–°ã—ã¾ã™ã€‚
             * @param {string|null} priority - å„ªå…ˆåº¦ ('High', 'Medium', 'Low') ã¾ãŸã¯ null (è‰²ã‚’ã‚¯ãƒªã‚¢)ã€‚
             */
            function updateDialogBackground(priority) {
                todoDialog.classList.remove('dialog-priority-high-bg', 'dialog-priority-medium-bg', 'dialog-priority-low-bg');
                if (priority) {
                    todoDialog.classList.add(`dialog-priority-${priority.toLowerCase()}-bg`);
                }
            }

            /**
             * æ—¥ä»˜æ–‡å­—åˆ— (YYYY-MM-DD) ã‚’UTCåŸºæº–ã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã¾ã™ã€‚
             * @param {string} dateStr - å¤‰æ›ã™ã‚‹æ—¥ä»˜æ–‡å­—åˆ—ã€‚
             * @returns {Date|null} å¤‰æ›å¾Œã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã¾ãŸã¯å¤±æ•—æ™‚ã«nullã€‚
             */
            function parseDateString(dateStr) {
                try {
                    if (!dateStr) return null;
                    // UTCã®0æ™‚ã¨ã—ã¦è§£é‡ˆ
                    const d = new Date(dateStr + 'T00:00:00Z');
                    return isNaN(d.getTime()) ? null : d;
                } catch {
                    return null;
                }
            }

            /**
             * äºŒã¤ã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ—¥æ•°å·®ã‚’UTCåŸºæº–ã§è¨ˆç®—ã—ã¾ã™ã€‚
             * @param {Date} date1 - æ—¥ä»˜1ã€‚
             * @param {Date} date2 - æ—¥ä»˜2ã€‚
             * @returns {number} æ—¥æ•°å·® (date1 - date2)ã€‚
             */
            function getDateDiffInDays(date1, date2) {
                const msPerDay = 1000 * 60 * 60 * 24;
                const utc1 = Date.UTC(date1.getUTCFullYear(), date1.getUTCMonth(), date1.getUTCDate());
                const utc2 = Date.UTC(date2.getUTCFullYear(), date2.getUTCMonth(), date2.getUTCDate());
                return Math.round((utc1 - utc2) / msPerDay);
            }

            /**
             * äºŒã¤ã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é€±æ•°å·®ã‚’UTCåŸºæº–ã§è¨ˆç®—ã—ã¾ã™ (é€±ã®é–‹å§‹ã¯æ—¥æ›œå›ºå®š)ã€‚
             * @param {Date} date1 - æ—¥ä»˜1ã€‚
             * @param {Date} date2 - æ—¥ä»˜2ã€‚
             * @returns {number} é€±æ•°å·® (date1ã®é€± - date2ã®é€±)ã€‚
             */
            function getWeekDiff(date1, date2) {
                const msPerWeek = 1000 * 60 * 60 * 24 * 7;
                // å„æ—¥ä»˜ã®æ—¥æ›œå§‹ã¾ã‚Šã®é€±ã®é–‹å§‹æ—¥(UTC)ã‚’è¨ˆç®—
                const startOfWeek1 = new Date(Date.UTC(date1.getUTCFullYear(), date1.getUTCMonth(), date1.getUTCDate() - date1.getUTCDay()));
                const startOfWeek2 = new Date(Date.UTC(date2.getUTCFullYear(), date2.getUTCMonth(), date2.getUTCDate() - date2.getUTCDay()));
                return Math.round((startOfWeek1.getTime() - startOfWeek2.getTime()) / msPerWeek);
            }

            /**
             * äºŒã¤ã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æœˆæ•°å·®ã‚’UTCåŸºæº–ã§è¨ˆç®—ã—ã¾ã™ã€‚
             * @param {Date} date1 - æ—¥ä»˜1ã€‚
             * @param {Date} date2 - æ—¥ä»˜2ã€‚
             * @returns {number} æœˆæ•°å·® (date1ã®æœˆ - date2ã®æœˆ)ã€‚
             */
            function getMonthDiff(date1, date2) {
                return (date1.getUTCFullYear() - date2.getUTCFullYear()) * 12 + (date1.getUTCMonth() - date2.getUTCMonth());
            }


            // ==================================================================
            // è¨­å®šé–¢é€£å‡¦ç†
            // ==================================================================

            /**
             * è¨­å®šã‚’LocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° `settings` ã‚’æ›´æ–°ã—ã¾ã™ã€‚
             */
            function loadSettings() {
                try {
                    const savedSettings = localStorage.getItem(SETTINGS_KEY);
                    if (savedSettings) {
                        const parsed = JSON.parse(savedSettings);
                        // å€¤ã®æ¤œè¨¼ã¨é©ç”¨
                        if (typeof parsed.weekStartDay === 'number' && [0, 1].includes(parsed.weekStartDay)) {
                            settings.weekStartDay = parsed.weekStartDay;
                        }
                        if (typeof parsed.defaultDueDateOffset === 'string' && ['today', 'week', 'month'].includes(parsed.defaultDueDateOffset)) {
                            settings.defaultDueDateOffset = parsed.defaultDueDateOffset;
                        }
                    }
                    // console.info("è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:", settings); // ãƒ‡ãƒãƒƒã‚°ç”¨ã«æ®‹ã—ã¦ã‚‚è‰¯ã„
                } catch (error) {
                    console.error("è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                    // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ç¶­æŒ
                }
            }

            /**
             * ç¾åœ¨ã® `settings` ã‚’LocalStorageã«ä¿å­˜ã—ã¾ã™ã€‚
             */
            function saveSettings() {
                try {
                    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
                    // console.info("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ:", settings); // ãƒ‡ãƒãƒƒã‚°ç”¨ã«æ®‹ã—ã¦ã‚‚è‰¯ã„
                } catch (error) {
                    console.error("è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                    alert("è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                }
            }

            /**
             * è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãã¾ã™ã€‚
             */
            function openSettingsDialog() {
                // ç¾åœ¨ã®è¨­å®šå€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
                settingsForm.elements.weekStart.value = settings.weekStartDay.toString();
                settingsForm.elements.defaultDueDate.value = settings.defaultDueDateOffset;
                settingsDialogOverlay.style.display = 'flex';
            }

            /**
             * è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã¾ã™ã€‚
             */
            function closeSettingsDialog() {
                settingsDialogOverlay.style.display = 'none';
            }

            /**
             * è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å†…å®¹ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° `settings` ã«åæ˜ ã—ã€ä¿å­˜ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»ã—ã¾ã™ã€‚
             */
            function saveSettingsFromDialog() {
                const newWeekStartDay = parseInt(settingsForm.elements.weekStart.value, 10);
                const newDefaultDueDateOffset = settingsForm.elements.defaultDueDate.value;

                // è¨­å®šãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿å‡¦ç†
                if (settings.weekStartDay !== newWeekStartDay || settings.defaultDueDateOffset !== newDefaultDueDateOffset) {
                    settings.weekStartDay = newWeekStartDay;
                    settings.defaultDueDateOffset = newDefaultDueDateOffset;
                    saveSettings();
                    renderCalendar(); // è¨­å®šå¤‰æ›´ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åæ˜ 
                }
                closeSettingsDialog();
            }


            // ==================================================================
            // åˆæœŸåŒ–å‡¦ç†
            // ==================================================================

            /**
             * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚è¨­å®šèª­ã¿è¾¼ã¿ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šã€ç¥æ—¥å–å¾—ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»ã‚’è¡Œã„ã¾ã™ã€‚
             */
            async function initializeApp() {
                loadSettings(); // è¨­å®šã‚’æœ€åˆã«èª­ã¿è¾¼ã‚€
                setupEventListeners();
                await fetchHolidays();
                loadInitialData(); // å¿…è¦ã§ã‚ã‚Œã°LocalStorageç­‰ã‹ã‚‰ToDoãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€å‡¦ç†ã‚’è¿½åŠ 
                renderCalendar();
            }

            /**
             * ä¸»è¦ãªUIè¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
             */
            function setupEventListeners() {
                // é€±ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
                prevWeekBtn.addEventListener('click', () => navigateWeek(-1));
                nextWeekBtn.addEventListener('click', () => navigateWeek(1));
                goToTodayBtn.addEventListener('click', () => { currentDate = new Date(); renderCalendar(); });

                // ToDoæ“ä½œ
                showAddTodoDialogBtn.addEventListener('click', () => openDialog('add'));
                saveTodoDialogBtn.addEventListener('click', saveTodoFromDialog);
                cancelTodoDialogBtn.addEventListener('click', closeDialog);
                editTodoDialogBtn.addEventListener('click', switchToEditMode);
                closeViewDialogBtn.addEventListener('click', closeDialog);
                dialogOverlay.addEventListener('click', (event) => { if (event.target === dialogOverlay) closeDialog(); });
                document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && dialogOverlay.style.display === 'flex') closeDialog(); });

                // å„ªå…ˆåº¦ãƒ‘ãƒ¬ãƒƒãƒˆ
                setupPriorityPalette();
                // ç¹°ã‚Šè¿”ã—è¨­å®šUI
                setupRecurrenceUIListeners();

                // å‰Šé™¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                confirmDeleteBtn.addEventListener('click', handleDeleteOption);
                cancelDeleteBtn.addEventListener('click', closeDeleteOptionsDialog);
                deleteOptionsDialogOverlay.addEventListener('click', (event) => { if (event.target === deleteOptionsDialogOverlay) closeDeleteOptionsDialog(); });
                document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && deleteOptionsDialogOverlay.style.display === 'flex') closeDeleteOptionsDialog(); });

                // è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                settingsBtn.addEventListener('click', openSettingsDialog);
                saveSettingsBtn.addEventListener('click', saveSettingsFromDialog);
                cancelSettingsBtn.addEventListener('click', closeSettingsDialog);
                settingsDialogOverlay.addEventListener('click', (event) => { if (event.target === settingsDialogOverlay) closeSettingsDialog(); });
                document.addEventListener('keydown', (event) => { if (event.key === 'Escape' && settingsDialogOverlay.style.display === 'flex') closeSettingsDialog(); });

                // ãƒ‡ãƒ¼ã‚¿ä¿å­˜/èª­è¾¼
                saveDataBtn.addEventListener('click', saveData);
                loadDataInput.addEventListener('change', loadData);
             }

            /**
             * ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’APIã‹ã‚‰å–å¾—ã—ã€`holidays` å¤‰æ•°ã«æ ¼ç´ã—ã¾ã™ã€‚
             * @returns {Promise<void>}
             */
            async function fetchHolidays() {
                try {
                    const response = await fetch('https://holidays-jp.github.io/api/v1/date.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    holidays = await response.json();
                    // console.info("ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸã€‚");
                } catch (error) {
                    console.error("ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
                    holidays = {}; // å–å¾—å¤±æ•—æ™‚ã¯ç©ºã«ã™ã‚‹
                }
            }

            /**
             * åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆToDoãƒªã‚¹ãƒˆãªã©ï¼‰ã‚’èª­ã¿è¾¼ã‚€å‡¦ç†ï¼ˆç¾åœ¨ã¯ãƒ€ãƒŸãƒ¼ï¼‰ã€‚
             * å¿…è¦ã«å¿œã˜ã¦LocalStorageã‹ã‚‰ã®èª­ã¿è¾¼ã¿ãªã©ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
             */
            function loadInitialData() {
                // ä¾‹: LocalStorageã‹ã‚‰ToDoãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€å ´åˆ
                // const savedTodos = localStorage.getItem('todosData');
                // if (savedTodos) {
                //     try {
                //         todos = JSON.parse(savedTodos);
                //     } catch (e) {
                //         console.error("ToDoãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:", e);
                //         todos = [];
                //     }
                // }
            }

            /**
             * ToDoãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å„ªå…ˆåº¦é¸æŠãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
             * è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã®ã‚¯ãƒªãƒƒã‚¯ã«ã‚‚å¯¾å¿œã—ã¾ã™ã€‚
             */
            function setupPriorityPalette() {
                 priorityOptions.forEach(button => {
                     button.addEventListener('click', () => {
                         const newPriority = button.dataset.priority;
                         priorityOptions.forEach(btn => btn.classList.remove('selected'));
                         button.classList.add('selected');
                         selectedPriorityInDialog = newPriority;

                         // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰(view)ã®å ´åˆã€å³åº§ã«ToDoãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»
                         if (currentDialogMode === 'view' && editingTodoId) {
                             const todo = todos.find(t => t.id === editingTodoId);
                             if (todo && todo.priority !== newPriority) {
                                 todo.priority = newPriority;
                                 updateDialogBackground(newPriority);
                                 renderCalendar();
                                 // console.info(`ToDo [${todo.id}] ã®å„ªå…ˆåº¦ã‚’ ${newPriority} ã«ç›´æ¥å¤‰æ›´ã€‚`);
                                 // saveToLocalStorage(); // å¿…è¦ãªã‚‰æ°¸ç¶šåŒ–å‡¦ç†
                             } else if (!todo) {
                                 console.error("å„ªå…ˆåº¦æ›´æ–°ã‚¨ãƒ©ãƒ¼: å¯¾è±¡ToDoä¸æ˜ (View Mode)");
                             }
                         }
                     });
                 });
             }

            /**
             * ToDoãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ç¹°ã‚Šè¿”ã—è¨­å®šUIã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚
             */
            function setupRecurrenceUIListeners() {
                recurrenceTypeSelect.addEventListener('change', (e) => {
                    const type = e.target.value;
                    recurrenceOptionsDiv.classList.toggle('visible', type !== 'none');
                    weeklyOptionsDiv.classList.toggle('hidden', type !== 'weekly');
                    monthlyOptionsDiv.classList.toggle('hidden', type !== 'monthly');
                    switch(type) {
                        case 'daily': recurrenceIntervalUnitSpan.textContent = 'æ—¥é–“éš”'; break;
                        case 'weekly': recurrenceIntervalUnitSpan.textContent = 'é€±é–“éš”'; break;
                        case 'monthly': recurrenceIntervalUnitSpan.textContent = 'ãƒ¶æœˆé–“éš”'; break;
                        default: recurrenceIntervalUnitSpan.textContent = ''; break;
                    }
                });
                recurrenceEndTypeSelect.addEventListener('change', (e) => {
                    recurrenceEndDateInput.classList.toggle('hidden', e.target.value !== 'onDate');
                });
            }


            // ==================================================================
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»é–¢é€£
            // ==================================================================

            /**
             * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰å…¨ä½“ã‚’æç”»ã—ã¾ã™ã€‚
             * æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ã€å„æ—¥ä»˜ã‚»ãƒ«ã€ToDoã‚¢ã‚¤ãƒ†ãƒ ã‚’å«ã¿ã¾ã™ã€‚
             * æœŸé™åˆ‡ã‚ŒToDoã¯ä»Šæ—¥ã®ã‚»ãƒ«ã«ç§»å‹•ã—ã¾ã™ã€‚
             */
            function renderCalendar() {
                // --- é€±ã®é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’è¨ˆç®— ---
                const startOfWeek = new Date(currentDate);
                if (settings.weekStartDay === 1) { // æœˆæ›œå§‹ã¾ã‚Šã®å ´åˆ
                    const dayOfWeek = currentDate.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
                    const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // æ—¥æ›œãªã‚‰6æ—¥å‰ã€ãã‚Œä»¥å¤–ãªã‚‰æœˆæ›œã‹ã‚‰ã®å·®
                    startOfWeek.setDate(currentDate.getDate() + diff);
                } else { // æ—¥æ›œå§‹ã¾ã‚Š (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)
                    startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());
                }
                startOfWeek.setHours(0, 0, 0, 0); // é€±ã®é–‹å§‹æ—¥ã®0æ™‚0åˆ†0ç§’

                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                endOfWeek.setHours(23, 59, 59, 999); // é€±ã®æœ€çµ‚æ—¥ã®çµ‚ã‚ã‚Š

                // --- ãƒ˜ãƒƒãƒ€ãƒ¼ã®é€±è¡¨ç¤ºã‚’æ›´æ–° ---
                currentWeekDisplay.textContent = `${formatDate(startOfWeek, 'YYYY/MM/DD')} - ${formatDate(endOfWeek, 'YYYY/MM/DD')}`;

                // --- ã‚°ãƒªãƒƒãƒ‰å†…å®¹ã‚’ã‚¯ãƒªã‚¢ ---
                calendarGrid.innerHTML = '';

                // --- æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç”Ÿæˆ ---
                const dayIndices = Array.from({ length: 7 }, (_, i) => (settings.weekStartDay + i) % 7);
                dayIndices.forEach(dayIndex => {
                    const dayHeader = document.createElement('div');
                    dayHeader.classList.add('day-header');
                    dayHeader.textContent = DAY_NAMES[dayIndex];
                    if (dayIndex === 0) dayHeader.classList.add('sunday');
                    if (dayIndex === 6) dayHeader.classList.add('saturday');
                    calendarGrid.appendChild(dayHeader);
                });

                // --- ToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç”Ÿæˆã¨åˆ†é¡ ---
                const todayStr = formatDate(new Date());
                const now = Date.now();

                // è¡¨ç¤ºç¯„å›²ã‚ˆã‚Šåºƒã‚ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆï¼ˆæœŸé™åˆ‡ã‚Œå¯¾å¿œã®ãŸã‚ï¼‰
                let allPossibleInstances = [];
                 const generateStartDate = new Date(startOfWeek);
                 generateStartDate.setFullYear(generateStartDate.getFullYear() - 1); // 1å¹´å‰ã‹ã‚‰ç”Ÿæˆé–‹å§‹
                 todos.forEach(todo => {
                     allPossibleInstances = allPossibleInstances.concat( generateRecurringInstances(todo, generateStartDate, endOfWeek) );
                 });

                // æœŸé™åˆ‡ã‚Œã§æœªå®Œäº†ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç‰¹å®š
                const overdueUncompletedInstances = allPossibleInstances.filter(inst =>
                    !inst.isCompleted && inst.instanceDueDate.getTime() < now
                );
                const overdueInstanceKeys = new Set(overdueUncompletedInstances.map(inst => `${inst.templateId}-${inst.dateString}`));

                // --- å„æ—¥ä»˜ã‚»ãƒ«ã®æç”» ---
                for (let i = 0; i < 7; i++) {
                    const cellDate = new Date(startOfWeek);
                    cellDate.setDate(startOfWeek.getDate() + i);
                    const dateStr = formatDate(cellDate);
                    const isTodayCell = (dateStr === todayStr);

                    // æ—¥ä»˜ã‚»ãƒ«è¦ç´ ã‚’ä½œæˆ
                    const dayCell = createDayCellElement(cellDate, dateStr, isTodayCell);

                    // ã“ã®æ—¥ã«è©²å½“ã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾— (è¡¨ç¤ºç¯„å›²å†…ã§ã€æœŸé™åˆ‡ã‚Œæœªå®Œäº†ã§ãªã„ã‚‚ã®)
                    let instancesForThisCell = allPossibleInstances.filter(inst => {
                         const isInView = inst.instanceDueDate >= startOfWeek && inst.instanceDueDate <= endOfWeek;
                         return inst.dateString === dateStr && isInView && !overdueInstanceKeys.has(`${inst.templateId}-${inst.dateString}`);
                    });

                    // ä»Šæ—¥ã®ã‚»ãƒ«ã®å ´åˆã€æœŸé™åˆ‡ã‚Œæœªå®Œäº†ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¿½åŠ 
                    if (isTodayCell) {
                         const currentCellInstanceKeys = new Set(instancesForThisCell.map(inst => `${inst.templateId}-${inst.dateString}`));
                         overdueUncompletedInstances.forEach(oi => {
                             if (!currentCellInstanceKeys.has(`${oi.templateId}-${oi.dateString}`)) {
                                  instancesForThisCell.push(oi);
                              }
                         });
                    }

                    // ToDoã‚¢ã‚¤ãƒ†ãƒ ã‚’ã‚½ãƒ¼ãƒˆã—ã¦ã‚»ãƒ«ã«è¿½åŠ 
                    instancesForThisCell.sort(compareTodoInstances).forEach(inst => {
                        dayCell.appendChild(createTodoElementFromInstance(inst));
                    });
                    calendarGrid.appendChild(dayCell);
                }
            }

            /**
             * æŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ã®ã‚»ãƒ«è¦ç´ ã‚’ä½œæˆã—ã¾ã™ã€‚
             * @param {Date} cellDate - ã‚»ãƒ«ã®æ—¥ä»˜ã€‚
             * @param {string} dateStr - ã‚»ãƒ«ã®æ—¥ä»˜æ–‡å­—åˆ— (YYYY-MM-DD)ã€‚
             * @param {boolean} isTodayCell - ã“ã®ã‚»ãƒ«ãŒä»Šæ—¥ã‹ã©ã†ã‹ã€‚
             * @returns {HTMLDivElement} ä½œæˆã•ã‚ŒãŸæ—¥ä»˜ã‚»ãƒ«è¦ç´ ã€‚
             */
            function createDayCellElement(cellDate, dateStr, isTodayCell) {
                 const dayCell = document.createElement('div');
                 dayCell.classList.add('day-cell');
                 dayCell.dataset.date = dateStr;

                 // æ—¥ä»˜ç•ªå·ã¨ç¥æ—¥åã‚³ãƒ³ãƒ†ãƒŠ
                 const dayNumberContainer = document.createElement('div');
                 dayNumberContainer.classList.add('day-number-container');
                 const dayNumber = document.createElement('span');
                 dayNumber.classList.add('day-number');
                 dayNumber.textContent = cellDate.getDate();
                 dayNumberContainer.appendChild(dayNumber);

                 // ç¥æ—¥è¡¨ç¤º
                 const holidayNameText = holidays[dateStr];
                 if (holidayNameText) {
                     const holidayName = document.createElement('span');
                     holidayName.classList.add('holiday-name');
                     holidayName.textContent = holidayNameText;
                     holidayName.title = holidayNameText; // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ç”¨
                     dayNumberContainer.appendChild(holidayName);
                     dayCell.classList.add('holiday');
                 }
                 dayCell.appendChild(dayNumberContainer);

                 // æ›œæ—¥ã‚¯ãƒ©ã‚¹ã¨ä»Šæ—¥ã‚¯ãƒ©ã‚¹
                 const dayOfWeek = cellDate.getDay();
                 if (dayOfWeek === 0) dayCell.classList.add('sunday');
                 if (dayOfWeek === 6) dayCell.classList.add('saturday');
                 if (isTodayCell) dayCell.classList.add('today');

                 return dayCell;
             }

            /**
             * ToDoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ã€æŒ‡å®šæœŸé–“å†…ã«ç™ºç”Ÿã™ã‚‹ToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®é…åˆ—ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
             * @param {object} todo - ToDoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
             * @param {Date} generateStartDate - ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆã‚’é–‹å§‹ã™ã‚‹æ—¥ä»˜ã€‚
             * @param {Date} generateEndDate - ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆã‚’çµ‚äº†ã™ã‚‹æ—¥ä»˜ã€‚
             * @returns {Array<object>} ç”Ÿæˆã•ã‚ŒãŸToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®é…åˆ—ã€‚
             */
            function generateRecurringInstances(todo, generateStartDate, generateEndDate) {
                const instances = [];
                let startTime = DEFAULT_TIME_FOR_DATE_ONLY;
                if (todo.dueDate) { try { const timePart = todo.dueDate.split('T')[1]?.substring(0, 5); if (timePart) startTime = timePart; } catch(e) { /* ignore */ } }

                // å˜ç™ºToDoã®å ´åˆ
                if (!todo.recurrence || todo.recurrence.type === 'none') {
                    if (todo.dueDate) {
                        try {
                            const dueDateObj = new Date(todo.dueDate);
                            if (!isNaN(dueDateObj.getTime())) {
                                // ç”Ÿæˆç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
                                const localGenerateStart = new Date(generateStartDate.getFullYear(), generateStartDate.getMonth(), generateStartDate.getDate());
                                const localGenerateEnd = new Date(generateEndDate.getFullYear(), generateEndDate.getMonth(), generateEndDate.getDate(), 23, 59, 59, 999);
                                if (dueDateObj >= localGenerateStart && dueDateObj <= localGenerateEnd) {
                                     const dateStr = formatDate(dueDateObj, 'YYYY-MM-DD');
                                     if (!todo.exceptionDates?.[dateStr]) { // é™¤å¤–æ—¥ã§ãªã‘ã‚Œã°è¿½åŠ 
                                         const isCompleted = !!todo.completedDates?.[dateStr];
                                         instances.push({ templateId: todo.id, dateString: dateStr, instanceDueDate: dueDateObj, title: todo.title, priority: todo.priority, content: todo.content, isCompleted: isCompleted, completedAt: todo.completedDates?.[dateStr] || null, recurrenceRule: null });
                                     }
                                 }
                            }
                        } catch (e) { console.error(`å˜ç™ºToDoæ—¥ä»˜è§£æã‚¨ãƒ©ãƒ¼(ID: ${todo.id}, DueDate: ${todo.dueDate}):`, e); }
                    }
                    return instances;
                }

                // ç¹°ã‚Šè¿”ã—ToDoã®å ´åˆ
                const rule = todo.recurrence;
                const startDate = parseDateString(rule.startDate); // UTC Date
                if (!startDate) return []; // é–‹å§‹æ—¥ãŒä¸æ­£ãªã‚‰ç©ºé…åˆ—
                const endDate = rule.endType === 'onDate' && rule.endDate ? parseDateString(rule.endDate) : null; // UTC Date or null

                let currentCheckDate = new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate())); // ãƒã‚§ãƒƒã‚¯é–‹å§‹æ—¥(UTC)

                // è¨ˆç®—é–‹å§‹æ—¥ã‚’æ±ºå®š (ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãŸã‚ã€ä¸è¦ãªéå»ã®è¨ˆç®—ã‚’ã‚¹ã‚­ãƒƒãƒ—)
                const calculationStartDateLimit = new Date(Date.UTC(generateStartDate.getFullYear(), generateStartDate.getMonth(), generateStartDate.getDate() - 31)); // ä½™è£•ã‚’ã‚‚ã£ã¦1ãƒ¶æœˆå‰ã‹ã‚‰
                const calculationStartDate = currentCheckDate > calculationStartDateLimit ? new Date(currentCheckDate) : new Date(calculationStartDateLimit);

                 // ã‚¹ã‚­ãƒƒãƒ—å‡¦ç†
                 if (currentCheckDate < calculationStartDate) {
                     if (rule.type === 'daily') { const diff = getDateDiffInDays(calculationStartDate, currentCheckDate); const skipCount = Math.max(0, Math.floor(diff / rule.interval) * rule.interval); currentCheckDate.setUTCDate(startDate.getUTCDate() + skipCount); }
                     else if (rule.type === 'weekly') { const diff = getWeekDiff(calculationStartDate, currentCheckDate); const skipCount = Math.max(0, Math.floor(diff / rule.interval) * rule.interval); currentCheckDate.setUTCDate(startDate.getUTCDate() + skipCount * 7); }
                     else if (rule.type === 'monthly') { const diff = getMonthDiff(calculationStartDate, currentCheckDate); const skipCount = Math.max(0, Math.floor(diff / rule.interval)); currentCheckDate.setUTCMonth(startDate.getUTCMonth() + skipCount * rule.interval); const daysInTargetMonth = new Date(currentCheckDate.getUTCFullYear(), currentCheckDate.getUTCMonth() + 1, 0).getUTCDate(); const originalDay = startDate.getUTCDate(); if (originalDay <= daysInTargetMonth) { currentCheckDate.setUTCDate(originalDay); } else { currentCheckDate.setUTCDate(daysInTargetMonth); } }
                     if (currentCheckDate < startDate) currentCheckDate = new Date(Date.UTC(startDate.getUTCFullYear(), startDate.getUTCMonth(), startDate.getUTCDate()));
                 }

                let counter = 0;
                const MAX_INSTANCES_PER_TODO = 1095; // ç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ (ç´„3å¹´åˆ†)
                const generateEndDateUTC = new Date(Date.UTC(generateEndDate.getFullYear(), generateEndDate.getMonth(), generateEndDate.getDate(), 23, 59, 59, 999));

                // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆãƒ«ãƒ¼ãƒ—
                while (currentCheckDate <= generateEndDateUTC && counter < MAX_INSTANCES_PER_TODO) {
                    counter++;
                    if (endDate && currentCheckDate > endDate) break; // ç¹°ã‚Šè¿”ã—çµ‚äº†æ—¥ãƒã‚§ãƒƒã‚¯

                    let isValidInstance = false;
                    const currentDayUTC = currentCheckDate.getUTCDay();
                    const currentDateOfMonthUTC = currentCheckDate.getUTCDate();

                    // ç¹°ã‚Šè¿”ã—ãƒ«ãƒ¼ãƒ«ã«åˆè‡´ã™ã‚‹ã‹åˆ¤å®š
                    if (currentCheckDate >= startDate) {
                        switch (rule.type) {
                            case 'daily':
                                const dayDiff = getDateDiffInDays(currentCheckDate, startDate);
                                if (dayDiff >= 0 && dayDiff % rule.interval === 0) isValidInstance = true;
                                break;
                            case 'weekly':
                                const weekDiff = getWeekDiff(currentCheckDate, startDate);
                                if (weekDiff >= 0 && weekDiff % rule.interval === 0 && rule.daysOfWeek?.includes(currentDayUTC)) isValidInstance = true;
                                break;
                            case 'monthly':
                                const monthDiff = getMonthDiff(currentCheckDate, startDate);
                                const daysInMonth = new Date(currentCheckDate.getUTCFullYear(), currentCheckDate.getUTCMonth() + 1, 0).getUTCDate();
                                const targetDay = Math.min(rule.dayOfMonth, daysInMonth); // æœˆæœ«èª¿æ•´
                                if (monthDiff >= 0 && monthDiff % rule.interval === 0 && currentDateOfMonthUTC === targetDay) isValidInstance = true;
                                break;
                        }
                    }

                    const dateStr = `${currentCheckDate.getUTCFullYear()}-${String(currentCheckDate.getUTCMonth() + 1).padStart(2, '0')}-${String(currentCheckDate.getUTCDate()).padStart(2, '0')}`;

                     // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç”Ÿæˆç¯„å›²å†…ã‹ã¤é™¤å¤–æ—¥ã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
                     let instanceDateLocalForCheck;
                     try { const [year, month, day] = dateStr.split('-').map(Number); instanceDateLocalForCheck = new Date(year, month - 1, day); } catch { instanceDateLocalForCheck = null; }
                     const localGenerateStartForCheck = new Date(generateStartDate.getFullYear(), generateStartDate.getMonth(), generateStartDate.getDate());
                     const localGenerateEndForCheck = new Date(generateEndDate.getFullYear(), generateEndDate.getMonth(), generateEndDate.getDate());

                    if (isValidInstance && instanceDateLocalForCheck && instanceDateLocalForCheck >= localGenerateStartForCheck && instanceDateLocalForCheck <= localGenerateEndForCheck && !todo.exceptionDates?.[dateStr]) {
                         // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã§ã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                         let instanceDueDateObj;
                         try {
                             const [year, month, day] = dateStr.split('-').map(Number);
                             const [hour, minute] = startTime.split(':').map(Number);
                             instanceDueDateObj = new Date(year, month - 1, day, hour || 0, minute || 0);
                             if (isNaN(instanceDueDateObj.getTime())) throw new Error("Invalid Date Object from recurrence");
                         } catch(e) {
                             console.warn(`ToDoæ—¥æ™‚ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (ID: ${todo.id}, Date: ${dateStr}, Time: ${startTime}):`, e);
                             instanceDueDateObj = new Date(dateStr + 'T00:00:00'); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                         }
                         const isCompleted = !!todo.completedDates?.[dateStr];
                         instances.push({ templateId: todo.id, dateString: dateStr, instanceDueDate: instanceDueDateObj, title: todo.title, priority: todo.priority, content: todo.content, isCompleted: isCompleted, completedAt: todo.completedDates?.[dateStr] || null, recurrenceRule: rule });
                    }
                    // æ¬¡ã®ãƒã‚§ãƒƒã‚¯æ—¥ã¸(UTC)
                    currentCheckDate.setUTCDate(currentCheckDate.getUTCDate() + 1);
                }
                if (counter >= MAX_INSTANCES_PER_TODO) {
                    console.warn(`ToDo [${todo.id}] ã®ç¹°ã‚Šè¿”ã—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”ŸæˆãŒä¸Šé™ ${MAX_INSTANCES_PER_TODO} ã«é”ã—ã¾ã—ãŸã€‚`);
                }
                return instances;
            }

            /**
             * ToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰HTMLè¦ç´ ã‚’ä½œæˆã—ã¾ã™ã€‚
             * @param {object} instance - ToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã€‚
             * @returns {HTMLDivElement} ä½œæˆã•ã‚ŒãŸToDoã‚¢ã‚¤ãƒ†ãƒ è¦ç´ ã€‚
             */
            function createTodoElementFromInstance(instance) {
                 const todoItem = document.createElement('div');
                 todoItem.classList.add('todo-item');
                 todoItem.dataset.id = instance.templateId;
                 todoItem.dataset.instanceDate = instance.dateString;

                 const priorityValue = instance.priority || DEFAULT_PRIORITY;
                 const isCompleted = instance.isCompleted;
                 const isOverdue = !isCompleted && instance.instanceDueDate.getTime() < Date.now();

                 // --- ã‚¯ãƒ©ã‚¹é©ç”¨ ---
                 // 1. èƒŒæ™¯è‰²ã‚¯ãƒ©ã‚¹
                 let bgClass = '';
                 if (!isCompleted && isOverdue) { // æœªå®Œäº†ã‹ã¤æœŸé™åˆ‡ã‚Œ
                     bgClass = 'todo-overdue-bg';
                 } else { // æœªå®Œäº†ã§æœŸé™å†… ã¾ãŸã¯ å®Œäº†æ¸ˆã¿
                     bgClass = `todo-priority-${priorityValue.toLowerCase()}-bg`;
                 }
                 if (bgClass) {
                     todoItem.classList.add(bgClass);
                 }
                 // 2. å®Œäº†ã‚¯ãƒ©ã‚¹
                 if (isCompleted) {
                     todoItem.classList.add('completed');
                 }

                 // --- è¦ç´ ã®å†…å®¹ç”Ÿæˆ ---
                 // ã‚¿ã‚¤ãƒˆãƒ«
                 const titleDiv = document.createElement('div');
                 titleDiv.classList.add('todo-title');
                 titleDiv.textContent = instance.title;
                 todoItem.appendChild(titleDiv);

                 // è©³ç´°ï¼ˆæ™‚åˆ»ã€å„ªå…ˆåº¦ï¼‰
                 const detailsDiv = document.createElement('div');
                 detailsDiv.classList.add('todo-details');
                 let detailsText = '';
                 const timePart = formatDate(instance.instanceDueDate, 'HH:MM');
                 if (timePart !== DEFAULT_TIME_FOR_DATE_ONLY && timePart !== '00:00') { // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚åˆ»/ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚åˆ»ä»¥å¤–ãªã‚‰è¡¨ç¤º
                     detailsText += `${timePart} `;
                 }
                 const prioritySpan = document.createElement('span');
                 prioritySpan.textContent = `å„ªå…ˆåº¦: ${PRIORITY_MAP[priorityValue] || PRIORITY_MAP[DEFAULT_PRIORITY]}`;
                 prioritySpan.classList.add(`todo-priority-${priorityValue}`); // å„ªå…ˆåº¦ã«å¿œã˜ãŸæ–‡å­—è‰²ã‚¯ãƒ©ã‚¹
                 detailsDiv.appendChild(document.createTextNode(detailsText));
                 detailsDiv.appendChild(prioritySpan);
                 todoItem.appendChild(detailsDiv);

                 // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã€å®Œäº†æ—¥æ™‚ã€ç·¨é›†/å‰Šé™¤ãƒœã‚¿ãƒ³ï¼‰
                 const actionsDiv = document.createElement('div');
                 actionsDiv.classList.add('todo-actions');
                 // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
                 const checkbox = document.createElement('input');
                 checkbox.type = 'checkbox';
                 checkbox.checked = instance.isCompleted;
                 checkbox.title = instance.isCompleted ? 'æœªå®Œäº†ã«æˆ»ã™' : 'å®Œäº†ã«ã™ã‚‹';
                 checkbox.addEventListener('change', () => toggleTodoStatus(instance.templateId, instance.dateString));
                 actionsDiv.appendChild(checkbox);
                 // å®Œäº†æ—¥æ™‚
                 const completionTimestampSpan = document.createElement('span');
                 completionTimestampSpan.classList.add('completion-timestamp');
                 if (instance.isCompleted && instance.completedAt) {
                     try { completionTimestampSpan.textContent = formatDate(new Date(instance.completedAt), 'YYYY/MM/DD HH:MM'); } catch(e) {/* ignore */}
                 }
                 actionsDiv.appendChild(completionTimestampSpan);
                 // ãƒœã‚¿ãƒ³ç¾¤
                 const buttonGroup = document.createElement('div');
                 buttonGroup.classList.add('action-buttons');
                 const editBtn = document.createElement('button');
                 editBtn.innerHTML = '&#9998;'; // é‰›ç­†ã‚¢ã‚¤ã‚³ãƒ³
                 editBtn.title = 'ç·¨é›†';
                 editBtn.classList.add('edit-todo-btn');
                 editBtn.addEventListener('click', () => { const templateTodo = todos.find(t => t.id === instance.templateId); if(templateTodo) openDialog('edit', templateTodo, instance.dateString); });
                 buttonGroup.appendChild(editBtn);
                 const deleteBtn = document.createElement('button');
                 deleteBtn.innerHTML = '&#10006;'; // ãƒãƒ„ã‚¢ã‚¤ã‚³ãƒ³
                 deleteBtn.title = 'å‰Šé™¤';
                 deleteBtn.classList.add('delete-todo-btn');
                 deleteBtn.addEventListener('click', () => openDeleteOptionsDialog(instance.templateId, instance.dateString));
                 buttonGroup.appendChild(deleteBtn);
                 actionsDiv.appendChild(buttonGroup);

                 todoItem.appendChild(actionsDiv);

                 // ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º (ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ä»¥å¤–)
                 todoItem.addEventListener('click', (e) => {
                     if (!e.target.closest('.todo-actions')) {
                         const templateTodo = todos.find(t => t.id === instance.templateId);
                         if (templateTodo) {
                             openDialog('view', templateTodo, instance.dateString);
                         }
                     }
                 });

                 return todoItem;
            }

             /**
              * ToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚½ãƒ¼ãƒˆã™ã‚‹ãŸã‚ã®æ¯”è¼ƒé–¢æ•°ã€‚
              * 1. æœªå®Œäº† -> å®Œäº† ã®é †
              * 2. åŒã˜å®Œäº†çŠ¶æ…‹ãªã‚‰æœŸé™æ—¥æ™‚ã®æ˜‡é †
              * @param {object} a - ToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ Aã€‚
              * @param {object} b - ToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ Bã€‚
              * @returns {number} ã‚½ãƒ¼ãƒˆé † (-1, 0, 1)ã€‚
              */
             function compareTodoInstances(a, b) {
                 if (a.isCompleted !== b.isCompleted) {
                     return a.isCompleted ? 1 : -1; // æœªå®Œäº†ãŒå…ˆ
                 }
                 // å®Œäº†çŠ¶æ…‹ãŒåŒã˜å ´åˆã€æœŸé™æ—¥æ™‚ã§ã‚½ãƒ¼ãƒˆ
                 return a.instanceDueDate.getTime() - b.instanceDueDate.getTime();
             }


            // ==================================================================
            // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°é–¢é€£å‡¦ç†
            // ==================================================================

            /**
             * ToDoè¿½åŠ /ç·¨é›†/è¡¨ç¤ºãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãã¾ã™ã€‚
             * @param {'add'|'edit'|'view'} mode - ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ãƒ¢ãƒ¼ãƒ‰ã€‚
             * @param {object} [todo=null] - ç·¨é›†/è¡¨ç¤ºå¯¾è±¡ã®ToDoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã€‚
             * @param {string} [instanceDateStr=null] - ç·¨é›†/è¡¨ç¤ºå¯¾è±¡ã®ToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æ—¥ä»˜ (YYYY-MM-DD)ã€‚
             */
            function openDialog(mode, todo = null, instanceDateStr = null) {
                 currentDialogMode = mode;
                 editingTodoId = todo ? todo.id : null;
                 editingInstanceDate = instanceDateStr;

                 // --- ãƒ€ã‚¤ã‚¢ãƒ­ã‚°çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ ---
                 todoEditIdInput.value = editingTodoId || '';
                 todoInstanceDateInput.value = instanceDateStr || '';
                 dialogCompletionInfo.classList.add('hidden');
                 dialogCompletionInfo.textContent = '';
                 updateDialogBackground(null); // èƒŒæ™¯è‰²ãƒªã‚»ãƒƒãƒˆ
                 todoDialog.classList.remove('mode-add', 'mode-edit', 'mode-view');
                 todoDialog.classList.add(`mode-${mode}`); // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 

                 // --- ãƒ¢ãƒ¼ãƒ‰åˆ¥åˆæœŸè¨­å®š ---
                 let initialPriority = DEFAULT_PRIORITY;
                 let isEditable = (mode === 'add' || mode === 'edit');
                 let initialDueDate = '';
                 let initialDueTime = '';
                 let initialContent = '';

                 if (mode === 'add') {
                     dialogTitle.textContent = 'ToDoè¿½åŠ ';
                     // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸé™æ—¥ã‚’è¨­å®šã‹ã‚‰è¨ˆç®—
                     const now = new Date();
                     let defaultDate = new Date();
                     switch (settings.defaultDueDateOffset) {
                         case 'week': defaultDate.setDate(now.getDate() + 7); break;
                         case 'month': defaultDate.setMonth(now.getMonth() + 1); break;
                         case 'today': default: break; // ä»Šæ—¥ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                     }
                     initialDueDate = formatDate(defaultDate, 'YYYY-MM-DD');
                     initialDueTime = ''; // æ™‚é–“ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç©º
                     initialContent = '';
                     recurrenceSection.style.display = 'block'; // ç¹°ã‚Šè¿”ã—è¨­å®šã‚’è¡¨ç¤º
                     selectedPriorityInDialog = DEFAULT_PRIORITY; // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å†…å„ªå…ˆåº¦ã‚’ãƒªã‚»ãƒƒãƒˆ

                 } else { // edit or view
                      if (!todo) {
                          console.error("ç·¨é›†/è¡¨ç¤ºå¯¾è±¡ã®ToDoãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                          closeDialog();
                          return;
                      }
                      initialPriority = todo.priority || DEFAULT_PRIORITY;
                      initialContent = todo.content || '';
                      selectedPriorityInDialog = initialPriority; // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å†…å„ªå…ˆåº¦ã‚’è¨­å®š
                      recurrenceSection.style.display = 'none'; // ç¹°ã‚Šè¿”ã—è¨­å®šã¯éè¡¨ç¤º

                      // è¡¨ç¤º/ç·¨é›†å¯¾è±¡ã®æ—¥æ™‚ã‚’æ±ºå®š
                      let displayDateSource = todo.dueDate; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®dueDate
                      if (mode === 'view' && instanceDateStr) {
                           // viewãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€è©²å½“ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æ—¥æ™‚ã‚’å„ªå…ˆ
                           // ç¢ºå®Ÿã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãŸã‚åºƒç¯„å›²ã§å†ç”Ÿæˆã—ã¦æ¤œç´¢
                           const viewDayStart = new Date(instanceDateStr + 'T00:00:00'); viewDayStart.setFullYear(viewDayStart.getFullYear() - 1);
                           const viewDayEnd = new Date(instanceDateStr + 'T23:59:59'); viewDayEnd.setFullYear(viewDayEnd.getFullYear() + 1);
                           const instance = generateRecurringInstances(todo, viewDayStart, viewDayEnd)
                                            .find(inst => inst.dateString === instanceDateStr);
                          if (instance) {
                              displayDateSource = instance.instanceDueDate; // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨
                          } else {
                               console.warn(`Viewãƒ¢ãƒ¼ãƒ‰ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${todo.id} - ${instanceDateStr}. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®DueDateã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`);
                          }
                      }
                      // else if (mode === 'edit') { /* editãƒ¢ãƒ¼ãƒ‰ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®template.dueDateã‚’ä½¿ç”¨ */ }

                      // æ—¥æ™‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
                      if (displayDateSource) {
                          try {
                              const dateObj = (displayDateSource instanceof Date) ? displayDateSource : new Date(displayDateSource);
                              if (!isNaN(dateObj.getTime())) {
                                  initialDueDate = formatDate(dateObj, 'YYYY-MM-DD');
                                  const timePart = formatDate(dateObj, 'HH:MM');
                                  if (timePart !== DEFAULT_TIME_FOR_DATE_ONLY && timePart !== '00:00') {
                                      initialDueTime = timePart;
                                  }
                              }
                          } catch (e) { console.error("æœŸé™æ—¥æ™‚è§£æã‚¨ãƒ©ãƒ¼:", e, displayDateSource); }
                      }

                      // ãƒ¢ãƒ¼ãƒ‰åˆ¥ã‚¿ã‚¤ãƒˆãƒ«ã¨è¿½åŠ æƒ…å ±
                      if (mode === 'edit') {
                          dialogTitle.textContent = 'ToDoç·¨é›†';
                      } else { // view
                          dialogTitle.textContent = 'ToDoè©³ç´°';
                          updateDialogBackground(initialPriority); // èƒŒæ™¯è‰²ã‚’è¨­å®š
                          // å®Œäº†æƒ…å ±ã‚’è¡¨ç¤º
                          const completedAt = todo.completedDates?.[instanceDateStr];
                          if (completedAt) {
                              try {
                                  const completedDateStr = formatDate(new Date(completedAt), 'YYYY/MM/DD HH:MM');
                                  dialogCompletionInfo.textContent = `${completedDateStr} å®Œäº†`;
                                  dialogCompletionInfo.classList.remove('hidden');
                              } catch(e) { /* ignore date parsing error */ }
                          }
                      }
                 }

                 // --- ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã«å€¤ã‚’è¨­å®š ---
                 dialogTodoTitleInput.value = todo?.title || ''; // æ–°è¦ãªã‚‰ç©º
                 dialogTodoTitleInput.disabled = !isEditable;
                 dialogTodoDueDate.value = initialDueDate;
                 dialogTodoDueTime.value = initialDueTime;
                 dialogTodoDueDate.disabled = !isEditable;
                 dialogTodoDueTime.disabled = !isEditable;
                 datetimeInputWrapper.classList.toggle('disabled', !isEditable);
                 dialogTodoContent.value = initialContent;
                 dialogTodoContent.disabled = !isEditable;

                 // ç¹°ã‚Šè¿”ã—è¨­å®šã®å€¤ (ç·¨é›†/é–²è¦§æ™‚ã‚‚å€¤ã¯è¨­å®šã—ã¦ãŠããŒã€UIã¯éè¡¨ç¤º)
                 const recurrence = todo?.recurrence;
                 recurrenceTypeSelect.value = recurrence?.type || 'none';
                 recurrenceOptionsDiv.classList.toggle('visible', !!recurrence && recurrence.type !== 'none');
                 recurrenceIntervalInput.value = recurrence?.interval || 1;
                 recurrenceIntervalUnitSpan.textContent = recurrence?.type === 'weekly' ? 'é€±é–“éš”' : (recurrence?.type === 'monthly' ? 'ãƒ¶æœˆé–“éš”' : (recurrence?.type === 'daily' ? 'æ—¥é–“éš”' : ''));
                 weeklyOptionsDiv.classList.toggle('hidden', recurrence?.type !== 'weekly');
                 daysOfWeekCheckboxes.forEach(cb => cb.checked = recurrence?.daysOfWeek?.includes(parseInt(cb.value)) || false);
                 monthlyOptionsDiv.classList.toggle('hidden', recurrence?.type !== 'monthly');
                 recurrenceDayOfMonthInput.value = recurrence?.dayOfMonth || '';
                 recurrenceEndTypeSelect.value = recurrence?.endType || 'never';
                 recurrenceEndDateInput.classList.toggle('hidden', recurrence?.endType !== 'onDate');
                 recurrenceEndDateInput.value = recurrence?.endDate || '';
                 // ç¹°ã‚Šè¿”ã—è¨­å®šã®ç·¨é›†å¯å¦
                 recurrenceTypeSelect.disabled = !isEditable;
                 recurrenceIntervalInput.disabled = !isEditable;
                 daysOfWeekCheckboxes.forEach(cb => cb.disabled = !isEditable);
                 recurrenceDayOfMonthInput.disabled = !isEditable;
                 recurrenceEndTypeSelect.disabled = !isEditable;
                 recurrenceEndDateInput.disabled = !isEditable;

                 // å„ªå…ˆåº¦ãƒ‘ãƒ¬ãƒƒãƒˆã®è¨­å®š
                 priorityOptions.forEach(button => {
                     button.disabled = false; // å¸¸ã«æœ‰åŠ¹ (viewãƒ¢ãƒ¼ãƒ‰ã§ã‚‚å¤‰æ›´å¯èƒ½)
                     button.classList.toggle('selected', button.dataset.priority === selectedPriorityInDialog);
                     button.style.cursor = 'pointer'; // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‚’ç¤ºã™
                 });

                 // ãƒœã‚¿ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
                 dialogEditButtons.style.display = isEditable ? 'flex' : 'none';
                 dialogViewButtons.style.display = isEditable ? 'none' : 'flex';

                 // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºã¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                 dialogOverlay.style.display = 'flex';
                 if (isEditable) {
                     setTimeout(() => dialogTodoTitleInput.focus(), 50); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã«
                 }
            }

            /**
             * è¡¨ç¤º(View)ãƒ¢ãƒ¼ãƒ‰ã‹ã‚‰ç·¨é›†(Edit)ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
             */
            function switchToEditMode() {
                if (currentDialogMode !== 'view' || !editingTodoId) return;
                const currentTodo = todos.find(t => t.id === editingTodoId);
                if (currentTodo) {
                    // instanceDateStrã¯ãã®ã¾ã¾å¼•ãç¶™ã
                    openDialog('edit', currentTodo, editingInstanceDate);
                } else {
                    console.error("ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã‚¨ãƒ©ãƒ¼: å¯¾è±¡ToDoä¸æ˜");
                    closeDialog();
                }
            }

            /**
             * é–‹ã„ã¦ã„ã‚‹ToDoãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã¾ã™ã€‚
             */
            function closeDialog() {
                dialogOverlay.style.display = 'none';
                // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
                editingTodoId = null;
                editingInstanceDate = null;
                currentDialogMode = 'add'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
                updateDialogBackground(null);
                datetimeInputWrapper.classList.remove('disabled');
                dialogCompletionInfo.classList.add('hidden');
                todoDialog.classList.remove('mode-add', 'mode-edit', 'mode-view');
                recurrenceSection.style.display = 'none'; // å¸¸ã«éè¡¨ç¤ºã«
            }

            /**
             * å‰Šé™¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãã¾ã™ã€‚
             * @param {string} templateId - å‰Šé™¤å¯¾è±¡ã®ToDoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDã€‚
             * @param {string} instanceDateStr - å‰Šé™¤å¯¾è±¡ã®ToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ—¥ä»˜ (YYYY-MM-DD)ã€‚
             */
            function openDeleteOptionsDialog(templateId, instanceDateStr) {
                const todo = todos.find(t => t.id === templateId);
                if (!todo) {
                    console.error("å‰Šé™¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: å¯¾è±¡ToDoä¸æ˜", templateId);
                    return;
                }
                // å¯¾è±¡æƒ…å ±ã‚’éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚»ãƒƒãƒˆ
                deleteTargetIdInput.value = templateId;
                deleteTargetInstanceDateInput.value = instanceDateStr;

                // ç¹°ã‚Šè¿”ã—è¨­å®šã«å¿œã˜ã¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
                const isRecurring = !!todo.recurrence && todo.recurrence.type !== 'none';
                deleteOptionThisWrapper.style.display = 'block'; // ã€Œã“ã®äºˆå®šã®ã¿ã€ã¯å¸¸ã«è¡¨ç¤º
                deleteOptionFutureWrapper.style.display = isRecurring ? 'block' : 'none';
                deleteOptionAllWrapper.style.display = isRecurring ? 'block' : 'none';

                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠã‚’ã€Œã“ã®äºˆå®šã®ã¿ã€ã«ã™ã‚‹
                const firstVisibleRadio = deleteOptionsDialog.querySelector('input[name="deleteOption"][value="this"]');
                if(firstVisibleRadio) firstVisibleRadio.checked = true;

                // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
                deleteOptionsDialogOverlay.style.display = 'flex';
            }

            /**
             * å‰Šé™¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã¾ã™ã€‚
             */
            function closeDeleteOptionsDialog() {
                deleteOptionsDialogOverlay.style.display = 'none';
                deleteTargetIdInput.value = '';
                deleteTargetInstanceDateInput.value = '';
            }

            /**
             * å‰Šé™¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§é¸æŠã•ã‚ŒãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«åŸºã¥ã„ã¦å‰Šé™¤å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
             */
            function handleDeleteOption() {
                const selectedOption = deleteOptionsDialog.querySelector('input[name="deleteOption"]:checked');
                const templateId = deleteTargetIdInput.value;
                const instanceDateStr = deleteTargetInstanceDateInput.value;

                if (!selectedOption || !templateId || !instanceDateStr) {
                    console.error("å‰Šé™¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: å¿…è¦ãªæƒ…å ±ãŒä¸è¶³");
                    closeDeleteOptionsDialog();
                    return;
                }

                const optionValue = selectedOption.value;
                switch (optionValue) {
                    case 'this':
                        markInstanceAsException(templateId, instanceDateStr);
                        break;
                    case 'future':
                        setRecurrenceEndDate(templateId, instanceDateStr);
                        break;
                    case 'all':
                        deleteTodoTemplate(templateId); // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¯é–¢æ•°å†…ã§è¡¨ç¤º
                        break;
                    default:
                        console.warn("æœªå®šç¾©ã®å‰Šé™¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³:", optionValue);
                        break;
                }
                closeDeleteOptionsDialog(); // å‡¦ç†å¾Œã«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
            }

            /**
             * ToDoãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®å†…å®¹ã«åŸºã¥ã„ã¦ToDoãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆè¿½åŠ ã¾ãŸã¯æ›´æ–°ï¼‰ã—ã¾ã™ã€‚
             */
            function saveTodoFromDialog() {
                // --- å…¥åŠ›å€¤å–å¾— ---
                const title = dialogTodoTitleInput.value.trim();
                const dateValue = dialogTodoDueDate.value;
                const timeValue = dialogTodoDueTime.value;
                const priority = selectedPriorityInDialog; // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§é¸æŠä¸­ã®å„ªå…ˆåº¦
                const content = dialogTodoContent.value.trim();
                const id = todoEditIdInput.value; // æ›´æ–°å¯¾è±¡ID (æ–°è¦ãªã‚‰ç©º)

                // --- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ---
                if (!title || !dateValue) {
                    alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨æœŸé™æ—¥ï¼ˆæ—¥ä»˜ï¼‰ã¯å¿…é ˆå…¥åŠ›ã§ã™ã€‚');
                    return;
                }

                // --- dueDate (ISOå½¢å¼) ã®ç”Ÿæˆ ---
                let dueDateISO = '';
                try {
                    const dateTimeString = `${dateValue}T${timeValue || DEFAULT_TIME_FOR_DATE_ONLY}:00`;
                    const localDate = new Date(dateTimeString); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã¨ã—ã¦è§£é‡ˆ
                    if (isNaN(localDate.getTime())) throw new Error("Invalid Date object created from inputs.");
                    dueDateISO = localDate.toISOString(); // UTCã«å¤‰æ›ã—ã¦ISOæ–‡å­—åˆ—ã§ä¿å­˜
                } catch (e) {
                    console.error("æœŸé™æ—¥æ™‚ã®å‡¦ç†ã‚¨ãƒ©ãƒ¼:", e);
                    alert("æœŸé™æ—¥æ™‚ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚");
                    return;
                }

                // --- ç¹°ã‚Šè¿”ã—è¨­å®šã®å–å¾— (æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿) ---
                let recurrence = null;
                if (currentDialogMode === 'add') {
                    const recurrenceType = recurrenceTypeSelect.value;
                    if (recurrenceType !== 'none') {
                        const interval = Math.max(1, parseInt(recurrenceIntervalInput.value) || 1);
                        const endType = recurrenceEndTypeSelect.value;
                        const endDate = recurrenceEndDateInput.value || undefined;
                        recurrence = { type: recurrenceType, interval, endType, endDate, startDate: dateValue }; // startDateã¯YYYY-MM-DD

                        if (recurrenceType === 'weekly') {
                            recurrence.daysOfWeek = Array.from(daysOfWeekCheckboxes).filter(cb => cb.checked).map(cb => parseInt(cb.value));
                            if (recurrence.daysOfWeek.length === 0) { alert('æ¯é€±ç¹°ã‚Šè¿”ã—ã®å ´åˆã¯æ›œæ—¥ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚'); return; }
                        } else if (recurrenceType === 'monthly') {
                            const dayOfMonth = parseInt(recurrenceDayOfMonthInput.value);
                            if (!dayOfMonth || dayOfMonth < 1 || dayOfMonth > 31) { alert('æ¯æœˆç¹°ã‚Šè¿”ã—ã®å ´åˆã¯æœ‰åŠ¹ãªæ—¥ä»˜ (1-31) ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
                            recurrence.dayOfMonth = dayOfMonth;
                        }
                        // çµ‚äº†æ—¥ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                        if (recurrence.endType === 'onDate' && (!recurrence.endDate || recurrence.endDate < recurrence.startDate)) {
                             alert('ç¹°ã‚Šè¿”ã—ã®çµ‚äº†æ—¥ã¯é–‹å§‹æ—¥ä»¥é™ã®æœ‰åŠ¹ãªæ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return;
                        }
                         // çµ‚äº†æ—¥ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯endDateãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å‰Šé™¤
                        if (recurrence.endType !== 'onDate') delete recurrence.endDate;
                    }
                }

                // --- ToDoãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ ---
                const todoData = { title, dueDate: dueDateISO, priority, content };

                // --- ä¿å­˜å‡¦ç† (æ›´æ–° or æ–°è¦è¿½åŠ ) ---
                if (id) { // æ›´æ–°
                    const index = todos.findIndex(t => t.id === id);
                    if (index !== -1) {
                        // æ›´æ–°æ™‚ã¯ recurrence ã¯å¤‰æ›´ã—ãªã„ï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°UIã§å¤‰æ›´ä¸å¯ã®ãŸã‚ï¼‰
                        todos[index] = { ...todos[index], ...todoData };
                        // console.info(`ToDo [${id}] ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚`);
                    } else {
                        console.error("ToDoæ›´æ–°ã‚¨ãƒ©ãƒ¼: å¯¾è±¡IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", id);
                        alert("ToDoã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                        closeDialog();
                        return;
                    }
                } else { // æ–°è¦è¿½åŠ 
                    const newTodo = {
                        id: Date.now().toString(), // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDç”Ÿæˆ
                        ...todoData,
                        recurrence: recurrence, // æ–°è¦è¿½åŠ æ™‚ã®ã¿è¨­å®š
                        completedDates: {}, // ç©ºã§åˆæœŸåŒ–
                        exceptionDates: {}  // ç©ºã§åˆæœŸåŒ–
                    };
                    todos.push(newTodo);
                    // console.info(`ToDo [${newTodo.id}] ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`);
                }

                // --- å¾Œå‡¦ç† ---
                closeDialog();
                renderCalendar();
                // saveTodosToLocalStorage(); // å¿…è¦ã§ã‚ã‚Œã°æ°¸ç¶šåŒ–å‡¦ç†ã‚’å‘¼ã¶
            }


            // ==================================================================
            // ToDoãƒ‡ãƒ¼ã‚¿æ“ä½œé–¢é€£
            // ==================================================================

            /**
             * æŒ‡å®šã•ã‚ŒãŸToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é™¤å¤–æ—¥ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã¾ã™ã€‚
             * @param {string} templateId - å¯¾è±¡ã®ToDoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDã€‚
             * @param {string} instanceDateStr - é™¤å¤–ã™ã‚‹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æ—¥ä»˜ (YYYY-MM-DD)ã€‚
             */
            function markInstanceAsException(templateId, instanceDateStr) {
                const todo = todos.find(t => t.id === templateId);
                if (todo) {
                    if (!todo.exceptionDates) todo.exceptionDates = {}; // ãªã‘ã‚Œã°åˆæœŸåŒ–
                    todo.exceptionDates[instanceDateStr] = true;
                    renderCalendar();
                    // console.info(`ToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ [${templateId}-${instanceDateStr}] ã‚’é™¤å¤–ã—ã¾ã—ãŸã€‚`);
                    // saveTodosToLocalStorage(); // æ°¸ç¶šåŒ–
                } else {
                    console.error("ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹é™¤å¤–ã‚¨ãƒ©ãƒ¼: å¯¾è±¡ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸æ˜", templateId);
                }
            }

            /**
             * ç¹°ã‚Šè¿”ã—ToDoã®çµ‚äº†æ—¥ã‚’æŒ‡å®šã•ã‚ŒãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å‰æ—¥ã«è¨­å®šã—ã¾ã™ã€‚
             * @param {string} templateId - å¯¾è±¡ã®ToDoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDã€‚
             * @param {string} instanceDateStr - ã“ã®æ—¥ã®å‰æ—¥ã§çµ‚äº†ã•ã›ã‚‹åŸºæº–æ—¥ (YYYY-MM-DD)ã€‚
             */
            function setRecurrenceEndDate(templateId, instanceDateStr) {
                 const todo = todos.find(t => t.id === templateId);
                 const instanceDate = parseDateString(instanceDateStr); // UTC Date

                 if (todo && instanceDate) {
                     if (!todo.recurrence) {
                         alert("ã“ã®ToDoã«ã¯ç¹°ã‚Šè¿”ã—è¨­å®šãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                         return;
                     }
                     // åŸºæº–æ—¥ã®å‰æ—¥(UTC)ã‚’è¨ˆç®—
                     const prevDate = new Date(instanceDate);
                     prevDate.setUTCDate(prevDate.getUTCDate() - 1);
                     const newEndDate = formatDate(prevDate, 'YYYY-MM-DD'); // æ–°ã—ã„çµ‚äº†æ—¥ (YYYY-MM-DD)

                     // æ–°ã—ã„çµ‚äº†æ—¥ãŒé–‹å§‹æ—¥ã‚ˆã‚Šå‰ã«ãªã‚‹å ´åˆã¯ã€å…¨å‰Šé™¤ã‚’ææ¡ˆ/å®Ÿè¡Œ
                     if (newEndDate < todo.recurrence.startDate) {
                          console.info(`ç¹°ã‚Šè¿”ã—çµ‚äº†æ—¥(${newEndDate})ãŒé–‹å§‹æ—¥(${todo.recurrence.startDate})ã‚ˆã‚Šå‰ã«ãªã‚‹ãŸã‚ã€ToDoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå…¨ä½“ã‚’å‰Šé™¤ã—ã¾ã™ã€‚`);
                          deleteTodoTemplate(templateId); // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¯å†…éƒ¨ã§è¡¨ç¤º
                     } else {
                         // ç¹°ã‚Šè¿”ã—è¨­å®šã‚’æ›´æ–°
                         todo.recurrence.endType = 'onDate';
                         todo.recurrence.endDate = newEndDate;
                         renderCalendar();
                         // console.info(`ToDo [${templateId}] ã®ç¹°ã‚Šè¿”ã—ã‚’ ${newEndDate} ã§çµ‚äº†ã—ã¾ã—ãŸã€‚`);
                         // saveTodosToLocalStorage(); // æ°¸ç¶šåŒ–
                     }
                 } else {
                     console.error("ç¹°ã‚Šè¿”ã—çµ‚äº†æ—¥è¨­å®šã‚¨ãƒ©ãƒ¼: å¯¾è±¡ToDoã¾ãŸã¯æ—¥ä»˜ãŒç„¡åŠ¹");
                 }
            }

            /**
             * ToDoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆãŠã‚ˆã³ãã®å…¨ã¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚
             * å‰Šé™¤å‰ã«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
             * @param {string} templateId - å‰Šé™¤ã™ã‚‹ToDoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDã€‚
             */
            function deleteTodoTemplate(templateId) {
                 if (!confirm('ã™ã¹ã¦ã®ç¹°ã‚Šè¿”ã—äºˆå®šï¼ˆå…ƒã®äºˆå®šã‚’å«ã‚€ï¼‰ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                     return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‚‰ä½•ã‚‚ã—ãªã„
                 }
                 const initialLength = todos.length;
                 todos = todos.filter(todo => todo.id !== templateId); // IDãŒä¸€è‡´ã—ãªã„ã‚‚ã®ã ã‘æ®‹ã™
                 if (todos.length < initialLength) {
                     renderCalendar();
                     // console.info(`ToDoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ [${templateId}] ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
                     // saveTodosToLocalStorage(); // æ°¸ç¶šåŒ–
                 } else {
                     console.warn(`å‰Šé™¤å¯¾è±¡ã®ToDoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ [${templateId}] ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
                     alert("å‰Šé™¤å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                 }
            }

            /**
             * æŒ‡å®šã•ã‚ŒãŸToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å®Œäº†/æœªå®Œäº†çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
             * @param {string} templateId - å¯¾è±¡ã®ToDoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDã€‚
             * @param {string} instanceDateStr - å¯¾è±¡ã®ToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹æ—¥ä»˜ (YYYY-MM-DD)ã€‚
             */
            function toggleTodoStatus(templateId, instanceDateStr) {
                const todo = todos.find(t => t.id === templateId);
                if (todo) {
                    if (!todo.completedDates) todo.completedDates = {}; // ãªã‘ã‚Œã°åˆæœŸåŒ–

                    if (todo.completedDates[instanceDateStr]) {
                        // å®Œäº† -> æœªå®Œäº†ã¸
                        delete todo.completedDates[instanceDateStr];
                        // console.info(`ToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ [${templateId}-${instanceDateStr}] ã‚’æœªå®Œäº†ã«ã€‚`);
                    } else {
                        // æœªå®Œäº† -> å®Œäº†ã¸
                        todo.completedDates[instanceDateStr] = new Date().toISOString(); // å®Œäº†æ—¥æ™‚ã‚’è¨˜éŒ²
                        // console.info(`ToDoã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ [${templateId}-${instanceDateStr}] ã‚’å®Œäº†ã«ã€‚`);
                    }
                    renderCalendar(); // è¡¨ç¤ºæ›´æ–°
                    // saveTodosToLocalStorage(); // æ°¸ç¶šåŒ–
                } else {
                    console.error("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼: å¯¾è±¡ToDoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸æ˜", templateId);
                }
            }


            // ==================================================================
            // é€±ç§»å‹• & ãƒ‡ãƒ¼ã‚¿ä¿å­˜/èª­è¾¼
            // ==================================================================

            /**
             * è¡¨ç¤ºã™ã‚‹é€±ã‚’æŒ‡å®šã•ã‚ŒãŸæ–¹å‘ã«ç§»å‹•ã—ã¾ã™ã€‚
             * @param {number} direction - ç§»å‹•æ–¹å‘ (-1: å‰é€±, 1: æ¬¡é€±)ã€‚
             */
            function navigateWeek(direction) {
                currentDate.setDate(currentDate.getDate() + (direction * 7));
                renderCalendar();
            }

            /**
             * ç¾åœ¨ã®ToDoãƒ‡ãƒ¼ã‚¿ã¨è¨­å®šã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚
             */
            function saveData() {
                const dataToSave = {
                    version: CURRENT_DATA_VERSION,
                    settings: settings, // ç¾åœ¨ã®è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                    todos: todos       // ç¾åœ¨ã®ToDoé…åˆ—
                };

                // ToDoãŒãªã„å ´åˆã«ç¢ºèªï¼ˆè¨­å®šã®ã¿ã§ã‚‚ä¿å­˜å¯èƒ½ï¼‰
                if (dataToSave.todos.length === 0 && !confirm("ToDoãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨­å®šæƒ…å ±ã®ã¿ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) {
                     return; // ä¿å­˜ã—ãªã„å ´åˆã¯çµ‚äº†
                 }

                 try {
                     const dataStr = JSON.stringify(dataToSave, null, 2); // è¦‹ã‚„ã™ã„ã‚ˆã†ã«ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
                     const blob = new Blob([dataStr], { type: 'application/json' });
                     const url = URL.createObjectURL(blob);
                     const a = document.createElement('a');
                     a.href = url;
                     // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ (ä¾‹: TD20231027150000.json)
                     const now=new Date(); const yyyy=now.getFullYear(),mm=String(now.getMonth()+1).padStart(2,'0'),dd=String(now.getDate()).padStart(2,'0'),hh=String(now.getHours()).padStart(2,'0'),mi=String(now.getMinutes()).padStart(2,'0'),ss=String(now.getSeconds()).padStart(2,'0'); const timestamp=`TD${yyyy}${mm}${dd}${hh}${mi}${ss}`;
                     a.download = `${timestamp}.json`; // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã¯å«ã‚ãªã„
                     document.body.appendChild(a);
                     a.click(); // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹
                     document.body.removeChild(a); // è¦ç´ å‰Šé™¤
                     URL.revokeObjectURL(url); // ãƒ¡ãƒ¢ãƒªè§£æ”¾
                     console.info(`ToDoãƒ‡ãƒ¼ã‚¿ã¨è¨­å®šã‚’ ${a.download} ã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸã€‚`);
                 } catch (error) {
                     console.error("ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
                     alert("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
                 }
             }

            /**
             * JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã•ã›ã€ToDoãƒ‡ãƒ¼ã‚¿ã¨è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
             * @param {Event} event - ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆã€‚
             */
            function loadData(event) {
                 const file = event.target.files[0];
                 if (!file) return; // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œãªã‹ã£ãŸå ´åˆ

                 const reader = new FileReader();
                 reader.onload = (e) => {
                     try {
                         const loadedData = JSON.parse(e.target.result);
                         let loadedSettings = null;
                         let loadedTodosArray = null;
                         let settingsUpdated = false;

                         // --- ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®åˆ¤å®šã¨èª­ã¿è¾¼ã¿ ---
                         if (typeof loadedData === 'object' && loadedData !== null && 'version' in loadedData && 'todos' in loadedData) {
                             // æ–°å½¢å¼: { version, settings, todos }
                             // console.info(`ãƒãƒ¼ã‚¸ãƒ§ãƒ³ ${loadedData.version} ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™...`);

                             // è¨­å®šã®å¾©å…ƒ
                             if ('settings' in loadedData && typeof loadedData.settings === 'object' && loadedData.settings !== null) {
                                 const incomingSettings = loadedData.settings;
                                 // å€¤ã®æ¤œè¨¼ã¨é©ç”¨
                                 if (typeof incomingSettings.weekStartDay === 'number' && [0, 1].includes(incomingSettings.weekStartDay)) {
                                     settings.weekStartDay = incomingSettings.weekStartDay;
                                     settingsUpdated = true;
                                 }
                                 if (typeof incomingSettings.defaultDueDateOffset === 'string' && ['today', 'week', 'month'].includes(incomingSettings.defaultDueDateOffset)) {
                                     settings.defaultDueDateOffset = incomingSettings.defaultDueDateOffset;
                                     settingsUpdated = true;
                                 }
                                 if(settingsUpdated) {
                                     saveSettings(); // LocalStorageã«ã‚‚åæ˜ 
                                     console.info("è¨­å®šæƒ…å ±ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ:", settings);
                                 } else {
                                     console.warn("ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®è¨­å®šæƒ…å ±ãŒç„¡åŠ¹ã§ã—ãŸã€‚");
                                 }
                             } else {
                                 console.warn("ãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®šæƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã§ã—ãŸã€‚");
                             }

                             // ToDoã®å¾©å…ƒ
                             if (Array.isArray(loadedData.todos)) {
                                 loadedTodosArray = loadedData.todos;
                             } else {
                                 throw new Error("ãƒ•ã‚¡ã‚¤ãƒ«å†…ã®ToDoãƒ‡ãƒ¼ã‚¿ãŒé…åˆ—å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");
                             }

                         } else if (Array.isArray(loadedData)) {
                             // æ—§å½¢å¼: [ todo1, todo2, ... ]
                             console.info("æ—§å½¢å¼ã®ToDoãƒ‡ãƒ¼ã‚¿ï¼ˆé…åˆ—ã®ã¿ï¼‰ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚è¨­å®šã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ã€‚");
                             loadedTodosArray = loadedData;
                         } else {
                             throw new Error("èªè­˜ã§ããªã„ãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
                         }

                         // --- ToDoãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼ã¨é©ç”¨ ---
                         if(loadedTodosArray !== null) {
                             const validatedTodos = loadedTodosArray.map(item => ({
                                 id: item?.id?.toString() || Date.now().toString() + Math.random(),
                                 title: item?.title || 'ç„¡é¡Œ',
                                 dueDate: item?.dueDate || '', // ISOå½¢å¼ã‚’æœŸå¾…
                                 priority: ['High', 'Medium', 'Low'].includes(item?.priority) ? item.priority : DEFAULT_PRIORITY,
                                 content: item?.content || '',
                                 recurrence: item?.recurrence || null,
                                 // completedDates/exceptionDates ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ãªã‘ã‚Œã°ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã™ã‚‹
                                 completedDates: typeof item?.completedDates === 'object' && item?.completedDates !== null ? item.completedDates : {},
                                 exceptionDates: typeof item?.exceptionDates === 'object' && item?.exceptionDates !== null ? item.exceptionDates : {}
                             }));

                             // ç¾åœ¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ä¸Šæ›¸ãç¢ºèª
                             if (todos.length > 0 && !confirm('ç¾åœ¨ã®ToDoãƒªã‚¹ãƒˆã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                                 loadDataInput.value = ''; // inputã‚’ãƒªã‚»ãƒƒãƒˆ
                                 return; // èª­ã¿è¾¼ã¿ä¸­æ­¢
                             }
                             todos = validatedTodos; // ToDoãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
                             console.info(`ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ ${todos.length} ä»¶ã®ToDoãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
                         } else if (!settingsUpdated) {
                              // ToDoãƒ‡ãƒ¼ã‚¿ã‚‚è¨­å®šæ›´æ–°ã‚‚ãªã‹ã£ãŸå ´åˆ
                              console.warn("ãƒ•ã‚¡ã‚¤ãƒ«ã«æœ‰åŠ¹ãªToDoãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                              alert("ãƒ•ã‚¡ã‚¤ãƒ«ã«æœ‰åŠ¹ãªToDoãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                              loadDataInput.value = '';
                              return;
                         }

                         // --- å†æç”» ---
                         renderCalendar();

                     } catch (error) {
                         console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿/è§£æã‚¨ãƒ©ãƒ¼:", error);
                         alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¾ãŸã¯è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${error.message}`);
                     } finally {
                         loadDataInput.value = ''; // æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ
                     }
                 };
                 reader.onerror = () => {
                     console.error("ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼");
                     alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                     loadDataInput.value = '';
                 };
                 reader.readAsText(file); // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹
             }


            // ==================================================================
            // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œé–‹å§‹
            // ==================================================================
            initializeApp();

        });
    </script>

</body>
</html>
