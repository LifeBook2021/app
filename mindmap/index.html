<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ’¡</text></svg>">
<style>
  body {
    font-family: 'Segoe UI', 'Meiryo UI', Meiryo, 'Helvetica Neue', Helvetica, Arial, sans-serif;
    margin: 0;
    padding: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 100vh;
    background-color: #f8f9fa;
  }

  /* --- ãƒ¢ãƒ€ãƒ³ãªãƒ˜ãƒƒãƒ€ãƒ¼ --- */
  #controls {
    padding: 12px 20px;
    background-color: #343a40; /* é»’èƒŒæ™¯ */
    border-bottom: 1px solid #495057;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  #controls button {
    padding: 8px 14px;
    cursor: pointer;
    border: none;
    background-color: #495057;
    color: #f8f9fa;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: background-color 0.2s ease, transform 0.1s ease;
  }
  #controls button:hover { background-color: #6c757d; }
  #controls button:active { transform: scale(0.98); background-color: #5a6268; }
  #save-json-btn { background-color: #0d6efd; color: white; }
   #save-json-btn:hover { background-color: #0b5ed7; }
   #expand-all-btn, #collapse-all-btn {
       padding: 8px 12px;
       font-size: 13px;
   }

  /* Zoom Controls Styles */
  .zoom-controls { display: flex; align-items: center; gap: 5px; margin-left: 15px; }
  .zoom-controls button { background-color: #495057; color: #f8f9fa; padding: 5px 10px; font-size: 16px; font-weight: bold; min-width: 30px; justify-content: center; }
   .zoom-controls button:hover { background-color: #6c757d; }
   #fit-to-screen-btn { padding: 5px 12px; font-size: 13px; font-weight: 500; }
  .zoom-controls input[type="number"] { width: 60px; padding: 6px 8px; background-color: #495057; color: #f8f9fa; border: 1px solid #6c757d; border-radius: 4px; font-size: 13px; text-align: right; -moz-appearance: textfield; }
  .zoom-controls input[type="number"]::-webkit-outer-spin-button, .zoom-controls input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .zoom-controls input[type="number"]:focus { outline: none; border-color: #86b7fe; box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25); }
  .zoom-controls span { font-size: 14px; margin-left: 2px; color: #ced4da; }
  /* End Zoom Controls Styles */
  /* --- ãƒ˜ãƒƒãƒ€ãƒ¼çµ‚ã‚ã‚Š --- */

  #mindmap-container { position: relative; width: 100%; flex-grow: 1; overflow: auto; background-color: #f8f9fa; outline: none; cursor: grab; }
  #mindmap-container.panning { cursor: grabbing; }
  #mindmap-canvas { position: absolute; top: 0; left: 0; width: 4000px; height: 3000px; transform-origin: 0 0; pointer-events: auto; }
  #mindmap-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; overflow: visible; }
  #mindmap-svg path { stroke-width: 1.8; fill: none; transition: stroke 0.3s ease; }
  #mindmap-nodes { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
  .node { position: absolute; border-width: 1.5px; border-style: solid; border-radius: 8px; padding: 10px 15px; cursor: grab; user-select: none; min-width: 70px; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 2; white-space: pre-wrap; word-wrap: break-word; font-size: 14px; color: #212529; transition: box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease, transform 0.1s ease, outline 0.2s ease; pointer-events: auto; }
   .node.root-node { padding: 12px 18px; font-size: 15px; }
   .node.dragging { cursor: grabbing; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
  .node.selected { box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.3); }
  .node:active:not(.dragging) { transform: scale(1.02); }
  .node .edit-input { display: block; width: calc(100% - 12px); min-height: 32px; border: 1px solid #adb5bd; font: inherit; padding: 6px; box-sizing: border-box; resize: none; margin: 0; border-radius: 5px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); background-color: rgba(255, 255, 255, 0.9); color: #212529; pointer-events: auto; z-index: 3; }
  .delete-button { position: absolute; top: -10px; right: -10px; width: 20px; height: 20px; background-color: #dc3545; color: white; border: none; border-radius: 50%; cursor: pointer; font-size: 12px; line-height: 20px; text-align: center; z-index: 4; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.2); pointer-events: auto; display: none; align-items: center; justify-content: center; }
  .delete-button:hover { background-color: #c82333; }
  .node.selected .delete-button { display: inline-flex; }
  .toggle-button { position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 20px; height: 20px; background-color: #fff; color: #495057; border: 1px solid #ced4da; border-radius: 50%; cursor: pointer; font-size: 14px; z-index: 4; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); pointer-events: auto; display: none; align-items: center; justify-content: center; }
  .toggle-button:hover { background-color: #f1f3f5; border-color: #adb5bd; }
  .node.has-children .toggle-button { display: inline-flex; }

  /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒã‚¤ãƒ©ã‚¤ãƒˆç”¨CSS */
  .node.drop-target-highlight {
    outline: 3px solid #ffc107; /* é»„è‰²ã„ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ */
    outline-offset: 2px;        /* ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ã‚’å°‘ã—å¤–å´ã« */
    box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4); /* å°‘ã—å¼·èª¿ã•ã‚ŒãŸå½± */
  }

</style>
</head>
<body>

  <div id="controls">
    <button id="save-json-btn">ğŸ’¾ ä¿å­˜</button>
    <button id="load-json-btn">ğŸ“‚ èª­è¾¼</button>
    <input type="file" id="load-json-input" accept=".json" style="display: none;">
    <button id="expand-all-btn" title="å…¨ã¦å±•é–‹">å…¨ã¦å±•é–‹</button>
    <button id="collapse-all-btn" title="å…¨ã¦é–‰ã˜ã‚‹">å…¨ã¦é–‰ã˜ã‚‹</button>
    <div class="zoom-controls">
        <button id="zoom-out-btn" title="ç¸®å°">-</button>
        <input type="number" id="zoom-input" min="10" max="200" step="10">
        <span>%</span>
        <button id="zoom-in-btn" title="æ‹¡å¤§">+</button>
        <button id="fit-to-screen-btn" title="å…¨ä½“è¡¨ç¤º">å…¨ä½“</button>
    </div>
  </div>

  <div id="mindmap-container" tabindex="0">
      <div id="mindmap-canvas">
          <svg id="mindmap-svg"></svg>
          <div id="mindmap-nodes"></div>
      </div>
  </div>

<script>
  // ========================================
  // === ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° & DOMè¦ç´ å‚ç…§ ===
  // ========================================
  const container = document.getElementById('mindmap-container');
  const canvas = document.getElementById('mindmap-canvas');
  const nodesContainer = document.getElementById('mindmap-nodes');
  const svg = document.getElementById('mindmap-svg');
  const saveJsonBtn = document.getElementById('save-json-btn');
  const loadJsonBtn = document.getElementById('load-json-btn');
  const loadJsonInput = document.getElementById('load-json-input');
  const expandAllBtn = document.getElementById('expand-all-btn');
  const collapseAllBtn = document.getElementById('collapse-all-btn');
  const zoomInBtn = document.getElementById('zoom-in-btn');
  const zoomOutBtn = document.getElementById('zoom-out-btn');
  const zoomInput = document.getElementById('zoom-input');
  const fitToScreenBtn = document.getElementById('fit-to-screen-btn');

  let nodes = []; // ãƒãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹é…åˆ—
  let nextNodeId = 1; // æ¬¡ã«æ¡ç•ªã™ã‚‹ãƒãƒ¼ãƒ‰ID
  let selectedNodeId = null; // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒ‰ã®ID
  let draggingNode = null; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ãƒãƒ¼ãƒ‰æƒ…å ±
  let isEditing = false; // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
  let rootNodeId = null; // ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ã®ID
  let highlightedDropTargetId = null; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã¦ã„ã‚‹ãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒãƒ¼ãƒ‰ã®ID
  let isPanning = false; // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ãƒ‘ãƒ³ï¼ˆç§»å‹•ï¼‰ä¸­ã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
  let panStartX = 0, panStartY = 0; // ãƒ‘ãƒ³é–‹å§‹æ™‚ã®ãƒã‚¦ã‚¹åº§æ¨™
  let panInitialScrollLeft = 0, panInitialScrollTop = 0; // ãƒ‘ãƒ³é–‹å§‹æ™‚ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®
  let currentScale = 1.0; // ç¾åœ¨ã®ã‚ºãƒ¼ãƒ å€ç‡
  const minScale = 0.1; // æœ€å°ã‚ºãƒ¼ãƒ å€ç‡
  const maxScale = 2.0; // æœ€å¤§ã‚ºãƒ¼ãƒ å€ç‡
  const scaleStep = 0.1; // ã‚ºãƒ¼ãƒ ã®åˆ»ã¿å¹…

  // ãƒãƒ¼ãƒ‰ã®è‰²è¨­å®š
  const colorPalette = [
    { bg: '#e3f2fd', border: '#90caf9', line: '#90caf9' }, { bg: '#e8f5e9', border: '#a5d6a7', line: '#a5d6a7' },
    { bg: '#fff3e0', border: '#ffcc80', line: '#ffcc80' }, { bg: '#fce4ec', border: '#f8bbd0', line: '#f8bbd0' },
    { bg: '#ede7f6', border: '#d1c4e9', line: '#d1c4e9' }, { bg: '#e0f7fa', border: '#80deea', line: '#80deea' },
    { bg: '#f9fbe7', border: '#e6ee9c', line: '#e6ee9c' }, { bg: '#fffde7', border: '#fff59d', line: '#fff59d' },
  ];
  const defaultColor = { bg: '#e9ecef', border: '#adb5bd', line: '#adb5bd' }; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è‰² (ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ã‚„é…è‰²å¯¾è±¡å¤–)
  const selectedBorderColor = '#007bff'; // é¸æŠä¸­ãƒãƒ¼ãƒ‰ã®æ ç·šè‰²

  // ========================================
  // === åˆæœŸåŒ–å‡¦ç† ===
  // ========================================
  /**
   * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã‚’è¡Œã†
   */
  function init() {
    // ãƒãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã€åˆæœŸãƒãƒ¼ãƒ‰ã‚’ä½œæˆ
    if (nodes.length === 0) {
      const initialX = canvas.offsetWidth / 2 - 70;
      const initialY = canvas.offsetHeight / 2 - 100;
      const root = createNodeObject(null, 'ä¸­å¿ƒãƒˆãƒ”ãƒƒã‚¯', initialX, initialY);
      nodes.push(root);
      selectedNodeId = root.id;
      rootNodeId = root.id;
    } else {
      // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰IDã‚’è¨­å®š
      const root = nodes.find(n => n.parentId === null);
      rootNodeId = root ? root.id : null;
      if (rootNodeId) {
        selectedNodeId = rootNodeId; // ãƒ«ãƒ¼ãƒˆã‚’é¸æŠçŠ¶æ…‹ã«
      } else if (nodes.length > 0) {
        selectedNodeId = nodes[0].id; // ãƒ«ãƒ¼ãƒˆãŒãªã„å ´åˆã¯æœ€åˆã®ãƒãƒ¼ãƒ‰ã‚’é¸æŠ
      }
    }
    render(); // æœ€åˆã®æç”»
    setupEventListeners(); // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    updateScale(currentScale, false); // åˆæœŸã‚¹ã‚±ãƒ¼ãƒ«ã‚’è¨­å®š
    if (rootNodeId) {
      centerViewOnNode(rootNodeId, false); // ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ã«è¦–ç‚¹ã‚’åˆã‚ã›ã‚‹
    } else {
      container.focus(); // ã‚³ãƒ³ãƒ†ãƒŠã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    }
  }

  // ========================================
  // === ãƒ‡ãƒ¼ã‚¿æ§‹é€  & ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ===
  // ========================================
  /**
   * æ–°ã—ã„ãƒãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹
   * @param {number|null} parentId è¦ªãƒãƒ¼ãƒ‰ã®ID (ãƒ«ãƒ¼ãƒˆã®å ´åˆã¯null)
   * @param {string} text ãƒãƒ¼ãƒ‰ã®ãƒ†ã‚­ã‚¹ãƒˆ
   * @param {number} x Xåº§æ¨™
   * @param {number} y Yåº§æ¨™
   * @returns {object} ãƒãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function createNodeObject(parentId, text, x, y) {
    return { id: nextNodeId++, parentId: parentId, text: text, x: x, y: y, isCollapsed: false };
  }

  /**
   * ãƒãƒ¼ãƒ‰ã®é…è‰²æƒ…å ±ã‚’å–å¾—ã™ã‚‹
   * @param {number} nodeId ãƒãƒ¼ãƒ‰ID
   * @returns {object} { bg, border, line } ã‚’å«ã‚€é…è‰²æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function getNodeColorInfo(nodeId) {
    const node = getNodeById(nodeId);
    if (!node || node.parentId === null) return defaultColor; // ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²

    // ãƒ«ãƒ¼ãƒˆç›´ä¸‹ã®å­ãƒãƒ¼ãƒ‰ï¼ˆä¸»ãƒˆãƒ”ãƒƒã‚¯ï¼‰ã‚’è¦‹ã¤ã‘ã‚‹
    let current = node;
    let mainTopicNode = null;
    while (current && current.parentId !== null) {
      if (current.parentId === rootNodeId) {
        mainTopicNode = current;
        break;
      }
      current = getNodeById(current.parentId);
    }

    // ä¸»ãƒˆãƒ”ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€ãã®å…„å¼Ÿé †ã«åŸºã¥ã„ã¦è‰²ã‚’æ±ºå®š
    if (mainTopicNode) {
      const mainTopics = nodes.filter(n => n.parentId === rootNodeId).sort((a, b) => a.id - b.id); // IDé †ã§ã‚½ãƒ¼ãƒˆ
      const index = mainTopics.findIndex(n => n.id === mainTopicNode.id);
      if (index !== -1) {
        const colorIndex = index % colorPalette.length; // ãƒ‘ãƒ¬ãƒƒãƒˆã‚’å¾ªç’°åˆ©ç”¨
        return colorPalette[colorIndex];
      }
    }
    return defaultColor; // ä¸»ãƒˆãƒ”ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆãªã©ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‰²
  }

  /**
   * IDã«åŸºã¥ã„ã¦ãƒãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã™ã‚‹
   * @param {number} id ãƒãƒ¼ãƒ‰ID
   * @returns {object|undefined} ãƒãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°undefined
   */
  function getNodeById(id) {
    if (id === null || id === undefined) return undefined;
    return nodes.find(node => node.id === id);
  }

  /**
   * æŒ‡å®šã•ã‚ŒãŸè¦ªIDã‚’æŒã¤å­ãƒãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹
   * @param {number} parentId è¦ªãƒãƒ¼ãƒ‰ID
   * @param {boolean} [includeCollapsed=false] è¦ªãŒæŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã„ã¦ã‚‚å­ã‚’å–å¾—ã™ã‚‹ã‹ã©ã†ã‹
   * @returns {array} å­ãƒãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
   */
  function getChildren(parentId, includeCollapsed = false) {
    if (!includeCollapsed) {
      const parentNode = getNodeById(parentId);
      if (parentNode && parentNode.isCollapsed) {
        return []; // è¦ªãŒæŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã„ã‚Œã°ç©ºé…åˆ—ã‚’è¿”ã™
      }
    }
    return nodes.filter(node => node.parentId === parentId);
  }

  /**
   * æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ãƒ‰ã®å…¨ã¦ã®å­å­«ãƒãƒ¼ãƒ‰ã®IDãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ï¼ˆå†å¸°çš„ï¼‰
   * @param {number} nodeId è¦ªãƒãƒ¼ãƒ‰ID
   * @returns {array} å­å­«ãƒãƒ¼ãƒ‰IDã®é…åˆ—
   */
  function getDescendantIds(nodeId) {
    let ids = [];
    const children = nodes.filter(node => node.parentId === nodeId);
    children.forEach(child => {
      ids.push(child.id);
      ids = ids.concat(getDescendantIds(child.id)); // å†å¸°å‘¼ã³å‡ºã—
    });
    return ids;
  }

  /**
   * ç¾åœ¨ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ãƒãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹ï¼ˆBFSãƒ™ãƒ¼ã‚¹ï¼‰
   * @returns {array} è¡¨ç¤ºå¯èƒ½æ€§ã®ã‚ã‚‹ãƒãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
   */
  function getVisibleNodes() {
    const visible = [];
    const rootNodes = nodes.filter(n => n.parentId === null);
    if (rootNodes.length === 0) return [];

    const queue = [...rootNodes];

    while (queue.length > 0) {
      const node = queue.shift();
      visible.push(node); // è¡¨ç¤ºå¯èƒ½æ€§ãƒªã‚¹ãƒˆã«è¿½åŠ 

      if (!node.isCollapsed) { // ãƒãƒ¼ãƒ‰ãŒå±•é–‹ã•ã‚Œã¦ã„ã‚Œã°å­ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
        const children = nodes.filter(n => n.parentId === node.id);
        children.forEach(child => queue.push(child));
      }
    }
    // console.log('getVisibleNodes returning IDs:', visible.map(n => n.id));
    return visible;
  }

  // ========================================
  // === ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢é€£é–¢æ•° ===
  // ========================================

  /**
   * ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—å…¨ä½“ã‚’å†æç”»ã™ã‚‹
   */
  function render() {
    nodesContainer.innerHTML = ''; // ãƒãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
    svg.innerHTML = ''; // SVGï¼ˆæ¥ç¶šç·šï¼‰ã‚’ã‚¯ãƒªã‚¢
    const potentialVisibleNodes = getVisibleNodes(); // è¡¨ç¤ºå¯èƒ½æ€§ã®ã‚ã‚‹å…¨ãƒãƒ¼ãƒ‰ã‚’å–å¾—

    // å®Ÿéš›ã«æç”»ã™ã‚‹ãƒãƒ¼ãƒ‰ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹
    const actualVisibleNodeIds = new Set(); // æç”»ã™ã‚‹ãƒãƒ¼ãƒ‰IDã‚’ç®¡ç†
    const actualVisibleNodes = []; // æç”»ã™ã‚‹ãƒãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç®¡ç†

    // 1. ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ã¯å¸¸ã«æç”»å¯¾è±¡
    const rootNodes = potentialVisibleNodes.filter(n => n.parentId === null);
    rootNodes.forEach(root => {
        actualVisibleNodeIds.add(root.id);
        actualVisibleNodes.push(root);
    });

    // 2. ãã®ä»–ã®ãƒãƒ¼ãƒ‰ã«ã¤ã„ã¦ã€è¦ªãŒæç”»å¯¾è±¡ã‹ã¤å±•é–‹ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    potentialVisibleNodes.forEach(node => {
        if (node.parentId === null) return; // ãƒ«ãƒ¼ãƒˆã¯å‡¦ç†æ¸ˆã¿

        const parentNode = getNodeById(node.parentId);
        // è¦ªãŒå­˜åœ¨ã—ã€è¦ªãŒå®Ÿéš›ã«æç”»å¯¾è±¡ã§ã‚ã‚Šã€ã‹ã¤è¦ªãŒå±•é–‹ã•ã‚Œã¦ã„ã‚‹å ´åˆ
        if (parentNode && actualVisibleNodeIds.has(parentNode.id) && !parentNode.isCollapsed) {
            actualVisibleNodeIds.add(node.id); // ã“ã®ãƒãƒ¼ãƒ‰ã‚‚æç”»å¯¾è±¡
            actualVisibleNodes.push(node);
        }
    });

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒãƒ¼ãƒ‰ã‚’æç”»
    actualVisibleNodes.forEach(node => {
      renderSingleNode(node);
    });

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒãƒ¼ãƒ‰é–“ã«ç·šã‚’æç”»
    renderLines(actualVisibleNodes);
  }

  /**
   * å˜ä¸€ã®ãƒãƒ¼ãƒ‰è¦ç´ ã‚’æç”»ã™ã‚‹
   * @param {object} node æç”»ã™ã‚‹ãƒãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function renderSingleNode(node) {
    // console.log('renderSingleNode called for ID:', node.id);
    const nodeEl = document.createElement('div');
    nodeEl.classList.add('node');
    const colorInfo = getNodeColorInfo(node.id); // è‰²æƒ…å ±ã‚’å–å¾—

    if (node.parentId === null) {
      nodeEl.classList.add('root-node'); // ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ç”¨ã‚¯ãƒ©ã‚¹
    }
    nodeEl.dataset.id = node.id; // dataå±æ€§ã«IDã‚’è¨­å®š
    nodeEl.style.left = `${node.x}px`; // ä½ç½®è¨­å®š
    nodeEl.style.top = `${node.y}px`;
    nodeEl.style.backgroundColor = colorInfo.bg; // èƒŒæ™¯è‰²è¨­å®š
    nodeEl.style.borderColor = colorInfo.border; // æ ç·šè‰²è¨­å®š

    // ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º (ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆ)
    if (!isEditing || selectedNodeId !== node.id) {
      const textSpan = document.createElement('span');
      textSpan.innerHTML = node.text.replace(/\n/g, '<br>'); // æ”¹è¡Œã‚’<br>ã«å¤‰æ›
      nodeEl.appendChild(textSpan);
    }

    // é¸æŠçŠ¶æ…‹ã®å‡¦ç†
    if (node.id === selectedNodeId) {
      nodeEl.classList.add('selected'); // é¸æŠä¸­ã‚¯ãƒ©ã‚¹
      nodeEl.style.borderColor = selectedBorderColor; // é¸æŠä¸­æ ç·šè‰²
      // å‰Šé™¤ãƒœã‚¿ãƒ³ (ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆ)
      if (!isEditing) {
        const deleteBtn = document.createElement('button');
        deleteBtn.classList.add('delete-button');
        deleteBtn.innerHTML = '&times;'; // Ã—è¨˜å·
        deleteBtn.title = 'å‰Šé™¤ (Del/BS)';
        deleteBtn.onclick = (e) => {
          e.stopPropagation(); // è¦ªè¦ç´ ã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’é˜»æ­¢
          deleteSelectedNode();
        };
        nodeEl.appendChild(deleteBtn);
      }
    }

    // æŠ˜ã‚ŠãŸãŸã¿/å±•é–‹ãƒœã‚¿ãƒ³ (å­ãƒãƒ¼ãƒ‰ã‚’æŒã¤å ´åˆ)
    const allChildren = nodes.filter(n => n.parentId === node.id); // å…¨ã¦ã®å­ï¼ˆéè¡¨ç¤ºå«ã‚€ï¼‰
    if (allChildren.length > 0) {
      nodeEl.classList.add('has-children'); // å­æŒã¡ã‚¯ãƒ©ã‚¹
      const toggleBtn = document.createElement('button');
      toggleBtn.classList.add('toggle-button');
      toggleBtn.innerHTML = node.isCollapsed ? 'â•' : 'â–'; // çŠ¶æ…‹ã«å¿œã˜ã¦ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´
      toggleBtn.title = node.isCollapsed ? 'å±•é–‹' : 'æŠ˜ã‚ŠãŸãŸã‚€';
      toggleBtn.onclick = (e) => {
        e.stopPropagation();
        toggleNodeCollapse(node.id);
      };
      nodeEl.appendChild(toggleBtn);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    nodeEl.addEventListener('mousedown', handleNodeMouseDown);
    nodeEl.addEventListener('click', handleNodeClick);
    nodeEl.addEventListener('dblclick', handleNodeDblClick);
    nodesContainer.appendChild(nodeEl); // DOMã«è¿½åŠ 

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€å…¥åŠ›æ¬„ã‚’è¿½åŠ 
    if (isEditing && selectedNodeId === node.id) {
      appendEditInputToNode(nodeEl, node);
    }
  }

  /**
   * ãƒãƒ¼ãƒ‰è¦ç´ ã«ç·¨é›†ç”¨ã®textareaã‚’è¿½åŠ ã™ã‚‹
   * @param {HTMLElement} nodeEl ãƒãƒ¼ãƒ‰ã®DOMè¦ç´ 
   * @param {object} node ãƒãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function appendEditInputToNode(nodeEl, node) {
    const existingSpan = nodeEl.querySelector('span:not(.delete-button):not(.toggle-button)');
    if(existingSpan) existingSpan.remove(); // æ—¢å­˜ã®ãƒ†ã‚­ã‚¹ãƒˆspanãŒã‚ã‚Œã°å‰Šé™¤

    const input = document.createElement('textarea');
    input.classList.add('edit-input');
    input.value = node.text; // ç¾åœ¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
    input.dataset.editingId = node.id; // ç·¨é›†ä¸­ã®IDã‚’ä¿æŒ
    input.style.height = 'auto'; // è‡ªå‹•é«˜ã•èª¿æ•´ç”¨
    input.style.overflowY = 'hidden'; // ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤º

    // å…¥åŠ›å†…å®¹ã«åˆã‚ã›ã¦é«˜ã•ã‚’è‡ªå‹•èª¿æ•´ã™ã‚‹é–¢æ•°
    const setHeight = () => {
      input.style.height = 'auto';
      input.style.height = `${input.scrollHeight}px`;
    };

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    input.addEventListener('blur', handleEditBlur); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸã‚‰ç·¨é›†çµ‚äº†
    input.addEventListener('keydown', handleEditKeyDown); // ã‚­ãƒ¼å…¥åŠ›å‡¦ç†
    input.addEventListener('input', setHeight); // å…¥åŠ›æ™‚ã«é«˜ã•èª¿æ•´

    // å‰Šé™¤/ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®å‰ã«æŒ¿å…¥
    const deleteBtn = nodeEl.querySelector('.delete-button');
    const toggleBtn = nodeEl.querySelector('.toggle-button');
    const referenceNode = deleteBtn || toggleBtn || null;
    nodeEl.insertBefore(input, referenceNode);

    input.focus(); // è‡ªå‹•ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    input.select(); // ãƒ†ã‚­ã‚¹ãƒˆå…¨é¸æŠ
    setTimeout(setHeight, 0); // åˆæœŸæç”»å¾Œã«é«˜ã•ã‚’è¨­å®š
  }

  /**
   * ãƒãƒ¼ãƒ‰é–“ã®æ¥ç¶šç·šã‚’SVGã§æç”»ã™ã‚‹
   * @param {array} actualVisibleNodes å®Ÿéš›ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒ‰ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
   */
  function renderLines(actualVisibleNodes) {
    svg.innerHTML = ''; // SVGå†…å®¹ã‚’ã‚¯ãƒªã‚¢
    actualVisibleNodes.forEach(node => {
      if (node.parentId !== null) { // ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ä»¥å¤–
        const parentNode = getNodeById(node.parentId);
        // è¦ªãŒæç”»ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        if (parentNode && actualVisibleNodes.some(vn => vn.id === parentNode.id)) {
          const parentEl = nodesContainer.querySelector(`.node[data-id='${parentNode.id}']`);
          const childEl = nodesContainer.querySelector(`.node[data-id='${node.id}']`);
          // è¦ªãƒ»å­ä¸¡æ–¹ã®DOMè¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ç·šã‚’æç”»
          if (parentEl && childEl) {
            const colorInfo = getNodeColorInfo(node.id); // å­ãƒãƒ¼ãƒ‰ã®è‰²ã«åˆã‚ã›ã‚‹
            const path = drawCurvedLine(parentEl, childEl); // ç·šã‚’æç”»
            if (path) {
              path.setAttribute('data-from-node-id', parentNode.id); // æ¥ç¶šå…ƒID
              path.setAttribute('data-to-node-id', node.id);     // æ¥ç¶šå…ˆID
              path.style.stroke = colorInfo.line; // ç·šã®è‰²è¨­å®š
              svg.appendChild(path); // SVGã«è¿½åŠ 
            }
          }
        }
      }
    });
  }

  /**
   * 2ã¤ã®è¦ç´ é–“ã«ã‚«ãƒ¼ãƒ–ã—ãŸç·šï¼ˆSVGãƒ‘ã‚¹ï¼‰ã‚’æç”»ã™ã‚‹
   * @param {HTMLElement} el1 é–‹å§‹è¦ç´ 
   * @param {HTMLElement} el2 çµ‚äº†è¦ç´ 
   * @returns {SVGPathElement} æç”»ã•ã‚ŒãŸãƒ‘ã‚¹è¦ç´ 
   */
  function drawCurvedLine(el1, el2) {
    const x1 = el1.offsetLeft + el1.offsetWidth / 2; // é–‹å§‹ç‚¹X (è¦ç´ ä¸­å¿ƒ)
    const y1 = el1.offsetTop + el1.offsetHeight / 2; // é–‹å§‹ç‚¹Y
    const x2 = el2.offsetLeft + el2.offsetWidth / 2; // çµ‚äº†ç‚¹X
    const y2 = el2.offsetTop + el2.offsetHeight / 2; // çµ‚äº†ç‚¹Y
    const dx = x2 - x1;
    const curveFactor = 0.5; // ã‚«ãƒ¼ãƒ–ã®æ›²ãŒã‚Šå…·åˆã‚’èª¿æ•´
    // ãƒ™ã‚¸ã‚§æ›²ç·šã®åˆ¶å¾¡ç‚¹ã‚’è¨ˆç®—
    const ctrlX1 = x1 + dx * curveFactor;
    const ctrlY1 = y1;
    const ctrlX2 = x1 + dx * (1 - curveFactor);
    const ctrlY2 = y2;
    // SVGãƒ‘ã‚¹ãƒ‡ãƒ¼ã‚¿æ–‡å­—åˆ—ã‚’ä½œæˆ
    const pathData = `M ${x1} ${y1} C ${ctrlX1} ${ctrlY1}, ${ctrlX2} ${ctrlY2}, ${x2} ${y2}`;
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', pathData);
    return path;
  }

  // ========================================
  // === ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ===
  // ========================================
  /**
   * å„ç¨®UIè¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹
   */
  function setupEventListeners() {
    // ãƒœã‚¿ãƒ³é¡
    saveJsonBtn.addEventListener('click', handleSaveJson);
    loadJsonBtn.addEventListener('click', () => loadJsonInput.click()); // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
    loadJsonInput.addEventListener('change', handleLoadJsonFile);
    expandAllBtn.addEventListener('click', handleExpandAll);
    collapseAllBtn.addEventListener('click', handleCollapseAll);
    zoomInBtn.addEventListener('click', handleZoomIn);
    zoomOutBtn.addEventListener('click', handleZoomOut);
    fitToScreenBtn.addEventListener('click', handleFitToScreen);
    zoomInput.addEventListener('change', handleZoomInputChange); // å€¤å¤‰æ›´æ™‚
    zoomInput.addEventListener('blur', handleZoomInputChange);   // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸæ™‚

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ»ãƒã‚¦ã‚¹æ“ä½œ
    window.addEventListener('keydown', handleKeyDown); // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªã‚­ãƒ¼ãƒ€ã‚¦ãƒ³
    container.addEventListener('mousedown', handlePanStart); // ã‚³ãƒ³ãƒ†ãƒŠä¸Šã§ã®ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³ (ãƒ‘ãƒ³é–‹å§‹)
    container.addEventListener('wheel', handleWheelZoom, { passive: false }); // Ctrl+ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ 
    window.addEventListener('mousemove', handlePanOrDragMove); // ãƒã‚¦ã‚¹ç§»å‹• (ãƒ‘ãƒ³ or ãƒ‰ãƒ©ãƒƒã‚°)
    window.addEventListener('mouseup', handlePanOrDragEnd);   // ãƒã‚¦ã‚¹ã‚¢ãƒƒãƒ— (ãƒ‘ãƒ³ or ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†)
  }

  // ========================================
  // === ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ===
  // ========================================

  // --- ãƒˆãƒ”ãƒƒã‚¯æ“ä½œ ---

  /**
   * é¸æŠä¸­ã®ãƒãƒ¼ãƒ‰ã«å­ãƒãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ (Tabã‚­ãƒ¼)
   */
  function addChildNode() {
    if (selectedNodeId === null || isEditing) return; // é¸æŠä¸­ãƒãƒ¼ãƒ‰ãŒãªã„ã€ã¾ãŸã¯ç·¨é›†ä¸­ã¯ä¸å¯
    const parentNode = getNodeById(selectedNodeId);
    if (parentNode) {
      const children = nodes.filter(n => n.parentId === parentNode.id);
      const topicCounter = children.length + 1;
      let defaultText = (parentNode.parentId === null) ? `ä¸»ãƒˆãƒ”ãƒƒã‚¯ ${topicCounter}` : `ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯ ${topicCounter}`;

      // æ–°ã—ã„ãƒãƒ¼ãƒ‰ã®ä½ç½®ã‚’è¨ˆç®—
      const parentEl = nodesContainer.querySelector(`.node[data-id='${parentNode.id}']`);
      const parentWidth = parentEl ? parentEl.offsetWidth : 100;
      const parentHeight = parentEl ? parentEl.offsetHeight : 40;
      const offsetX = parentWidth + 70 + Math.random() * 30; // è¦ªã®å³å´ã«ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’åŠ ãˆã¦é…ç½®
      const lastChild = children.length > 0 ? getNodeById(children[children.length-1].id) : null;
      const lastChildEl = lastChild ? nodesContainer.querySelector(`.node[data-id='${lastChild.id}']`) : null;
      let newY = lastChildEl ? (lastChild.y + lastChildEl.offsetHeight + 25) : (parentNode.y + parentHeight * 0.1); // æœ€å¾Œã®å…„å¼Ÿã®ä¸‹ã€ã¾ãŸã¯è¦ªã®å°‘ã—ä¸‹
      const newX = parentNode.x + offsetX;

      const newNode = createNodeObject(selectedNodeId, defaultText, newX, newY);
      nodes.push(newNode);

      // è¦ªãŒæŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã„ãŸã‚‰å±•é–‹ã—ã¦ã‹ã‚‰å†æç”»
      if (parentNode.isCollapsed) {
        parentNode.isCollapsed = false;
        render();
      } else {
        render(); // é€šå¸¸ã®å†æç”»
      }
      selectedNodeId = newNode.id; // æ–°ã—ãè¿½åŠ ã—ãŸãƒãƒ¼ãƒ‰ã‚’é¸æŠ
      startEditingNode(newNode.id); // æ–°è¦ãƒãƒ¼ãƒ‰ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«
    }
  }

  /**
   * é¸æŠä¸­ã®ãƒãƒ¼ãƒ‰ã¨åŒã˜éšå±¤ã«å…„å¼Ÿãƒãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ (Enterã‚­ãƒ¼)
   */
  function addSiblingNode() {
    if (selectedNodeId === null || isEditing) return; // é¸æŠä¸­ãƒãƒ¼ãƒ‰ãŒãªã„ã€ã¾ãŸã¯ç·¨é›†ä¸­ã¯ä¸å¯
    const selectedNode = getNodeById(selectedNodeId);
    if (selectedNode && selectedNode.parentId !== null) { // ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ä»¥å¤–ã®å ´åˆ
      const parentId = selectedNode.parentId;
      const parentNode = getNodeById(parentId);
      if (parentNode) {
        const siblings = nodes.filter(n => n.parentId === parentId);
        const topicCounter = siblings.length + 1;
        let defaultText = (parentNode.parentId === null) ? `ä¸»ãƒˆãƒ”ãƒƒã‚¯ ${topicCounter}` : `ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯ ${topicCounter}`;

        // æ–°ã—ã„ãƒãƒ¼ãƒ‰ã®ä½ç½®ã‚’è¨ˆç®— (é¸æŠä¸­ãƒãƒ¼ãƒ‰ã®ä¸‹)
        const selectedNodeEl = nodesContainer.querySelector(`.node[data-id='${selectedNode.id}']`);
        const nodeHeight = selectedNodeEl ? selectedNodeEl.offsetHeight : 40;
        const newX = selectedNode.x;
        const newY = selectedNode.y + nodeHeight + 25; // é¸æŠãƒãƒ¼ãƒ‰ã®ä¸‹ã«é…ç½®

        const newNode = createNodeObject(parentId, defaultText, newX, newY);
        nodes.push(newNode);
        selectedNodeId = newNode.id; // æ–°ã—ãè¿½åŠ ã—ãŸãƒãƒ¼ãƒ‰ã‚’é¸æŠ
        render();
        startEditingNode(newNode.id); // æ–°è¦ãƒãƒ¼ãƒ‰ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«
      }
    } else if (selectedNode && selectedNode.parentId === null) {
      // ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€å­ãƒãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹å‹•ä½œã«ã™ã‚‹
      addChildNode();
    }
  }

  /**
   * é¸æŠä¸­ã®ãƒãƒ¼ãƒ‰ï¼ˆãŠã‚ˆã³ãã®å­å­«ï¼‰ã‚’å‰Šé™¤ã™ã‚‹ (Delete/Backspaceã‚­ãƒ¼)
   */
  function deleteSelectedNode() {
    if (selectedNodeId === null || isEditing) return; // é¸æŠä¸­ãƒãƒ¼ãƒ‰ãŒãªã„ã€ã¾ãŸã¯ç·¨é›†ä¸­ã¯ä¸å¯
    const nodeToDelete = getNodeById(selectedNodeId);
    if (!nodeToDelete) return;

    // ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ã®å‰Šé™¤åˆ¶é™
    if (nodeToDelete.parentId === null && nodes.length > 1) {
      alert('ä¸­å¿ƒãƒˆãƒ”ãƒƒã‚¯ã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚');
      return;
    }
    // æœ€å¾Œã®ãƒãƒ¼ãƒ‰å‰Šé™¤æ™‚ã®ç¢ºèª
    if (nodeToDelete.parentId === null && nodes.length === 1) {
      if (!confirm('æœ€å¾Œã®ãƒˆãƒ”ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿãƒãƒƒãƒ—ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã™ã€‚')) return;
    } else {
      // å­å­«ãŒã„ã‚‹å ´åˆã®ç¢ºèª
      const descendantIds = getDescendantIds(nodeToDelete.id);
      const hasChildren = descendantIds.length > 0;
      if (hasChildren) {
        if (!confirm(`'${nodeToDelete.text}' ã¨ãã®å…¨ã¦ã®ã‚µãƒ–ãƒˆãƒ”ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      }
    }

    // å‰Šé™¤å¯¾è±¡ã®IDãƒªã‚¹ãƒˆï¼ˆè‡ªèº« + å­å­«ï¼‰
    const idsToDelete = [nodeToDelete.id].concat(getDescendantIds(nodeToDelete.id));

    // å‰Šé™¤å¾Œã®é¸æŠãƒãƒ¼ãƒ‰ã‚’æ±ºå®š
    let nextSelectedId = null;
    const parentId = nodeToDelete.parentId;
    if (parentId !== null) { // ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ä»¥å¤–ã®å ´åˆ
      const siblings = nodes.filter(n => n.parentId === parentId);
      const index = siblings.findIndex(n => n.id === nodeToDelete.id);
      if (index > 0) { // å‰ã®å…„å¼Ÿã‚’é¸æŠ
        nextSelectedId = siblings[index - 1].id;
      } else if (siblings.length > 1 && index === 0) { // æœ€åˆã®å…„å¼Ÿã§ã€ä»–ã«å…„å¼ŸãŒã„ã‚Œã°æ¬¡ã‚’é¸æŠ
        nextSelectedId = siblings[1].id;
      } else { // å…„å¼ŸãŒã„ãªã„å ´åˆã¯è¦ªã‚’é¸æŠ
        nextSelectedId = parentId;
      }
    } else {
      nextSelectedId = null; // ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰å‰Šé™¤å¾Œã¯é¸æŠãªã—
    }

    // ãƒãƒ¼ãƒ‰é…åˆ—ã‹ã‚‰å‰Šé™¤
    nodes = nodes.filter(node => !idsToDelete.includes(node.id));
    selectedNodeId = nextSelectedId;

    // å…¨ãƒãƒ¼ãƒ‰å‰Šé™¤å¾Œã®å‡¦ç†
    if (nodes.length === 0) {
      nextNodeId = 1;
      selectedNodeId = null;
      rootNodeId = null;
      init(); // åˆæœŸåŒ–
    } else {
      // é¸æŠãƒãƒ¼ãƒ‰ãŒãªããªã£ãŸå ´åˆã®å†è¨­å®š
      if (selectedNodeId === null && nodes.length > 0) {
        const newRoot = nodes.find(n => n.parentId === null);
        selectedNodeId = newRoot ? newRoot.id : nodes[0].id;
        rootNodeId = newRoot ? newRoot.id : null;
      }
      render(); // å†æç”»
      container.focus();
    }
  }

  /**
   * æŒ‡å®šã—ãŸãƒãƒ¼ãƒ‰ã®æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹
   * @param {number} nodeId ãƒˆã‚°ãƒ«ã™ã‚‹ãƒãƒ¼ãƒ‰ã®ID
   */
  function toggleNodeCollapse(nodeId) {
    const node = getNodeById(nodeId);
    if (node) {
      node.isCollapsed = !node.isCollapsed; // çŠ¶æ…‹ã‚’åè»¢
      const descendantIds = getDescendantIds(nodeId);
      // é–‰ã˜ãŸæ™‚ã«é¸æŠä¸­ã®ãƒãƒ¼ãƒ‰ãŒéè¡¨ç¤ºã«ãªã‚‹å ´åˆã€è¦ªã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      if (node.isCollapsed && descendantIds.includes(selectedNodeId)) {
        selectedNodeId = nodeId;
      }
      render(); // å†æç”»
      container.focus();
    }
  }

  /**
   * å…¨ã¦ã®ãƒãƒ¼ãƒ‰ã‚’å±•é–‹ã™ã‚‹
   */
  function handleExpandAll() {
    nodes.forEach(node => node.isCollapsed = false);
    render();
    container.focus();
  }

  /**
   * å…¨ã¦ã®ãƒãƒ¼ãƒ‰ã‚’æŠ˜ã‚ŠãŸãŸã‚€ï¼ˆãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ã®ã¿è¡¨ç¤ºï¼‰
   */
  function handleCollapseAll() {
    if (!rootNodeId) return;
    nodes.forEach(node => {
      node.isCollapsed = true; // ãƒ«ãƒ¼ãƒˆã‚‚å«ã‚ä¸€æ—¦å…¨ã¦é–‰ã˜ã‚‹
    });
    selectedNodeId = rootNodeId; // ãƒ«ãƒ¼ãƒˆã‚’é¸æŠ
    render(); // å†æç”»ï¼ˆrenderé–¢æ•°å†…ã§ãƒ«ãƒ¼ãƒˆã¯è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
    container.focus();
  }

  // --- ç·¨é›†é–¢é€£ ---

  /**
   * é¸æŠä¸­ã®ãƒãƒ¼ãƒ‰ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹ (F2ã‚­ãƒ¼)
   */
  function startEditingSelectedNode() {
    if (selectedNodeId !== null && !isEditing) {
      startEditingNode(selectedNodeId);
    }
  }

  /**
   * ãƒãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç† (é¸æŠçŠ¶æ…‹ã®å¤‰æ›´)
   */
  function handleNodeClick(event) {
    // ãƒ‘ãƒ³æ“ä½œä¸­ã‚„ã€ãƒœã‚¿ãƒ³ãƒ»å…¥åŠ›æ¬„ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯ä½•ã‚‚ã—ãªã„
    if (isPanning || event.target.closest('.delete-button, .toggle-button, .edit-input')) {
      return;
    }
    const targetNodeEl = event.target.closest('.node');
    if (targetNodeEl) {
      const nodeId = parseInt(targetNodeEl.dataset.id, 10);
      // ç·¨é›†ä¸­ã«åˆ¥ã®ãƒãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ã€ç·¨é›†ã‚’å®Œäº†ã•ã›ã‚‹
      if (isEditing && selectedNodeId !== nodeId) {
        finishEditing(true); // å¤‰æ›´ã‚’ä¿å­˜ã—ã¦çµ‚äº†
      }
      selectedNodeId = nodeId; // ã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒãƒ¼ãƒ‰ã‚’é¸æŠ
      render(); // å†æç”»
      container.focus();
    }
  }

  /**
   * ãƒãƒ¼ãƒ‰ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç† (ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹)
   */
  function handleNodeDblClick(event) {
    // ãƒ‘ãƒ³æ“ä½œä¸­ã‚„ã€ãƒœã‚¿ãƒ³ãƒ»å…¥åŠ›æ¬„ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯ä½•ã‚‚ã—ãªã„
    if (isPanning || event.target.closest('.edit-input, .delete-button, .toggle-button')) {
      return;
    }
    const targetNodeEl = event.target.closest('.node');
    if (targetNodeEl) {
      const nodeId = parseInt(targetNodeEl.dataset.id, 10);
      // ç·¨é›†ä¸­ã«åˆ¥ã®ãƒãƒ¼ãƒ‰ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ã€ç·¨é›†ã‚’å®Œäº†ã•ã›ã‚‹
      if (isEditing && selectedNodeId !== nodeId) {
        finishEditing(true);
      }
      selectedNodeId = nodeId; // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒãƒ¼ãƒ‰ã‚’é¸æŠ
      startEditingNode(nodeId); // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
    }
  }

  /**
   * æŒ‡å®šã—ãŸãƒãƒ¼ãƒ‰ã®ç·¨é›†ã‚’é–‹å§‹ã™ã‚‹
   * @param {number} nodeId ç·¨é›†ã™ã‚‹ãƒãƒ¼ãƒ‰ã®ID
   */
  function startEditingNode(nodeId) {
    isEditing = true; // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
    selectedNodeId = nodeId; // ç·¨é›†å¯¾è±¡ã‚’é¸æŠ
    render(); // å†æç”»ã—ã¦ç·¨é›†ç”¨textareaã‚’è¡¨ç¤º
    // console.log(`ãƒãƒ¼ãƒ‰ ${nodeId} ã®ç·¨é›†ã‚’é–‹å§‹`);
  }

  /**
   * ç·¨é›†ç”¨textareaã‹ã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸæ™‚ã®å‡¦ç†
   */
  function handleEditBlur(event) {
    // å°‘ã—é…å»¶ã•ã›ã¦ã€ä»–ã®è¦ç´ ã¸ã®ã‚¯ãƒªãƒƒã‚¯ç­‰ã«ã‚ˆã‚‹æ„å›³ã—ãªã„blurã‚’å›é¿
    setTimeout(() => {
      if (isEditing && event.target.classList.contains('edit-input')) {
        finishEditing(true); // å¤‰æ›´ã‚’ä¿å­˜ã—ã¦ç·¨é›†çµ‚äº†
      }
    }, 100);
  }

  /**
   * ç·¨é›†ç”¨textareaã§ã®ã‚­ãƒ¼å…¥åŠ›å‡¦ç†
   */
  function handleEditKeyDown(event) {
    if (!isEditing) return;
    const input = event.target;
    if (event.key === 'Enter' && !event.shiftKey) { // Enter (Shiftãªã—) ã§ç·¨é›†å®Œäº†
      event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ”¹è¡Œå‹•ä½œã‚’æŠ‘åˆ¶
      event.stopPropagation(); // è¦ªè¦ç´ ã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’é˜»æ­¢
      finishEditing(true); // å¤‰æ›´ã‚’ä¿å­˜
    } else if (event.key === 'Escape') { // Escã§ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      event.preventDefault();
      event.stopPropagation();
      finishEditing(false); // å¤‰æ›´ã‚’ç ´æ£„
    } else if (event.key === 'Tab') { // Tabã‚­ãƒ¼ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•ï¼‰ã‚’æŠ‘åˆ¶
      event.preventDefault();
    }
  }

  /**
   * ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†ã™ã‚‹
   * @param {boolean} saveChanges å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹ã‹ã©ã†ã‹
   */
  function finishEditing(saveChanges) {
    if (!isEditing) return;
    const editingInput = nodesContainer.querySelector('.edit-input');
    if (!editingInput) { // ç¨€ã«èµ·ã“ã‚‹ã‹ã‚‚ã—ã‚Œãªã„å…¥åŠ›æ¬„æ¶ˆå¤±ã‚±ãƒ¼ã‚¹
      isEditing = false;
      return;
    }
    const nodeId = parseInt(editingInput.dataset.editingId, 10);
    const node = getNodeById(nodeId);
    if (node && saveChanges) { // å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹å ´åˆ
      const newText = editingInput.value;
      if (node.text !== newText) { // ãƒ†ã‚­ã‚¹ãƒˆãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚Œã°æ›´æ–°
        node.text = newText;
      }
    }
    isEditing = false; // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°è§£é™¤
    selectedNodeId = nodeId; // ç·¨é›†ã—ã¦ã„ãŸãƒãƒ¼ãƒ‰ã‚’é¸æŠçŠ¶æ…‹ã«
    render(); // å†æç”»
    container.focus(); // ã‚³ãƒ³ãƒ†ãƒŠã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
  }

  // --- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— / ãƒ‘ãƒ³é–¢é€£ ---

  /**
   * ãƒãƒ¼ãƒ‰è¦ç´ ä¸Šã§ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç† (ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹)
   */
  function handleNodeMouseDown(event) {
    // ãƒ‘ãƒ³æ“ä½œä¸­ã€ç·¨é›†ä¸­ã€å·¦ãƒœã‚¿ãƒ³ä»¥å¤–ã€ãƒœã‚¿ãƒ³é¡ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯ç„¡è¦–
    if (isPanning || isEditing || event.button !== 0 || event.target.closest('.delete-button, .toggle-button, .edit-input')) {
      return;
    }
    const targetNodeEl = event.target.closest('.node');
    if (!targetNodeEl) return;

    const nodeId = parseInt(targetNodeEl.dataset.id, 10);
    // ã‚¯ãƒªãƒƒã‚¯ã—ãŸãƒãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ãªã‹ã£ãŸå ´åˆã€ã¾ãšé¸æŠçŠ¶æ…‹ã«ã—ã¦ã‹ã‚‰ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
    if (selectedNodeId !== nodeId) {
      selectedNodeId = nodeId;
      render(); // é¸æŠçŠ¶æ…‹ã‚’åæ˜ ã•ã›ã‚‹ãŸã‚ã«å†æç”»
      const currentTargetEl = nodesContainer.querySelector(`.node[data-id='${nodeId}']`); // å†æç”»å¾Œã®è¦ç´ ã‚’å–å¾—
      if (!currentTargetEl) return; // è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ä¸­æ–­
      startDragging(event, nodeId, currentTargetEl);
    } else {
      // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒ‰ã§ã‚ã‚Œã°ã€ãã®ã¾ã¾ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
      startDragging(event, nodeId, targetNodeEl);
    }
  }

  /**
   * ãƒãƒ¼ãƒ‰ã®ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç†ã‚’é–‹å§‹ã™ã‚‹
   * @param {MouseEvent} event mousedownã‚¤ãƒ™ãƒ³ãƒˆ
   * @param {number} nodeId ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ãƒãƒ¼ãƒ‰ID
   * @param {HTMLElement} nodeEl ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ãƒãƒ¼ãƒ‰è¦ç´ 
   */
  function startDragging(event, nodeId, nodeEl) {
    if (isPanning) return; // ãƒ‘ãƒ³æ“ä½œä¸­ã¯ãƒ‰ãƒ©ãƒƒã‚°ã—ãªã„
    const nodeRect = nodeEl.getBoundingClientRect(); // ãƒãƒ¼ãƒ‰ã®ç”»é¢ä¸Šã§ã®ä½ç½®ã¨ã‚µã‚¤ã‚º
    const canvasRect = canvas.getBoundingClientRect(); // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ç”»é¢ä¸Šã§ã®ä½ç½®ã¨ã‚µã‚¤ã‚º
    // ãƒ‰ãƒ©ãƒƒã‚°ã«å¿…è¦ãªæƒ…å ±ã‚’ä¿æŒ
    draggingNode = {
      id: nodeId,
      element: nodeEl,
      offsetX: event.clientX - nodeRect.left, // ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³ä½ç½®ã®ãƒãƒ¼ãƒ‰å†…ã‚ªãƒ•ã‚»ãƒƒãƒˆX
      offsetY: event.clientY - nodeRect.top, // ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³ä½ç½®ã®ãƒãƒ¼ãƒ‰å†…ã‚ªãƒ•ã‚»ãƒƒãƒˆY
      // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®åº§æ¨™è¨ˆç®—ç”¨ã«ã€ã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨å‰ã®ã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ç³»ã§ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚‚è¨ˆç®—
      initialOffsetX: (event.clientX - canvasRect.left) / currentScale - nodeEl.offsetLeft,
      initialOffsetY: (event.clientY - canvasRect.top) / currentScale - nodeEl.offsetTop,
    };
    nodeEl.style.zIndex = 10; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯æœ€å‰é¢ã«
    nodeEl.classList.add('dragging'); // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
  }

  /**
   * ã‚³ãƒ³ãƒ†ãƒŠä¸Šã§ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸæ™‚ã®å‡¦ç† (ãƒ‘ãƒ³é–‹å§‹)
   */
  function handlePanStart(event) {
    // å·¦ãƒœã‚¿ãƒ³ä»¥å¤–ã€ç·¨é›†ä¸­ã€ãƒãƒ¼ãƒ‰ã‚„UIè¦ç´ ä¸Šã§ã®ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
    if (event.button !== 0 || isEditing || event.target.closest('.node, button, input, textarea, .delete-button, .toggle-button')) {
      return;
    }
    isPanning = true; // ãƒ‘ãƒ³ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
    panStartX = event.clientX; // ãƒ‘ãƒ³é–‹å§‹åº§æ¨™è¨˜éŒ²
    panStartY = event.clientY;
    panInitialScrollLeft = container.scrollLeft; // ãƒ‘ãƒ³é–‹å§‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®è¨˜éŒ²
    panInitialScrollTop = container.scrollTop;
    container.classList.add('panning'); // ãƒ‘ãƒ³ä¸­ã‚«ãƒ¼ã‚½ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
  }

  /**
   * ãƒã‚¦ã‚¹ç§»å‹•æ™‚ã®å‡¦ç† (ãƒ‘ãƒ³ or ãƒ‰ãƒ©ãƒƒã‚°)
   */
  function handlePanOrDragMove(event) {
    if (isPanning) {
      handlePanMove(event); // ãƒ‘ãƒ³å‡¦ç†
    } else if (draggingNode) {
      handleNodeDragMove(event); // ãƒ‰ãƒ©ãƒƒã‚°å‡¦ç†
    }
  }

  /**
   * ãƒ‘ãƒ³ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ç§»å‹•ï¼‰ä¸­ã®ãƒã‚¦ã‚¹ç§»å‹•å‡¦ç†
   */
  function handlePanMove(event) {
    if (!isPanning) return;
    event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‰ãƒ©ãƒƒã‚°å‹•ä½œï¼ˆãƒ†ã‚­ã‚¹ãƒˆé¸æŠãªã©ï¼‰ã‚’æŠ‘åˆ¶
    const dx = event.clientX - panStartX; // ç§»å‹•é‡X
    const dy = event.clientY - panStartY; // ç§»å‹•é‡Y
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’æ›´æ–°
    container.scrollLeft = panInitialScrollLeft - dx;
    container.scrollTop = panInitialScrollTop - dy;
  }

  /**
   * ãƒãƒ¼ãƒ‰ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ãƒã‚¦ã‚¹ç§»å‹•å‡¦ç†
   * @param {MouseEvent} event - mousemoveã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function handleNodeDragMove(event) {
    if (!draggingNode) return;
    event.preventDefault();

    const draggedNodeId = draggingNode.id;
    const draggedNodeElement = draggingNode.element;

    // --- ãƒãƒ¼ãƒ‰ä½ç½®ã®æ›´æ–° ---
    const canvasRect = canvas.getBoundingClientRect();
    const mouseXInCanvas = (event.clientX - canvasRect.left) / currentScale; // ã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨å‰ã®Xåº§æ¨™
    const mouseYInCanvas = (event.clientY - canvasRect.top) / currentScale; // ã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨å‰ã®Yåº§æ¨™
    // æ–°ã—ã„å·¦ä¸Šåº§æ¨™ã‚’è¨ˆç®—
    let newX = mouseXInCanvas - draggingNode.initialOffsetX;
    let newY = mouseYInCanvas - draggingNode.initialOffsetY;
    // ã‚­ãƒ£ãƒ³ãƒã‚¹å¢ƒç•Œå†…ã¸ã®åˆ¶é™
    const nodeWidth = draggedNodeElement.offsetWidth;
    const nodeHeight = draggedNodeElement.offsetHeight;
    const canvasWidth = canvas.offsetWidth;
    const canvasHeight = canvas.offsetHeight;
    newX = Math.max(0, Math.min(newX, canvasWidth - nodeWidth));
    newY = Math.max(0, Math.min(newY, canvasHeight - nodeHeight));
    // ãƒãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã¨DOMè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
    const node = getNodeById(draggedNodeId);
    if (node) { node.x = newX; node.y = newY; }
    draggedNodeElement.style.left = `${newX}px`;
    draggedNodeElement.style.top = `${newY}px`;
    updateConnectedLinesForNode(draggedNodeId); // æ¥ç¶šç·šã®æ›´æ–°

    // --- ãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç† ---
    let potentialTargetId = null;
    // ãƒã‚¦ã‚¹ç›´ä¸‹ã®è¦ç´ ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã€ä¸€æ™‚çš„ã«ãƒ‰ãƒ©ãƒƒã‚°ä¸­ãƒãƒ¼ãƒ‰ã®ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–
    draggedNodeElement.style.pointerEvents = 'none';
    const elementUnderMouse = document.elementFromPoint(event.clientX, event.clientY);
    draggedNodeElement.style.pointerEvents = 'auto'; // å…ƒã«æˆ»ã™

    if (elementUnderMouse) {
      const potentialTargetElement = elementUnderMouse.closest('.node'); // ãƒã‚¦ã‚¹ç›´ä¸‹ã®ãƒãƒ¼ãƒ‰è¦ç´ ã‚’æ¢ã™
      // è‡ªåˆ†è‡ªèº«ä»¥å¤–ã®ãƒãƒ¼ãƒ‰ã‹ï¼Ÿ
      if (potentialTargetElement && potentialTargetElement.dataset.id !== String(draggedNodeId)) {
        const targetId = parseInt(potentialTargetElement.dataset.id, 10);
        const draggedNodeData = getNodeById(draggedNodeId);
        const targetNodeData = getNodeById(targetId);
        // ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯ (ç¾åœ¨ã®è¦ªã¨åŒã˜ã§ãªã„ã€ãƒ«ãƒ¼ãƒˆã§ãªã„ã€è‡ªåˆ†ã‚„å­å­«ã§ãªã„)
        if (
          draggedNodeData && targetNodeData &&
          draggedNodeData.parentId !== targetId &&
          draggedNodeData.parentId !== null &&
          !getDescendantIds(draggedNodeId).includes(targetId)
        ) {
          potentialTargetId = targetId; // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå€™è£œã¨ã™ã‚‹
        }
      }
    }

    // --- ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã®æ›´æ–° ---
    if (potentialTargetId !== null && potentialTargetId !== highlightedDropTargetId) {
      // æ–°ã—ã„ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      removeHighlightFromTarget(); // æ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤
      addHighlightToTarget(potentialTargetId); // æ–°è¦ãƒã‚¤ãƒ©ã‚¤ãƒˆè¿½åŠ 
    } else if (potentialTargetId === null && highlightedDropTargetId !== null) {
      // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå€™è£œãŒãªããªã£ãŸå ´åˆã€ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤
      removeHighlightFromTarget();
    }
  }

  /**
   * æŒ‡å®šã•ã‚ŒãŸIDã®ãƒãƒ¼ãƒ‰ã«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç”¨ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è¿½åŠ ã™ã‚‹
   * @param {number} targetId ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ãƒãƒ¼ãƒ‰ID
   */
  function addHighlightToTarget(targetId) {
    const targetElement = nodesContainer.querySelector(`.node[data-id='${targetId}']`);
    if (targetElement) {
      targetElement.classList.add('drop-target-highlight');
      highlightedDropTargetId = targetId; // ãƒã‚¤ãƒ©ã‚¤ãƒˆä¸­ã®IDã‚’è¨˜éŒ²
    }
  }

  /**
   * ç¾åœ¨ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒ‰ã‹ã‚‰ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è§£é™¤ã™ã‚‹
   */
  function removeHighlightFromTarget() {
    if (highlightedDropTargetId !== null) {
      const highlightedElement = nodesContainer.querySelector(`.node[data-id='${highlightedDropTargetId}']`);
      if (highlightedElement) {
        highlightedElement.classList.remove('drop-target-highlight');
      }
      highlightedDropTargetId = null; // ãƒã‚¤ãƒ©ã‚¤ãƒˆä¸­ã®IDã‚’ã‚¯ãƒªã‚¢
    }
  }

  /**
   * ãƒã‚¦ã‚¹ãƒœã‚¿ãƒ³ãŒé›¢ã•ã‚ŒãŸæ™‚ã®å‡¦ç† (ãƒ‘ãƒ³ or ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†)
   */
  function handlePanOrDragEnd(event) {
    if (isPanning) {
      handlePanEnd(event); // ãƒ‘ãƒ³çµ‚äº†
    } else if (draggingNode) {
      handleNodeDragEnd(event); // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
    }
  }

  /**
   * ãƒ‘ãƒ³ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ç§»å‹•ï¼‰æ“ä½œã‚’çµ‚äº†ã™ã‚‹
   */
  function handlePanEnd(event) {
    if (isPanning) {
      isPanning = false; // ãƒ‘ãƒ³ãƒ¢ãƒ¼ãƒ‰è§£é™¤
      container.classList.remove('panning'); // ã‚«ãƒ¼ã‚½ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æˆ»ã™
    }
  }

  /**
   * ãƒãƒ¼ãƒ‰ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã®çµ‚äº†å‡¦ç†
   * @param {MouseEvent} event - mouseupã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   */
  function handleNodeDragEnd(event) {
    if (draggingNode) {
      const draggedNodeId = draggingNode.id;
      const draggedNodeElement = draggingNode.element;

      removeHighlightFromTarget(); // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆè§£é™¤

      // --- ãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ç‰¹å®š ---
      draggedNodeElement.style.pointerEvents = 'none'; // å†åº¦ãƒã‚¦ã‚¹ç›´ä¸‹ã‚’å–å¾—
      const elementUnderMouse = document.elementFromPoint(event.clientX, event.clientY);
      draggedNodeElement.style.pointerEvents = 'auto';

      let targetNodeElement = null;
      if (elementUnderMouse) {
        targetNodeElement = elementUnderMouse.closest('.node');
      }

      // --- è¦ªå­é–¢ä¿‚å¤‰æ›´ã¨ä½ç½®å†è¨ˆç®— ---
      let parentChanged = false;
      // æœ‰åŠ¹ãªãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä¸Šã§ãƒã‚¦ã‚¹ãŒé›¢ã•ã‚ŒãŸã‹ï¼Ÿ
      if (targetNodeElement && targetNodeElement.dataset.id !== String(draggedNodeId)) {
        const targetNodeId = parseInt(targetNodeElement.dataset.id, 10);
        const draggedNode = getNodeById(draggedNodeId);
        const targetNode = getNodeById(targetNodeId);

        // ãƒ‰ãƒ­ãƒƒãƒ—å¯èƒ½æ¡ä»¶ã‚’å†ç¢ºèª
        if (
          draggedNode && targetNode &&
          draggedNode.parentId !== targetNodeId &&
          draggedNode.parentId !== null &&
          !getDescendantIds(draggedNodeId).includes(targetNodeId)
        ) {
          // è¦ªå­é–¢ä¿‚ã‚’å¤‰æ›´
          draggedNode.parentId = targetNodeId;
          parentChanged = true;

          // æ–°ã—ã„è¦ªã«åˆã‚ã›ã¦ä½ç½®ã‚’èª¿æ•´
          const targetNodeWidth = targetNodeElement.offsetWidth;
          const draggedNodeWidth = draggedNodeElement.offsetWidth;
          const draggedNodeHeight = draggedNodeElement.offsetHeight;
          const canvasWidth = canvas.offsetWidth;
          const canvasHeight = canvas.offsetHeight;
          const spacingX = 80; // è¦ªã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆX
          const spacingY = 0;  // è¦ªã‹ã‚‰ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆY (ã“ã“ã§ã¯åŒã˜é«˜ã•)
          let newDropX = targetNode.x + targetNodeWidth + spacingX;
          let newDropY = targetNode.y + spacingY;
          // ã‚­ãƒ£ãƒ³ãƒã‚¹å¢ƒç•Œå†…ã«åã‚ã‚‹
          newDropX = Math.max(0, Math.min(newDropX, canvasWidth - draggedNodeWidth));
          newDropY = Math.max(0, Math.min(newDropY, canvasHeight - draggedNodeHeight));
          // ãƒãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®åº§æ¨™ã‚’æ›´æ–°
          draggedNode.x = newDropX;
          draggedNode.y = newDropY;

          // ãƒ‰ãƒ­ãƒƒãƒ—å…ˆã®è¦ªãŒæŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã„ãŸã‚‰å±•é–‹
          if (targetNode.isCollapsed) {
            targetNode.isCollapsed = false;
          }
        }
      }

      // ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã‚’è§£é™¤
      draggingNode = null;
      draggedNodeElement.style.zIndex = 2; // z-indexã‚’å…ƒã«æˆ»ã™
      draggedNodeElement.classList.remove('dragging'); // ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ã‚¿ã‚¤ãƒ«è§£é™¤

      // å†æç”» (è¦ªå­é–¢ä¿‚ãŒå¤‰ã‚ã£ãŸå ´åˆã¯ä½ç½®èª¿æ•´ã‚‚åæ˜ ã•ã‚Œã‚‹)
      render();

      container.focus();
    }
  }

  /**
   * ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã«ã€æŒ‡å®šã•ã‚ŒãŸãƒãƒ¼ãƒ‰ã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹ç·šã®ä½ç½®ã‚’æ›´æ–°ã™ã‚‹
   * (renderé–¢æ•°ãŒå‘¼ã°ã‚Œã‚‹ã¾ã§ã®æš«å®šçš„ãªç·šã®å†æç”»)
   * @param {number} nodeId - ç§»å‹•ã—ãŸãƒãƒ¼ãƒ‰ã®ID
   */
   function updateConnectedLinesForNode(nodeId) {
    // å¯¾è±¡ãƒãƒ¼ãƒ‰ã«é–¢é€£ã™ã‚‹æ—¢å­˜ã®ç·šã‚’å‰Šé™¤
    svg.querySelectorAll(`path[data-from-node-id='${nodeId}'], path[data-to-node-id='${nodeId}']`).forEach(path => path.remove());
    const node = getNodeById(nodeId);
    const nodeEl = nodesContainer.querySelector(`.node[data-id='${nodeId}']`);
    if (!node || !nodeEl) return; // ãƒãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ or è¦ç´ ãŒãªã‘ã‚Œã°çµ‚äº†

    // æç”»ã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ãƒãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‚’å–å¾—
    const potentialVisibleNodes = getVisibleNodes();
    const isNodePotentiallyVisible = potentialVisibleNodes.some(vn => vn.id === nodeId) || (draggingNode && draggingNode.id === nodeId);

    if (!isNodePotentiallyVisible) return; // è¡¨ç¤ºå¯èƒ½æ€§ãŒãªã‘ã‚Œã°ç·šã¯æç”»ã—ãªã„

    // è¦ªãƒãƒ¼ãƒ‰ã¸ã®ç·š
    if (node.parentId !== null) {
        const parentNode = getNodeById(node.parentId);
        const parentEl = nodesContainer.querySelector(`.node[data-id='${node.parentId}']`);
        // è¦ªãŒè¡¨ç¤ºå¯èƒ½æ€§ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã€å±•é–‹ã•ã‚Œã¦ãŠã‚Šã€DOMè¦ç´ ã‚‚å­˜åœ¨ã™ã‚‹ã‹ï¼Ÿ
        const isParentPotentiallyVisibleAndExpanded = parentNode && potentialVisibleNodes.some(vn => vn.id === parentNode.id) && !parentNode.isCollapsed && parentEl;
        if (isParentPotentiallyVisibleAndExpanded) {
            const colorInfo = getNodeColorInfo(node.id);
            const path = drawCurvedLine(parentEl, nodeEl);
            if (path) {
                path.setAttribute('data-from-node-id', parentNode.id);
                path.setAttribute('data-to-node-id', node.id);
                path.style.stroke = colorInfo.line;
                svg.appendChild(path);
            }
        }
    }

    // å­ãƒãƒ¼ãƒ‰ã¸ã®ç·š
    if (!node.isCollapsed) { // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ãƒãƒ¼ãƒ‰ãŒå±•é–‹ã•ã‚Œã¦ã„ã‚‹å ´åˆ
        const children = nodes.filter(n => n.parentId === nodeId);
        children.forEach(child => {
            const childEl = nodesContainer.querySelector(`.node[data-id='${child.id}']`);
            // å­ãŒè¡¨ç¤ºå¯èƒ½æ€§ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã€DOMè¦ç´ ã‚‚å­˜åœ¨ã™ã‚‹ã‹ï¼Ÿ
            const isChildPotentiallyVisible = childEl && potentialVisibleNodes.some(vn => vn.id === child.id);
            if (isChildPotentiallyVisible) {
                const colorInfo = getNodeColorInfo(child.id);
                const path = drawCurvedLine(nodeEl, childEl);
                if (path) {
                    path.setAttribute('data-from-node-id', node.id);
                    path.setAttribute('data-to-node-id', child.id);
                    path.style.stroke = colorInfo.line;
                    svg.appendChild(path);
                }
            }
        });
    }
}

  // --- JSON ä¿å­˜/èª­è¾¼ ---

  /**
   * ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã™ã‚‹
   */
  function handleSaveJson() {
    if (nodes.length === 0) {
      alert("ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
      return;
    }
    // ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
    const dataToSave = {
      nodes: nodes,
      nextNodeId: nextNodeId // æ¬¡ã®IDã‚‚ä¿å­˜
    };
    const jsonString = JSON.stringify(dataToSave, null, 2); // æ•´å½¢ã—ã¦JSONæ–‡å­—åˆ—åŒ–
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    // ãƒ•ã‚¡ã‚¤ãƒ«åã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å«ã‚ã‚‹
    const timestamp = new Date().toISOString().replace(/[:.-]/g, '').slice(0, 15);
    a.download = `mindmap_${timestamp}.json`;
    document.body.appendChild(a);
    a.click(); // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯
    document.body.removeChild(a); // è¦ç´ ã‚’å‰Šé™¤
    URL.revokeObjectURL(url); // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆURLã‚’è§£æ”¾
  }

  /**
   * JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦èª­ã¿è¾¼ã‚€å‡¦ç†
   */
  function handleLoadJsonFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const loadedData = JSON.parse(e.target.result);
        // èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ãŒæœŸå¾…ã™ã‚‹å½¢å¼ã‹ãƒã‚§ãƒƒã‚¯
        if (loadedData && Array.isArray(loadedData.nodes) && typeof loadedData.nextNodeId === 'number') {
          nodes = loadedData.nodes;
          // äº’æ›æ€§ã®ãŸã‚ isCollapsed ãŒãªã„å ´åˆã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤falseã‚’è¨­å®š
          nodes.forEach(node => {
            if (node.isCollapsed === undefined) node.isCollapsed = false;
          });
          nextNodeId = loadedData.nextNodeId;
          // ãƒ«ãƒ¼ãƒˆãƒãƒ¼ãƒ‰ã¨é¸æŠçŠ¶æ…‹ã‚’å†è¨­å®š
          const root = nodes.find(n => n.parentId === null);
          rootNodeId = root ? root.id : null;
          selectedNodeId = rootNodeId || (nodes.length > 0 ? nodes[0].id : null);
          render(); // å†æç”»
          // å…¨ä½“è¡¨ç¤ºã«èª¿æ•´
          if (rootNodeId || nodes.length > 0) {
            handleFitToScreen();
          } else {
            // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã ã£ãŸå ´åˆã®åˆæœŸåŒ–
            updateScale(1.0, false);
            container.scrollLeft=0; container.scrollTop=0;
            container.focus();
          }
          alert('ãƒã‚¤ãƒ³ãƒ‰ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚');
        } else {
          alert('ç„¡åŠ¹ãªJSONãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚\næœŸå¾…ã•ã‚Œã‚‹å½¢å¼: { "nodes": [...], "nextNodeId": ... }');
        }
      } catch (error) {
        console.error('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        alert('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      } finally {
        loadJsonInput.value = ''; // inputè¦ç´ ã‚’ãƒªã‚»ãƒƒãƒˆ
      }
    };
    reader.onerror = () => {
      alert('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
      loadJsonInput.value = '';
    };
    reader.readAsText(file); // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã¿
  }

  // --- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ ---

  /**
   * ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªã‚­ãƒ¼ãƒ€ã‚¦ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
   */
  function handleKeyDown(event) {
    const activeElement = document.activeElement;
    const isCtrlOrMeta = event.ctrlKey || event.metaKey; // Ctrl or Cmd

    // ç·¨é›†ä¸­ã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆç„¡åŠ¹ (textareaå†…ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯åˆ¥ã§å‡¦ç†)
    if (isEditing) { return; }
    // ã‚ºãƒ¼ãƒ å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã€ä¸€éƒ¨ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚’é™¤ãç„¡åŠ¹
    if (activeElement === zoomInput && !isCtrlOrMeta) { return; }

    // Ctrl/Cmdã‚­ãƒ¼ã¨ã®çµ„ã¿åˆã‚ã›ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    if (isCtrlOrMeta) {
      switch (event.key.toLowerCase()) {
        case 's': event.preventDefault(); handleSaveJson(); return; // ä¿å­˜
        case 'o': event.preventDefault(); loadJsonBtn.click(); return; // èª­è¾¼
        case '+': case '=': event.preventDefault(); handleZoomIn(); return; // ã‚ºãƒ¼ãƒ ã‚¤ãƒ³
        case '-': event.preventDefault(); handleZoomOut(); return; // ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ
        case '0': event.preventDefault(); handleFitToScreen(); return; // å…¨ä½“è¡¨ç¤º
      }
    }

    // ã‚³ãƒ³ãƒ†ãƒŠã‹bodyã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    if (activeElement !== container && activeElement !== document.body) {
      return;
    }
    switch (event.key) {
      case 'Tab':       event.preventDefault(); addChildNode(); break; // å­ã‚’è¿½åŠ 
      case 'Enter':     event.preventDefault(); addSiblingNode(); break; // å…„å¼Ÿã‚’è¿½åŠ 
      case 'Delete':
      case 'Backspace': event.preventDefault(); deleteSelectedNode(); break; // å‰Šé™¤
      case 'F2':        event.preventDefault(); startEditingSelectedNode(); break; // ç·¨é›†é–‹å§‹
    }
  }

  // --- ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆæ“ä½œ ---

  /**
   * æŒ‡å®šã—ãŸãƒãƒ¼ãƒ‰ãŒç”»é¢ä¸­å¤®ã«æ¥ã‚‹ã‚ˆã†ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹
   * @param {number} nodeId ä¸­å¤®ã«è¡¨ç¤ºã™ã‚‹ãƒãƒ¼ãƒ‰ID
   * @param {boolean} [smooth=true] ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã‹
   */
  function centerViewOnNode(nodeId, smooth = true) {
    const node = getNodeById(nodeId);
    const nodeEl = nodesContainer.querySelector(`.node[data-id='${nodeId}']`);
    if (node && nodeEl) {
      const containerRect = container.getBoundingClientRect();
      const containerWidth = container.clientWidth;
      const containerHeight = container.clientHeight;
      // ãƒãƒ¼ãƒ‰ã®ä¸­å¿ƒåº§æ¨™ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨å¾Œï¼‰
      const nodeCenterX = node.x + nodeEl.offsetWidth / 2;
      const nodeCenterY = node.y + nodeEl.offsetHeight / 2;
      // ç›®æ¨™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ï¼ˆãƒãƒ¼ãƒ‰ä¸­å¿ƒãŒãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆä¸­å¿ƒã«æ¥ã‚‹ã‚ˆã†ã«ï¼‰
      const targetScrollLeft = nodeCenterX * currentScale - containerWidth / 2;
      const targetScrollTop = nodeCenterY * currentScale - containerHeight / 2;
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å®Ÿè¡Œ
      container.scrollTo({
        left: Math.max(0, targetScrollLeft), // ãƒã‚¤ãƒŠã‚¹ã«ãªã‚‰ãªã„ã‚ˆã†ã«
        top: Math.max(0, targetScrollTop),
        behavior: smooth ? 'smooth' : 'auto' // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æŒ™å‹•
      });
      container.focus(); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¨­å®š
    } else {
      container.focus();
    }
  }

  /**
   * ã‚ºãƒ¼ãƒ ã‚¤ãƒ³å‡¦ç†
   */
  function handleZoomIn() {
    const newScale = Math.min(maxScale, currentScale + scaleStep);
    updateScale(newScale, true); // ç”»é¢ä¸­å¤®åŸºæº–ã§ã‚ºãƒ¼ãƒ 
  }

  /**
   * ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†
   */
  function handleZoomOut() {
    const newScale = Math.max(minScale, currentScale - scaleStep);
    updateScale(newScale, true); // ç”»é¢ä¸­å¤®åŸºæº–ã§ã‚ºãƒ¼ãƒ 
  }

  /**
   * ã‚ºãƒ¼ãƒ å…¥åŠ›æ¬„ã®å€¤å¤‰æ›´æ™‚ã®å‡¦ç†
   */
  function handleZoomInputChange() {
    let newScalePercent = parseInt(zoomInput.value, 10);
    if (isNaN(newScalePercent)) { // ç„¡åŠ¹ãªå…¥åŠ›ãªã‚‰å…ƒã«æˆ»ã™
      zoomInput.value = Math.round(currentScale * 100);
      return;
    }
    // æœ€å°/æœ€å¤§å€¤å†…ã«åˆ¶é™
    newScalePercent = Math.max(minScale * 100, Math.min(maxScale * 100, newScalePercent));
    const newScale = newScalePercent / 100;
    updateScale(newScale, true); // ç”»é¢ä¸­å¤®åŸºæº–ã§ã‚ºãƒ¼ãƒ 
  }

  /**
   * ãƒã‚¦ã‚¹ãƒ›ã‚¤ãƒ¼ãƒ«ã«ã‚ˆã‚‹ã‚ºãƒ¼ãƒ å‡¦ç† (Ctrl/Cmdã‚­ãƒ¼æŠ¼ä¸‹æ™‚)
   */
  function handleWheelZoom(event) {
    if (!event.ctrlKey && !event.metaKey) return; // Ctrl or Cmd ã‚­ãƒ¼ãŒæŠ¼ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ç„¡è¦–
    event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‹•ä½œã‚’æŠ‘åˆ¶

    const oldScale = currentScale;
    let newScale;
    if (event.deltaY < 0) { // ãƒ›ã‚¤ãƒ¼ãƒ«ä¸Šæ–¹å›è»¢ï¼ˆã‚ºãƒ¼ãƒ ã‚¤ãƒ³ï¼‰
      newScale = Math.min(maxScale, oldScale + scaleStep);
    } else { // ãƒ›ã‚¤ãƒ¼ãƒ«ä¸‹æ–¹å›è»¢ï¼ˆã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆï¼‰
      newScale = Math.max(minScale, oldScale - scaleStep);
    }

    if (Math.abs(oldScale - newScale) < 0.001) return; // ã‚¹ã‚±ãƒ¼ãƒ«ãŒå¤‰ã‚ã‚‰ãªã„å ´åˆã¯å‡¦ç†ä¸­æ–­

    // ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®åŸºæº–ã§ã‚ºãƒ¼ãƒ ã™ã‚‹ãŸã‚ã®è¨ˆç®—
    const mouseX = event.clientX;
    const mouseY = event.clientY;
    const containerRect = container.getBoundingClientRect();
    const containerX = containerRect.left;
    const containerY = containerRect.top;
    const mouseXInContainer = mouseX - containerX; // ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®ãƒã‚¦ã‚¹Xåº§æ¨™
    const mouseYInContainer = mouseY - containerY; // ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®ãƒã‚¦ã‚¹Yåº§æ¨™
    // ãƒã‚¦ã‚¹ä½ç½®ã«å¯¾å¿œã™ã‚‹ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®åº§æ¨™ï¼ˆã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨å‰ï¼‰
    const canvasX = (container.scrollLeft + mouseXInContainer) / oldScale;
    const canvasY = (container.scrollTop + mouseYInContainer) / oldScale;
    // æ–°ã—ã„ã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨å¾Œã®ç›®æ¨™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®
    const targetScrollLeft = canvasX * newScale - mouseXInContainer;
    const targetScrollTop = canvasY * newScale - mouseYInContainer;

    // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’æ›´æ–°ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®èª¿æ•´ã¯ã—ãªã„ï¼‰
    updateScale(newScale, false);
    // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’èª¿æ•´
    requestAnimationFrame(() => {
      container.scrollLeft = Math.max(0, targetScrollLeft);
      container.scrollTop = Math.max(0, targetScrollTop);
    });
  }

  /**
   * ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆã‚ºãƒ¼ãƒ å€ç‡ï¼‰ã‚’æ›´æ–°ã™ã‚‹
   * @param {number} newScale æ–°ã—ã„ã‚¹ã‚±ãƒ¼ãƒ«å€¤
   * @param {boolean} [adjustScroll=false] ç”»é¢ä¸­å¤®åŸºæº–ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’èª¿æ•´ã™ã‚‹ã‹
   */
  function updateScale(newScale, adjustScroll = false) {
    const oldScale = currentScale;
    newScale = Math.max(minScale, Math.min(maxScale, newScale)); // æœ€å°/æœ€å¤§å€¤å†…ã«åˆ¶é™

    if (Math.abs(oldScale - newScale) < 0.001) { // ã»ã¼å¤‰åŒ–ãªã„å ´åˆã¯å…¥åŠ›æ¬„ã ã‘æ›´æ–°
      zoomInput.value = Math.round(newScale * 100);
      return;
    }

    let targetScrollLeft = container.scrollLeft;
    let targetScrollTop = container.scrollTop;

    // ç”»é¢ä¸­å¤®åŸºæº–ã§ã‚ºãƒ¼ãƒ ã™ã‚‹å ´åˆã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®è¨ˆç®—
    if (adjustScroll && oldScale > 0) {
      const viewWidth = container.clientWidth;
      const viewHeight = container.clientHeight;
      // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆä¸­å¤®ã«å¯¾å¿œã™ã‚‹ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®åº§æ¨™
      const canvasXAtCenter = (container.scrollLeft + viewWidth / 2) / oldScale;
      const canvasYAtCenter = (container.scrollTop + viewHeight / 2) / oldScale;
      // æ–°ã—ã„ã‚¹ã‚±ãƒ¼ãƒ«ã§ã®ç›®æ¨™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®
      targetScrollLeft = canvasXAtCenter * newScale - viewWidth / 2;
      targetScrollTop = canvasYAtCenter * newScale - viewHeight / 2;
    }

    // requestAnimationFrame ã‚’ä½¿ã£ã¦ã‚¹ãƒ ãƒ¼ã‚ºãªæ›´æ–°
    requestAnimationFrame(() => {
      if (adjustScroll) { // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«èª¿æ•´ãŒå¿…è¦ãªå ´åˆ
        container.scrollLeft = Math.max(0, targetScrollLeft);
        container.scrollTop = Math.max(0, targetScrollTop);
      }
      currentScale = newScale; // ã‚¹ã‚±ãƒ¼ãƒ«æ›´æ–°
      canvas.style.transform = `scale(${currentScale})`; // CSSã§ã‚¹ã‚±ãƒ¼ãƒ«é©ç”¨
      zoomInput.value = Math.round(currentScale * 100); // å…¥åŠ›æ¬„æ›´æ–°
    });
  }

  /**
   * å…¨ã¦ã®è¡¨ç¤ºãƒãƒ¼ãƒ‰ãŒç”»é¢å†…ã«åã¾ã‚‹ã‚ˆã†ã«ã‚ºãƒ¼ãƒ ã¨ãƒ‘ãƒ³ã‚’èª¿æ•´ã™ã‚‹
   */
  function handleFitToScreen() {
    if (nodes.length === 0) { // ãƒãƒ¼ãƒ‰ãŒãªã„å ´åˆ
        updateScale(1.0, false);
        container.scrollLeft = 0; container.scrollTop = 0;
        container.focus();
        return;
    }

    // å®Ÿéš›ã«æç”»ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ãƒ‰ã®æƒ…å ±ã‚’å–å¾— (renderé–¢æ•°å†…ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†ç¾)
    const actualVisibleNodes = [];
    const actualVisibleNodeIds = new Set();
    const potentialVisibleNodes = getVisibleNodes();
    const rootNodes = potentialVisibleNodes.filter(n => n.parentId === null);
    rootNodes.forEach(root => {
        actualVisibleNodeIds.add(root.id);
        actualVisibleNodes.push(root);
    });
    potentialVisibleNodes.forEach(node => {
        if (node.parentId === null) return;
        const parentNode = getNodeById(node.parentId);
        if (parentNode && actualVisibleNodeIds.has(parentNode.id) && !parentNode.isCollapsed) {
            actualVisibleNodeIds.add(node.id);
            actualVisibleNodes.push(node);
        }
    });

     if (actualVisibleNodes.length === 0) { // æç”»å¯¾è±¡ãƒãƒ¼ãƒ‰ãŒãªã„å ´åˆ (ãƒ«ãƒ¼ãƒˆã®ã¿ã§æŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã„ã‚‹ãªã©)
        if (rootNodeId) { updateScale(1.0, false); centerViewOnNode(rootNodeId, false); }
        else { updateScale(1.0, false); container.scrollLeft = 0; container.scrollTop = 0; }
        container.focus();
        return;
    }

    // æç”»ãƒãƒ¼ãƒ‰ã®ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ï¼ˆå¤–æ¥çŸ©å½¢ï¼‰ã‚’è¨ˆç®—
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
    let nodeElementFound = false; // DOMè¦ç´ ãŒå®Ÿéš›ã«è¦‹ã¤ã‹ã£ãŸã‹ãƒ•ãƒ©ã‚°

     actualVisibleNodes.forEach(nodeData => {
        const nodeEl = nodesContainer.querySelector(`.node[data-id='${nodeData.id}']`);
        if (!nodeEl) return; // DOMè¦ç´ ãŒãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ— (æç”»ç›´å¾Œãªã©ã§ç¨€ã«ã‚ã‚‹ã‹ã‚‚)
        nodeElementFound = true;
        const nodeLeft = nodeData.x;
        const nodeTop = nodeData.y;
        const nodeRight = nodeData.x + nodeEl.offsetWidth;
        const nodeBottom = nodeData.y + nodeEl.offsetHeight;
        minX = Math.min(minX, nodeLeft); minY = Math.min(minY, nodeTop);
        maxX = Math.max(maxX, nodeRight); maxY = Math.max(maxY, nodeBottom);
    });

    if (!nodeElementFound) { // æç”»è¦ç´ ãŒä¸€ã¤ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆ
        if (rootNodeId) { updateScale(1.0, false); centerViewOnNode(rootNodeId, false); }
        else { updateScale(1.0, false); container.scrollLeft = 0; container.scrollTop = 0; }
         container.focus();
         return;
    }

    const contentWidth = maxX - minX;
    const contentHeight = maxY - minY;

    if (contentWidth <= 0 || contentHeight <= 0) { // å¹…ã‹é«˜ã•ãŒãªã„å ´åˆ (ãƒãƒ¼ãƒ‰ãŒ1ã¤ã ã‘ãªã©)
        if(actualVisibleNodes.length > 0) { centerViewOnNode(actualVisibleNodes[0].id, false); } // æœ€åˆã®ãƒãƒ¼ãƒ‰ã«ä¸­å¤®åˆã‚ã›
        else { updateScale(1.0, false); container.scrollLeft = 0; container.scrollTop = 0; }
        updateScale(1.0, false); // ã‚¹ã‚±ãƒ¼ãƒ«ã¯100%ã«
        container.focus();
         return;
    }

    // ã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚ºã¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã«åŸºã¥ã„ã¦æœ€é©ãªã‚¹ã‚±ãƒ¼ãƒ«ã‚’è¨ˆç®—
    const containerWidth = container.clientWidth;
    const containerHeight = container.clientHeight;
    const padding = 40; // å‘¨å›²ã®ä½™ç™½
    const scaleX = (containerWidth > padding * 2) ? (containerWidth - padding * 2) / contentWidth : minScale;
    const scaleY = (containerHeight > padding * 2) ? (containerHeight - padding * 2) / contentHeight : minScale;
    let optimalScale = Math.min(scaleX, scaleY);
    optimalScale = Math.max(minScale, Math.min(maxScale, optimalScale)); // æœ€å°/æœ€å¤§åˆ¶é™

    // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’é©ç”¨ (updateScaleã‚’ä½¿ã‚ãšç›´æ¥è¨­å®š)
    currentScale = optimalScale;
    canvas.style.transform = `scale(${currentScale})`;
    zoomInput.value = Math.round(currentScale * 100);

    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸­å¤®ãŒãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®ä¸­å¤®ã«æ¥ã‚‹ã‚ˆã†ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    const contentCenterX = minX + contentWidth / 2;
    const contentCenterY = minY + contentHeight / 2;
    const targetScrollLeft = contentCenterX * currentScale - containerWidth / 2;
    const targetScrollTop = contentCenterY * currentScale - containerHeight / 2;
    container.scrollTo({ left: Math.max(0, targetScrollLeft), top: Math.max(0, targetScrollTop), behavior: 'auto' });
    container.focus();
}

  // ========================================
  // === åˆæœŸåŒ–å®Ÿè¡Œ ===
  // ========================================
  document.addEventListener('DOMContentLoaded', init);

</script>

</body>
</html>
