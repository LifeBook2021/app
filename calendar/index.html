<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯</title>
    <!-- Favicon ã¯JavaScriptã§å‹•çš„ã«è¨­å®š -->
    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        body { font-family: sans-serif; margin: 15px; background-color: #f8f9fa; }
        .schedule-container { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 100%; }
        h1 { font-size: 1.5em; margin-bottom: 15px; }

        /* æ“ä½œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .controls { display: flex; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 8px; }
        .controls button, .controls select, .controls input[type="number"] { padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; cursor: pointer; transition: background-color 0.2s, border-color 0.2s, color 0.2s, opacity 0.2s; font-size: 0.9em; }
        .controls button:hover { background-color: #eee; }
        .controls button.primary { background-color: #007bff; color: white; border-color: #007bff; }
        .controls button.primary:hover { background-color: #0056b3; }
        .controls button.info { background-color: #17a2b8; color: white; border-color: #17a2b8; }
        .controls button.info:hover { background-color: #117a8b; }
        .controls button.success { background-color: #28a745; color: white; border-color: #28a745; }
        .controls button.success:hover { background-color: #218838; }
        .controls span#monthYear { font-size: 1.1em; font-weight: bold; margin: 0 8px; }
        .controls input[type="number"] { width: 60px; }

        /* ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œç³»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .file-controls { margin-left: auto; display: flex; align-items: center; gap: 8px; }
        #unsavedChanges { color: orange; font-weight: bold; margin-right: 10px; }
        #fileInput { display: none; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #scheduleTable { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; border: 1px solid #ccc; }
        #table-wrapper { max-height: 65vh; overflow-y: auto; border-bottom: 1px solid #ccc; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ (thead) */
        #scheduleTable thead th {
            background-color: #f2f2f2; font-weight: bold; position: sticky; top: 0; z-index: 2;
            vertical-align: middle; padding: 4px; border: 1px solid #ddd; font-size: 0.85em;
            line-height: 1.2; text-align: center;
        }
        #scheduleTable thead th:first-child { /* ãƒ¡ãƒ³ãƒãƒ¼åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ */
            width: 120px; background-color: #e9ecef; z-index: 3;
            text-align: left; padding-left: 10px; vertical-align: middle;
        }
        #scheduleTable thead th.date-header { font-size: 0.8em; }
        #scheduleTable thead th .day-number { display: block; font-size: 1.1em; line-height: 1; }
        #scheduleTable thead th .day-of-week { display: block; font-size: 0.9em; color: #555; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœãƒ‡ã‚£ (tbody) */
        #scheduleTable tbody th, #scheduleTable tbody td {
            border: 1px solid #ddd; padding: 0; text-align: center; white-space: normal;
            overflow: hidden; text-overflow: ellipsis; font-size: 0.85em;
            vertical-align: middle; cursor: default;
        }
        #scheduleTable tbody th { /* ãƒ¡ãƒ³ãƒãƒ¼åã‚»ãƒ« */
            background-color: #f8f9fa; font-weight: normal; text-align: left;
            z-index: 1; width: 120px; border-right: 1px solid #ccc;
            padding-left: 10px; display: flex; align-items: center;
        }
        #scheduleTable tbody th[contenteditable="true"] { cursor: text; background-color: #fff; }
        #scheduleTable tbody th[contenteditable="true"]:focus { outline: 2px solid #007bff; background-color: #eef; }
        #scheduleTable tbody td { /* æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ« */
            background-color: #fff; cursor: pointer; transition: background-color 0.1s ease-in-out;
        }

        /* æ›œæ—¥ãƒ»ç¥æ—¥ã«ã‚ˆã‚‹èƒŒæ™¯è‰² */
        .saturday { background-color: #e3f2fd !important; }
        .sunday { background-color: #ffebee !important; }
        .holiday { background-color: #fff3e0 !important; }
        #scheduleTable tbody tr td.saturday-cell { background-color: #f0f8ff; }
        #scheduleTable tbody tr td.sunday-cell { background-color: #fff7f7; }
        #scheduleTable tbody tr td.holiday-cell { background-color: #fffaf0; }

        /* ä»Šæ—¥ã®åˆ—ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
        #scheduleTable th.today-column, #scheduleTable td.today-column {
             border-left: 2px solid red !important; border-right: 2px solid red !important;
             background-color: #fffde7 !important;
        }
        #scheduleTable thead th.today-column { border-top: 2px solid red !important; }
        #scheduleTable tbody tr:last-child td.today-column { border-bottom: 2px solid red !important; }

        /* ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚»ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #scheduleTable tbody td.clicked-cell { background-color: #007bff !important; }
        #scheduleTable td.today-column.clicked-cell { background-color: #007bff !important; }

        /* åˆ—ã‚’éè¡¨ç¤ºã«ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ« */
        .hidden-column { display: none; }

        /* èª­ã¿è¾¼ã¿ä¸­ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .loading { font-style: italic; color: #888; text-align: center; padding: 20px; }
        #error-message { color: red; margin-top: 10px; min-height: 1.2em; }

        /* éæ´»æ€§ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .controls button:disabled { background-color: #e9ecef; color: #6c757d; border-color: #ced4da; cursor: not-allowed; opacity: 0.65; }
        .controls button.success:disabled { background-color: #a3d9af; border-color: #a3d9af; color: #6c757d; }

        /* ãƒ‘ã‚¹è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #savedPathContainer { margin-top: 10px; padding: 8px; background-color: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9em; display: flex; align-items: center; gap: 8px; }
        #savedPathContainer button { padding: 2px 6px; font-size: 0.8em; }

        /* è¨­å®šç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #settingsContainer { margin-top: 15px; padding: 15px; border: 1px dashed #ccc; background-color: #f9f9f9; border-radius: 4px; }
        #settingsContainer h4 { margin-top: 0; margin-bottom: 10px; font-size: 1.1em;}
        #settingsContainer label { margin-right: 5px; font-size: 0.9em; }
        #settingsContainer input[type="text"] { padding: 4px 6px; border: 1px solid #ccc; border-radius: 3px; width: calc(100% - 180px); min-width: 200px; font-size: 0.9em; }
        #settingsContainer button { margin-left: 5px; padding: 4px 8px; font-size: 0.9em; }
        #openSettingsButton { margin-left: 15px; background-color: #6c757d; color: white; border-color: #6c757d; }
        #openSettingsButton:hover { background-color: #5a6268; }
    </style>
</head>
<body>

<h1>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯</h1>

<div class="schedule-container">
    <!-- æ“ä½œãƒœã‚¿ãƒ³ç¾¤ -->
    <div class="controls">
        <button id="prevMonth">&lt; å‰æœˆ</button>
        <span id="monthYear">èª­ã¿è¾¼ã¿ä¸­...</span>
        <button id="nextMonth">æ¬¡æœˆ &gt;</button>
        <input type="number" id="yearInput" placeholder="å¹´">
        <input type="number" id="monthInput" placeholder="æœˆ" min="1" max="12">
        <button id="moveButton">ç§»å‹•</button>
        <button id="todayButton">ä»Šæ—¥ã¸</button>
        <button id="addMemberButton" class="primary">ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </button>
        <button id="openSettingsButton">è¨­å®š</button>
        <div class="file-controls">
            <span id="unsavedChanges" style="display: none;">â–² æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™</span>
            <button id="loadButton" class="info">JSONèª­è¾¼</button>
            <input type="file" id="fileInput" accept=".json">
            <button id="saveButton" class="success" disabled>JSONä¿å­˜</button>
        </div>
    </div>

    <!-- è¨­å®šç”»é¢ã‚¨ãƒªã‚¢ (åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º) -->
    <div id="settingsContainer" style="display: none;">
        <h4>è¨­å®š</h4>
        <label for="savePathInput">æ¨å¥¨ä¿å­˜å…ˆãƒ‘ã‚¹:</label>
        <input type="text" id="savePathInput" placeholder="ä¾‹: C:\Users\YourName\Documents\Schedules">
        <button id="applySettingsButton">é©ç”¨</button>
        <button id="closeSettingsButton">é–‰ã˜ã‚‹</button>
    </div>

    <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="table-wrapper">
        <table id="scheduleTable">
            <thead><tr id="headerRow"><th>ãƒ¡ãƒ³ãƒãƒ¼</th></tr></thead>
            <tbody id="scheduleBody"><tr><td colspan="32" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</td></tr></tbody>
        </table>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <p id="error-message"></p>

    <!-- æ¨å¥¨ä¿å­˜å…ˆãƒ‘ã‚¹è¡¨ç¤ºã‚¨ãƒªã‚¢ (åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º) -->
    <div id="savedPathContainer" style="display: none;">
        <span>æ¨å¥¨ä¿å­˜å…ˆ: </span>
        <span id="savedPathDisplay"></span>
        <button id="copyPathButton">ãƒ‘ã‚¹ã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>

</div>

<script>
    // --- å®šæ•° ---
    const MAX_DAYS = 31; // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§è¡¨ç¤ºã™ã‚‹æœ€å¤§æ—¥æ•°
    const MIN_CELL_HEIGHT = 30; // ã‚»ãƒ«ã®æœ€ä½é«˜ã• (px)
    const RESIZE_DEBOUNCE_TIME = 150; // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®å†è¨ˆç®—é…å»¶æ™‚é–“ (ms)
    const WEEK_DAY_SHORT_NAMES = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"]; // æ›œæ—¥ã®ç•¥ç§°

    // --- DOMè¦ç´ å–å¾— ---
    // é »ç¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹DOMè¦ç´ ã‚’å¤‰æ•°ã«æ ¼ç´
    const scheduleBody = document.getElementById('scheduleBody');
    const headerRow = document.getElementById('headerRow');
    const monthYearElement = document.getElementById('monthYear');
    const prevMonthButton = document.getElementById('prevMonth');
    const nextMonthButton = document.getElementById('nextMonth');
    const yearInput = document.getElementById('yearInput');
    const monthInput = document.getElementById('monthInput');
    const moveButton = document.getElementById('moveButton');
    const todayButton = document.getElementById('todayButton');
    const addMemberButton = document.getElementById('addMemberButton');
    const loadButton = document.getElementById('loadButton');
    const fileInput = document.getElementById('fileInput');
    const saveButton = document.getElementById('saveButton');
    const unsavedChangesElement = document.getElementById('unsavedChanges');
    const errorMessageElement = document.getElementById('error-message');
    const tableWrapper = document.getElementById('table-wrapper');
    const scheduleTable = document.getElementById('scheduleTable');
    // è¨­å®šé–¢é€£
    const settingsContainer = document.getElementById('settingsContainer');
    const savePathInput = document.getElementById('savePathInput');
    const applySettingsButton = document.getElementById('applySettingsButton');
    const closeSettingsButton = document.getElementById('closeSettingsButton');
    const openSettingsButton = document.getElementById('openSettingsButton');
    // ãƒ‘ã‚¹è¡¨ç¤ºé–¢é€£
    const savedPathContainer = document.getElementById('savedPathContainer');
    const savedPathDisplay = document.getElementById('savedPathDisplay');
    const copyPathButton = document.getElementById('copyPathButton');

    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    let currentDate = new Date();      // ç¾åœ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¡¨ç¤ºã—ã¦ã„ã‚‹å¹´æœˆ
    let holidaysData = {};           // ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ ({"YYYY-MM-DD": "ç¥æ—¥å"})
    let members = [];                // ãƒ¡ãƒ³ãƒãƒ¼åã®ãƒªã‚¹ãƒˆ (è¡¨ç¤ºé †)
    let scheduleData = {};           // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ ({"ãƒ¡ãƒ³ãƒãƒ¼å": {"YYYY-MM-DD": true}})
    let hasUnsavedChanges = false;   // æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹ã‹ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
    let currentRecommendedSavePath = ""; // æ¨å¥¨ä¿å­˜å…ˆãƒ‘ã‚¹ (è¨­å®šç”»é¢ç”¨)
    let resizeTimeout;               // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®å‡¦ç†é…å»¶ç”¨ã‚¿ã‚¤ãƒãƒ¼ID

    // --- é–¢æ•°å®šç¾© ---

    /**
     * ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’å†…é–£åºœæä¾›ã®APIäº’æ›JSONã‹ã‚‰éåŒæœŸã§å–å¾—ã™ã‚‹ã€‚
     * @returns {Promise<boolean>} ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æˆå¦ã€‚
     */
    async function fetchHolidays() {
        const apiUrl = 'https://holidays-jp.github.io/api/v1/date.json';
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`APIã‚¨ãƒ©ãƒ¼ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status})`);
            holidaysData = await response.json();
            errorMessageElement.textContent = ''; // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
            console.info("ç¥æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ");
            return true;
        } catch (error) {
            console.error('ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            errorMessageElement.textContent = `ã‚¨ãƒ©ãƒ¼: ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚(${error.message})`;
            holidaysData = {}; // å–å¾—å¤±æ•—æ™‚ã¯ç©ºãƒ‡ãƒ¼ã‚¿
            return false;
        }
    }

    /**
     * å¹´æœˆæ—¥ã‹ã‚‰ 'YYYY-MM-DD' å½¢å¼ã®æ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹ã€‚
     * @param {number} year - å¹´ã€‚
     * @param {number} month - æœˆ (0-11)ã€‚
     * @param {number} day - æ—¥ (1-31)ã€‚
     * @returns {string} 'YYYY-MM-DD' å½¢å¼ã®æ–‡å­—åˆ—ã€‚
     */
    function formatDate(year, month, day) {
        return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    }

    /**
     * ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã®é«˜ã•ã‚’èª¿æ•´ã—ã€æ—¥ä»˜ã‚»ãƒ«ãŒæ­£æ–¹å½¢ã«è¿‘ã¥ãã‚ˆã†ã«ã™ã‚‹ã€‚
     * å¸¸ã«31æ—¥åˆ†ã®åˆ—ãŒå­˜åœ¨ã™ã‚‹å‰æã§è¨ˆç®—ã—ã€ä¸è¦ãªåˆ—ã¯CSSã§éè¡¨ç¤ºã«ã™ã‚‹ã€‚
     */
    function adjustRowHeights() {
        if (!scheduleTable || !headerRow || scheduleBody.children.length === 0) return; // å¿…è¦ãªè¦ç´ ãŒãªã‘ã‚Œã°çµ‚äº†
        const memberNameHeader = headerRow.querySelector('th:first-child');
        if (!memberNameHeader) return; // ãƒ¡ãƒ³ãƒãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ãŒãªã‘ã‚Œã°çµ‚äº†

        const memberNameWidth = memberNameHeader.offsetWidth;
        const dateColumnCount = MAX_DAYS; // åˆ—æ•°ã¯å¸¸ã«31ã§è¨ˆç®—
        const tableVisibleWidth = scheduleTable.clientWidth;
        const availableWidthForDates = tableVisibleWidth - memberNameWidth;
        let cellWidth = Math.max(10, availableWidthForDates / dateColumnCount); // å¹…è¨ˆç®— (æœ€ä½10px)

        const calculatedHeight = Math.max(cellWidth, MIN_CELL_HEIGHT); // é«˜ã•è¨ˆç®— (æœ€ä½MIN_CELL_HEIGHT)
        const finalHeight = `${calculatedHeight}px`;

        // ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒœãƒ‡ã‚£ã®å…¨ã‚»ãƒ«ã®é«˜ã•ã‚’è¨­å®š
        headerRow.querySelectorAll('th').forEach(th => { th.style.height = finalHeight; });
        Array.from(scheduleBody.children).forEach(row => {
            row.querySelectorAll('th, td').forEach(cell => {
                cell.style.height = finalHeight;
                if (cell.tagName === 'TD') { cell.style.lineHeight = finalHeight; } // TDã¯line-heightã‚‚åˆã‚ã›ã‚‹
            });
        });
    }

    /**
     * æŒ‡å®šã•ã‚ŒãŸå¹´æœˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ã‚’æç”»ï¼ˆã¾ãŸã¯å†æç”»ï¼‰ã™ã‚‹ã€‚
     * å¸¸ã«31æ—¥åˆ†ã®åˆ—ã‚’æç”»ã—ã€å­˜åœ¨ã—ãªã„æ—¥ä»˜ã®åˆ—ã¯éè¡¨ç¤ºã«ã™ã‚‹ã€‚
     * @param {number} year - è¡¨ç¤ºã™ã‚‹å¹´ã€‚
     * @param {number} month - è¡¨ç¤ºã™ã‚‹æœˆ (0-11)ã€‚
     */
    function generateSchedule(year, month) {
        console.info(`ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æç”»é–‹å§‹: ${year}å¹´${month + 1}æœˆ`);
        // --- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã®æ›´æ–° ---
        headerRow.innerHTML = '<th>ãƒ¡ãƒ³ãƒãƒ¼</th>'; // ãƒ˜ãƒƒãƒ€ãƒ¼åˆæœŸåŒ–
        monthYearElement.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        yearInput.value = year;
        monthInput.value = month + 1;
        const daysInMonth = new Date(year, month + 1, 0).getDate(); // è¡¨ç¤ºæœˆã®æ—¥æ•°
        const today = new Date();
        const todayYear = today.getFullYear();
        const todayMonth = today.getMonth();
        const todayDate = today.getDate();

        // --- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ãƒ«ç”Ÿæˆ (å¸¸ã«1æ—¥ã‹ã‚‰MAX_DAYSã¾ã§) ---
        for (let day = 1; day <= MAX_DAYS; day++) {
            const th = document.createElement('th');
            if (day <= daysInMonth) { // æœˆã®æ—¥ä»˜ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
                const currentDay = new Date(year, month, day);
                const dayOfWeek = currentDay.getDay();
                const dateStr = formatDate(year, month, day);
                th.classList.add('date-header');
                th.innerHTML = `<span class="day-number">${day}</span><span class="day-of-week">(${WEEK_DAY_SHORT_NAMES[dayOfWeek]})</span>`;
                // æ›œæ—¥ãƒ»ç¥æ—¥ã‚¯ãƒ©ã‚¹è¨­å®š
                if (holidaysData[dateStr]) { th.classList.add('holiday'); th.title = holidaysData[dateStr]; }
                else if (dayOfWeek === 0) { th.classList.add('sunday'); }
                else if (dayOfWeek === 6) { th.classList.add('saturday'); }
                // ä»Šæ—¥ã®æ—¥ä»˜ãªã‚‰ today-column ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                if (year === todayYear && month === todayMonth && day === todayDate) {
                    th.classList.add('today-column');
                }
            } else { // æœˆã®æ—¥ä»˜ãŒå­˜åœ¨ã—ãªã„å ´åˆ
                th.classList.add('hidden-column'); // éè¡¨ç¤ºã‚¯ãƒ©ã‚¹
            }
            headerRow.appendChild(th);
        }

        // --- ãƒœãƒ‡ã‚£éƒ¨åˆ†ã®ç”Ÿæˆ ---
        scheduleBody.innerHTML = ''; // ãƒœãƒ‡ã‚£ã‚¯ãƒªã‚¢
        members.forEach(memberName => {
            // å„ãƒ¡ãƒ³ãƒãƒ¼ã«ã¤ã„ã¦è¡Œè¦ç´ ã‚’ä½œæˆãƒ»è¿½åŠ  (31æ—¥åˆ†ã®ã‚»ãƒ«ã‚’æŒã¤)
            const memberRow = createMemberRowElement(memberName, year, month, daysInMonth);
            scheduleBody.appendChild(memberRow);
        });

        // --- ä»Šæ—¥ã®ãƒœãƒ‡ã‚£åˆ—ãƒã‚¤ãƒ©ã‚¤ãƒˆ ---
        if (year === todayYear && month === todayMonth) { // ä»Šæœˆã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹å ´åˆã®ã¿
            const todayCellIndex = todayDate - 1; // 0å§‹ã¾ã‚Šã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            Array.from(scheduleBody.querySelectorAll('tr')).forEach(row => {
                const cellsInRow = row.querySelectorAll('td'); // è¡Œå†…ã®å…¨tdè¦ç´ 
                // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæœ‰åŠ¹ç¯„å›²å†…ã‹ç¢ºèª (å¸¸ã«MAX_DAYS=31åˆ—ã‚ã‚‹)
                if (todayCellIndex >= 0 && cellsInRow.length > todayCellIndex) {
                     const bodyCell = cellsInRow[todayCellIndex];
                     if (bodyCell) { bodyCell.classList.add('today-column'); }
                }
            });
        }

        // --- é«˜ã•èª¿æ•´ ---
        requestAnimationFrame(adjustRowHeights); // DOMæ›´æ–°å¾Œã«é«˜ã•ã‚’èª¿æ•´
        console.info(`ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æç”»å®Œäº†: ${year}å¹´${month + 1}æœˆ`);
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼1äººåˆ†ã®è¡Œè¦ç´ ï¼ˆ<tr>ï¼‰ã‚’ä½œæˆã™ã‚‹ã€‚
     * å¸¸ã«31æ—¥åˆ†ã®ã‚»ãƒ«ã‚’æŒã¤è¡Œã‚’ç”Ÿæˆã—ã€ä¸è¦ãªæ—¥ä»˜ã‚»ãƒ«ã¯éè¡¨ç¤ºã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ã™ã‚‹ã€‚
     * @param {string} memberName - ãƒ¡ãƒ³ãƒãƒ¼åã€‚
     * @param {number} year - å¹´ã€‚
     * @param {number} month - æœˆ (0-11)ã€‚
     * @param {number} daysInMonth - ãã®æœˆã®æ—¥æ•°ã€‚
     * @returns {HTMLTableRowElement} ä½œæˆã•ã‚ŒãŸè¡Œè¦ç´  (<tr>)ã€‚
     */
    function createMemberRowElement(memberName, year, month, daysInMonth) {
        const row = document.createElement('tr');
        // ãƒ¡ãƒ³ãƒãƒ¼åã‚»ãƒ« (th) ã‚’ä½œæˆãƒ»è¨­å®š
        const th = document.createElement('th');
        th.setAttribute('contenteditable', 'true');
        th.textContent = memberName;
        th.addEventListener('input', handleMemberNameInput);
        th.addEventListener('keypress', handleMemberNameEnter);
        th.addEventListener('keydown', handleMemberNameBackspace);
        row.appendChild(th);

        // æ—¥ä»˜ã‚»ãƒ« (td) ã‚’ç”Ÿæˆ (å¸¸ã«1æ—¥ã‹ã‚‰MAX_DAYSã¾ã§)
        for (let day = 1; day <= MAX_DAYS; day++) {
            const td = document.createElement('td');
            if (day <= daysInMonth) { // æœˆã®æ—¥ä»˜ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
                const dateStr = formatDate(year, month, day);
                td.dataset.member = memberName; // ãƒ‡ãƒ¼ã‚¿å±æ€§è¨­å®š
                td.dataset.date = dateStr;
                // æ›œæ—¥ãƒ»ç¥æ—¥ã‚¯ãƒ©ã‚¹è¨­å®š
                const currentDay = new Date(year, month, day);
                const dayOfWeek = currentDay.getDay();
                if (holidaysData[dateStr]) { td.classList.add('holiday-cell'); }
                else if (dayOfWeek === 0) { td.classList.add('sunday-cell'); }
                else if (dayOfWeek === 6) { td.classList.add('saturday-cell'); }
                // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã‚¯ãƒªãƒƒã‚¯çŠ¶æ…‹å¾©å…ƒ
                if (scheduleData[memberName] && scheduleData[memberName][dateStr]) {
                    td.classList.add('clicked-cell');
                }
            } else { // æœˆã®æ—¥ä»˜ãŒå­˜åœ¨ã—ãªã„å ´åˆ
                td.classList.add('hidden-column'); // éè¡¨ç¤ºã‚¯ãƒ©ã‚¹
            }
            row.appendChild(td);
        }
        return row;
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼åã‚»ãƒ«ãŒç·¨é›†ã•ã‚ŒãŸã¨ãã®å‡¦ç†ã€‚
     * æœªä¿å­˜ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã€scheduleDataã¨é–¢é€£ã™ã‚‹tdã®datasetã‚’æ›´æ–°ã™ã‚‹ã€‚
     * @param {Event} event - inputã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
     */
    function handleMemberNameInput(event) {
        setUnsavedChanges(true); // æœªä¿å­˜ãƒ•ãƒ©ã‚°ON
        const cell = event.target; // ç·¨é›†ã•ã‚ŒãŸã‚»ãƒ«(th)
        const currentRow = cell.closest('tr');
        const currentName = cell.textContent.trim(); // æ–°ã—ã„åå‰
        const tds = currentRow.querySelectorAll('td:not(.hidden-column)'); // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ—¥ä»˜ã‚»ãƒ«
        const originalName = tds.length > 0 ? tds[0].dataset.member : ''; // å…ƒã®åå‰

        // scheduleDataã®ã‚­ãƒ¼æ›´æ–°å‡¦ç†
        if (originalName && originalName !== currentName && scheduleData[originalName]) {
            if (!scheduleData[currentName]) {
                scheduleData[currentName] = scheduleData[originalName];
                delete scheduleData[originalName];
            } else {
                console.warn(`ãƒ¡ãƒ³ãƒãƒ¼åå¤‰æ›´è­¦å‘Š: "${currentName}" ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚"${originalName}" ã®ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã¾ã™ã€‚`);
                delete scheduleData[originalName]; // å¤ã„ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
            }
        }
        // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹æ—¥ä»˜ã‚»ãƒ«ã®dataset.memberã‚’æ›´æ–°
        tds.forEach(td => { td.dataset.member = currentName; });
    }

    /**
     * æ–°ã—ã„ãƒ¡ãƒ³ãƒãƒ¼è¡Œï¼ˆç©ºè¡Œï¼‰ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ«å°¾ã«è¿½åŠ ã™ã‚‹ã€‚
     * @param {boolean} [setUnsaved=true] - è¿½åŠ æ™‚ã«æœªä¿å­˜ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ã‹ã€‚
     */
    function addMemberRow(setUnsaved = true) {
        hideSavedPathInfo();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const newRow = createMemberRowElement("", currentYear, currentMonth, daysInMonth); // ç©ºè¡Œä½œæˆ
        scheduleBody.appendChild(newRow);

        // â˜… generateScheduleã§ã¾ã¨ã‚ã¦å‡¦ç†ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã®ä»Šæ—¥ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†ã¯ä¸è¦ â˜…

        requestAnimationFrame(adjustRowHeights); // é«˜ã•èª¿æ•´
        tableWrapper.scrollTop = tableWrapper.scrollHeight; // æœ€ä¸‹éƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        const newMemberCell = newRow.querySelector('th[contenteditable="true"]');
        if (newMemberCell) newMemberCell.focus(); // æ–°è¦ã‚»ãƒ«ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        if (setUnsaved) setUnsavedChanges(true);
        console.info("æ–°ã—ã„ãƒ¡ãƒ³ãƒãƒ¼è¡Œã‚’è¿½åŠ ã—ã¾ã—ãŸ");
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼åã‚»ãƒ«ã§Enterã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†ã€‚
     * æ¬¡ã®è¡Œã¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•ã€ã¾ãŸã¯æœ€çµ‚è¡Œãªã‚‰æ–°è¦è¡Œè¿½åŠ ã€‚
     * @param {KeyboardEvent} event - keypressã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
     */
    function handleMemberNameEnter(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // æ”¹è¡Œé˜²æ­¢
            const cell = event.target;
            const currentName = cell.textContent.trim();
            if (currentName && !scheduleData[currentName]) { scheduleData[currentName] = {}; } // ãƒ‡ãƒ¼ã‚¿æº–å‚™
            const currentRow = cell.closest('tr');
            const rows = Array.from(scheduleBody.children);
            const currentIndex = rows.indexOf(currentRow);
            if (currentIndex === rows.length - 1) { // æœ€çµ‚è¡Œã®å ´åˆ
                addMemberRow(); // æ–°è¦è¡Œè¿½åŠ 
            } else { // æœ€çµ‚è¡Œã§ãªã„å ´åˆ
                const nextRow = rows[currentIndex + 1];
                const nextMemberCell = nextRow?.querySelector('th[contenteditable="true"]');
                if (nextMemberCell) nextMemberCell.focus(); // æ¬¡ã®è¡Œã¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            }
        }
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼åã‚»ãƒ«ãŒç©ºã®çŠ¶æ…‹ã§Backspaceã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†ã€‚
     * è¡Œã‚’å‰Šé™¤ã—ã€é©åˆ‡ãªã‚»ãƒ«ã¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»å‹•ã™ã‚‹ã€‚
     * @param {KeyboardEvent} event - keydownã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
     */
    function handleMemberNameBackspace(event) {
         if (event.key === 'Backspace') {
            const cell = event.target;
            if (cell.textContent.trim() === '' && scheduleBody.children.length > 1) { // ç©º & è¤‡æ•°è¡Œå­˜åœ¨
                event.preventDefault();
                hideSavedPathInfo();
                const currentRow = cell.closest('tr');
                // å‰Šé™¤å¯¾è±¡ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
                const tds = currentRow.querySelectorAll('td:not(.hidden-column)');
                const memberName = tds.length > 0 ? tds[0].dataset.member : '';
                if (memberName && scheduleData[memberName]) delete scheduleData[memberName];

                const rows = Array.from(scheduleBody.children);
                const currentIndex = rows.indexOf(currentRow);
                let focusMoved = false;
                // ä¸Šã®è¡ŒãŒã‚ã‚Œã°ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•
                if (currentIndex > 0) {
                    const prevRow = rows[currentIndex - 1];
                    const prevMemberCell = prevRow?.querySelector('th[contenteditable="true"]');
                    if (prevMemberCell) {
                        prevMemberCell.focus();
                        // ã‚«ãƒ¼ã‚½ãƒ«ã‚’æœ«å°¾ã«ç§»å‹•
                        const range = document.createRange(); const sel = window.getSelection();
                        range.selectNodeContents(prevMemberCell); range.collapse(false);
                        sel.removeAllRanges(); sel.addRange(range);
                        focusMoved = true;
                    }
                }
                // ä¸Šã«ç§»å‹•ã§ããšã€ä»–ã«ã¾ã è¡ŒãŒæ®‹ã‚‹å ´åˆã¯ä¸‹ã®è¡Œã¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                if (!focusMoved && rows.length > 1) { // å‰Šé™¤å¾Œã‚‚è¡ŒãŒæ®‹ã‚‹ã“ã¨ã‚’ç¢ºèª (rows.length > 1)
                    const nextRow = rows[currentIndex + 1]; // å‰Šé™¤å¾Œã®æ¬¡ã®è¡Œ
                    const nextMemberCell = nextRow?.querySelector('th[contenteditable="true"]');
                    if (nextMemberCell) nextMemberCell.focus();
                }
                currentRow.remove(); // è¡Œå‰Šé™¤
                setUnsavedChanges(true);
                requestAnimationFrame(adjustRowHeights); // é«˜ã•å†èª¿æ•´
                console.info("ãƒ¡ãƒ³ãƒãƒ¼è¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
            }
        }
    }

    /**
     * æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ« (td) ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å‡¦ç†ã€‚
     * èƒŒæ™¯è‰²ã‚’ãƒˆã‚°ãƒ«ã—ã€scheduleDataã‚’æ›´æ–°ã™ã‚‹ã€‚éè¡¨ç¤ºã‚»ãƒ«ã¯ç„¡è¦–ã™ã‚‹ã€‚
     * @param {MouseEvent} event - clickã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
     */
    function handleCellClick(event) {
        const target = event.target;
        // TDè¦ç´ ã€éè¡¨ç¤ºã§ãªã„ã€å¿…è¦ãªdataå±æ€§ã‚’æŒã¤ã€ã“ã¨ã‚’ç¢ºèª
        if (target.tagName === 'TD' && !target.classList.contains('hidden-column') && target.dataset.date && target.dataset.member !== undefined) {
            hideSavedPathInfo();
            const memberName = target.dataset.member;
            const dateStr = target.dataset.date;
            // ãƒ¡ãƒ³ãƒãƒ¼åãŒç©ºãªã‚‰è­¦å‘Š
            if (memberName === "") {
                 alert("ãƒ¡ãƒ³ãƒãƒ¼åã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
                 const row = target.closest('tr');
                 const memberCell = row?.querySelector('th[contenteditable="true"]');
                 if (memberCell) memberCell.focus(); // åå‰å…¥åŠ›ã‚»ãƒ«ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                 return;
            }
            // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆãƒˆã‚°ãƒ«ï¼‰
            if (!scheduleData[memberName]) scheduleData[memberName] = {};
            if (!scheduleData[memberName][dateStr]) {
                scheduleData[memberName][dateStr] = true;
                target.classList.add('clicked-cell');
            } else {
                delete scheduleData[memberName][dateStr];
                target.classList.remove('clicked-cell');
            }
            setUnsavedChanges(true);
        }
    }

    /**
     * æœªä¿å­˜çŠ¶æ…‹ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°ã—ã€UIï¼ˆæœªä¿å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ä¿å­˜ãƒœã‚¿ãƒ³ï¼‰ã«åæ˜ ã™ã‚‹ã€‚
     * @param {boolean} status - æœªä¿å­˜çŠ¶æ…‹ã«ã™ã‚‹å ´åˆã¯ trueã€‚
     */
    function setUnsavedChanges(status) {
        if (hasUnsavedChanges !== status) { // çŠ¶æ…‹å¤‰åŒ–æ™‚ã®ã¿ãƒ­ã‚°å‡ºåŠ›
            console.info(`æœªä¿å­˜ãƒ•ãƒ©ã‚°å¤‰æ›´: ${hasUnsavedChanges} -> ${status}`);
            hasUnsavedChanges = status;
            unsavedChangesElement.style.display = status ? 'inline' : 'none'; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºåˆ‡æ›¿
            saveButton.disabled = !status; // ä¿å­˜ãƒœã‚¿ãƒ³æœ‰åŠ¹/ç„¡åŠ¹åˆ‡æ›¿
        }
    }

    /**
     * JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã¨ãã®èª­ã¿è¾¼ã¿å‡¦ç†ã€‚
     * ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã€members, scheduleData, è¨­å®šã‚’æ›´æ–°å¾Œã€ç¾åœ¨ã®å¹´æœˆã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»ã™ã‚‹ã€‚
     * @param {Event} event - changeã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (input[type=file])ã€‚
     */
    function handleFileLoad(event) {
        hideSavedPathInfo();
        const file = event.target.files[0];
        if (!file) return; // ãƒ•ã‚¡ã‚¤ãƒ«æœªé¸æŠ
        console.info(`JSONãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹: ${file.name}`);
        const reader = new FileReader();
        reader.onload = function(e) {
            const jsonString = e.target.result;
            try {
                const data = JSON.parse(jsonString);
                // ãƒ‡ãƒ¼ã‚¿æ§‹é€ æ¤œè¨¼
                if (data && typeof data.year === 'number' && typeof data.month === 'number' && Array.isArray(data.members) && typeof data.schedule === 'object' && data.schedule !== null) {
                    // å¹´æœˆå¦¥å½“æ€§æ¤œè¨¼
                    if (data.year > 1900 && data.year < 3000 && data.month >= 1 && data.month <= 12) {
                        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°æ›´æ–°
                        members = data.members.filter(m => typeof m === 'string' && m.trim() !== ''); // ç©ºãƒ¡ãƒ³ãƒãƒ¼é™¤å¤–
                        scheduleData = data.schedule || {};
                        const filteredSchedule = {}; // membersã«å«ã¾ã‚Œãªã„ãƒ‡ãƒ¼ã‚¿ã‚’é™¤å¤–
                        members.forEach(mem => { if(data.schedule[mem]) { filteredSchedule[mem] = data.schedule[mem]; } });
                        scheduleData = filteredSchedule;
                        // è¨­å®šèª­ã¿è¾¼ã¿
                        if (data.settings && typeof data.settings.recommendedSavePath === 'string') {
                            currentRecommendedSavePath = data.settings.recommendedSavePath;
                            savePathInput.value = currentRecommendedSavePath;
                        } else { currentRecommendedSavePath = ""; savePathInput.value = ""; }

                        // â˜… è¡¨ç¤ºå¹´æœˆã¯å¤‰æ›´ã›ãšã€ç¾åœ¨ã®å¹´æœˆã§å†æç”» â˜…
                        generateSchedule(currentDate.getFullYear(), currentDate.getMonth());
                        errorMessageElement.textContent = ''; // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
                        alert(`${data.year}å¹´${data.month}æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚\nã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯ç¾åœ¨è¡¨ç¤ºä¸­ã® ${currentDate.getFullYear()}å¹´${currentDate.getMonth() + 1}æœˆ ã‚’ç¶­æŒã—ã¾ã™ã€‚`);
                        setUnsavedChanges(false); // èª­ã¿è¾¼ã¿ç›´å¾Œã¯æœªä¿å­˜çŠ¶æ…‹
                        console.info(`JSONãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ: ${file.name}`);
                    } else { throw new Error("JSONå†…ã®å¹´æœˆãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™ã€‚"); }
                } else { throw new Error("JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚(year, month, members(é…åˆ—), schedule(ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)ãŒå¿…é ˆã§ã™)"); }
            } catch (error) {
                console.error(`JSONèª­ã¿è¾¼ã¿/è§£æå¤±æ•— (${file.name}):`, error);
                errorMessageElement.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${error.message}`);
                initializeSchedule(); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯åˆæœŸåŒ–
            } finally { fileInput.value = null; } // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒªã‚»ãƒƒãƒˆ
        };
        reader.onerror = function(e) {
            console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            errorMessageElement.textContent = 'ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            fileInput.value = null;
        };
        reader.readAsText(file);
    }

    /**
     * ç¾åœ¨æ™‚åˆ»ã‹ã‚‰ 'YYYYMMDDHHMMSS' å½¢å¼ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹ã€‚
     * @returns {string} ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ–‡å­—åˆ—ã€‚
     */
    function getTimestampString() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `${year}${month}${day}${hours}${minutes}${seconds}`;
    }

     /**
     * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼çµµæ–‡å­—ğŸ“…ã‚’Faviconã¨ã—ã¦è¨­å®šã™ã‚‹ã€‚
     */
    function setCalendarFavicon() {
        const emoji = 'ğŸ“…'; const size = 32;
        const canvas = document.createElement('canvas');
        canvas.width = size; canvas.height = size;
        const ctx = canvas.getContext('2d');
        if (!ctx) return; // Canvasæœªå¯¾å¿œ
        ctx.font = `${size * 0.85}px sans-serif`;
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(emoji, size / 2, size / 2 + size * 0.08); // Yåº§æ¨™å¾®èª¿æ•´
        try {
            const dataURL = canvas.toDataURL('image/png');
            let link = document.querySelector("link[rel*='icon']");
            if (!link) { link = document.createElement('link'); link.rel = 'icon'; document.head.appendChild(link); }
            link.type = 'image/png'; link.href = dataURL;
        } catch (error) { console.error("Faviconã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ:", error); }
    }

    /**
     * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–å‡¦ç†ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œï¼‰ã€‚
     * ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ç¾åœ¨ã®å¹´æœˆã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»ã™ã‚‹ã€‚
     */
    async function initializeSchedule() {
        console.info("ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹");
        // UIåˆæœŸçŠ¶æ…‹è¨­å®š
        monthYearElement.textContent = 'ç¥æ—¥ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­...';
        scheduleBody.innerHTML = `<tr><td colspan="${MAX_DAYS + 1}" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</td></tr>`;
        saveButton.disabled = true;
        settingsContainer.style.display = 'none';
        hideSavedPathInfo();
        setCalendarFavicon();

        await fetchHolidays(); // ç¥æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ã‚’å¾…ã¤

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
        members = [""]; // ç©ºã®ãƒ¡ãƒ³ãƒãƒ¼1è¡Œ
        scheduleData = {};
        currentRecommendedSavePath = "";
        savePathInput.value = "";
        currentDate = new Date(); // è¡¨ç¤ºå¹´æœˆã‚’ç¾åœ¨ã«

        generateSchedule(currentDate.getFullYear(), currentDate.getMonth()); // åˆæœŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        setUnsavedChanges(false); // æœªä¿å­˜ãƒ•ãƒ©ã‚°è§£é™¤
        console.info("ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å®Œäº†");
        requestAnimationFrame(adjustRowHeights); // åˆæœŸé«˜ã•èª¿æ•´
    }

    /**
     * æ¨å¥¨ä¿å­˜å…ˆãƒ‘ã‚¹è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã«ã™ã‚‹ã€‚
     */
    function hideSavedPathInfo() {
        if (savedPathContainer.style.display !== 'none') {
            savedPathContainer.style.display = 'none';
            savedPathDisplay.textContent = '';
        }
    }

    /**
     * ãƒ‘ã‚¹ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (document.execCommand)ã€‚
     * @param {string} text - ã‚³ãƒ”ãƒ¼ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã€‚
     */
    function copyPathFallback(text) {
        try {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            if (!successful) throw new Error('document.execCommand("copy") ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚');
            alert(`ãƒ‘ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ (Fallback):\n${text}`);
        } catch (err) {
            alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
            console.error('ãƒ‘ã‚¹ã‚³ãƒ”ãƒ¼å¤±æ•— (Fallback):', err);
        }
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
    // å„DOMè¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚ã®å‡¦ç†é–¢æ•°ã‚’ç´ä»˜ã‘ã‚‹

    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœãƒ‡ã‚£ã®ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”ä»»ï¼‰
    scheduleBody.addEventListener('click', handleCellClick);

    // æ“ä½œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
    prevMonthButton.addEventListener('click', () => {
        hideSavedPathInfo();
        if (hasUnsavedChanges && !confirm("æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ç§»å‹•ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        currentDate.setMonth(currentDate.getMonth() - 1);
        generateSchedule(currentDate.getFullYear(), currentDate.getMonth());
    });
    nextMonthButton.addEventListener('click', () => {
        hideSavedPathInfo();
        if (hasUnsavedChanges && !confirm("æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ç§»å‹•ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        currentDate.setMonth(currentDate.getMonth() + 1);
        generateSchedule(currentDate.getFullYear(), currentDate.getMonth());
    });
    moveButton.addEventListener('click', () => {
        hideSavedPathInfo();
        const year = parseInt(yearInput.value, 10);
        const month = parseInt(monthInput.value, 10) - 1;
        if (!isNaN(year) && year > 1900 && year < 3000 && !isNaN(month) && month >= 0 && month < 12) {
             if (year === currentDate.getFullYear() && month === currentDate.getMonth()) return; // ç§»å‹•ä¸è¦
             if (hasUnsavedChanges && !confirm("æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ç§»å‹•ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
             currentDate = new Date(year, month, 1);
             generateSchedule(currentDate.getFullYear(), currentDate.getMonth());
        } else {
            alert("æœ‰åŠ¹ãªå¹´æœˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: å¹´=2024, æœˆ=1ï½12)ã€‚");
            yearInput.value = currentDate.getFullYear(); monthInput.value = currentDate.getMonth() + 1; // å…¥åŠ›æ¬„ã‚’æˆ»ã™
        }
    });
    todayButton.addEventListener('click', () => {
        hideSavedPathInfo();
        const today = new Date();
        if (currentDate.getFullYear() !== today.getFullYear() || currentDate.getMonth() !== today.getMonth()) {
             if (hasUnsavedChanges && !confirm("æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ç§»å‹•ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
             currentDate = today;
             generateSchedule(currentDate.getFullYear(), currentDate.getMonth());
        } else {
             console.info("æ—¢ã«ä»Šæœˆã‚’è¡¨ç¤ºä¸­ã§ã™ã€‚ä»Šæ—¥ã®åˆ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¾ã™ã€‚");
             const todayHeader = headerRow.querySelector('.today-column');
             if (todayHeader) todayHeader.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    });
    addMemberButton.addEventListener('click', () => addMemberRow(true));

    // ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ
    loadButton.addEventListener('click', () => {
        if (hasUnsavedChanges && !confirm("æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚èª­ã¿è¾¼ã‚€ã¨ç¾åœ¨ã®å¤‰æ›´ã¯å¤±ã‚ã‚Œã¾ã™ãŒã€ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        fileInput.click(); // input[type=file]ã‚’ã‚¯ãƒªãƒƒã‚¯
    });
    fileInput.addEventListener('change', handleFileLoad); // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    saveButton.addEventListener('click', () => {
        hideSavedPathInfo();
        console.info("JSONä¿å­˜å‡¦ç†é–‹å§‹");
        // 1. æœ€æ–°ã®ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã¨å¯¾å¿œã™ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºå®š
        const currentMembers = [];
        const memberCells = scheduleBody.querySelectorAll('th[contenteditable="true"]');
        const potentialScheduleData = {};
        memberCells.forEach(cell => {
            const name = cell.textContent.trim();
            if (name) { // ç©ºã®åå‰ã¯é™¤å¤–
                currentMembers.push(name);
                const row = cell.closest('tr');
                const tds = row.querySelectorAll('td'); // å…¨ã¦ã®td (éè¡¨ç¤ºå«ã‚€)
                const originalName = tds.length > 0 ? tds[0].dataset.member : '';
                // åå‰å¤‰æ›´æ™‚ã®ãƒ‡ãƒ¼ã‚¿å¼•ãç¶™ã
                if (originalName && originalName !== name) {
                    if (scheduleData[originalName]) potentialScheduleData[name] = scheduleData[originalName];
                    else potentialScheduleData[name] = scheduleData[name] || {};
                } else if (scheduleData[name]) { potentialScheduleData[name] = scheduleData[name]; }
                else { potentialScheduleData[name] = {}; } // æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼
                tds.forEach(td => td.dataset.member = name); // datasetæ›´æ–°
            } else { // åå‰ãŒç©ºã«ãªã£ãŸå ´åˆ
                const row = cell.closest('tr');
                const tds = row.querySelectorAll('td');
                const memberNameInDataset = tds.length > 0 ? tds[0].dataset.member : '';
                if(memberNameInDataset && scheduleData[memberNameInDataset]) delete scheduleData[memberNameInDataset]; // å…ƒãƒ‡ãƒ¼ã‚¿å‰Šé™¤
            }
        });
        members = currentMembers; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°æ›´æ–°
        scheduleData = potentialScheduleData; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°æ›´æ–°

        // 2. ä¿å­˜ç”¨ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
        const dataToSave = {
            year: currentDate.getFullYear(), month: currentDate.getMonth() + 1,
            members: members, schedule: scheduleData,
            settings: { recommendedSavePath: currentRecommendedSavePath }
        };

        // 3. JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        try {
            const jsonString = JSON.stringify(dataToSave, null, 2); // æ•´å½¢
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = getTimestampString();
            a.download = `CL${timestamp}.json`; // ãƒ•ã‚¡ã‚¤ãƒ«å
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
            console.info(`JSONä¿å­˜æˆåŠŸ: ${a.download}`);
            setUnsavedChanges(false); // æœªä¿å­˜ãƒ•ãƒ©ã‚°è§£é™¤
            if(currentRecommendedSavePath) { // ãƒ‘ã‚¹è¡¨ç¤º
                savedPathDisplay.textContent = currentRecommendedSavePath;
                savedPathContainer.style.display = 'flex';
            }
        } catch (error) {
            console.error("JSONä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:", error);
            errorMessageElement.textContent = "ã‚¨ãƒ©ãƒ¼: JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            alert("JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        }
    });

    // è¨­å®šé–¢é€£
    copyPathButton.addEventListener('click', () => {
        const path = currentRecommendedSavePath;
        if (!path) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(path).then(() => { alert(`ãƒ‘ã‚¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ:\n${path}`); })
            .catch(err => { console.error('ãƒ‘ã‚¹ã‚³ãƒ”ãƒ¼å¤±æ•— (Clipboard API):', err); copyPathFallback(path); });
        } else { copyPathFallback(path); }
    });
    openSettingsButton.addEventListener('click', () => {
        hideSavedPathInfo();
        settingsContainer.style.display = 'block';
        savePathInput.value = currentRecommendedSavePath;
        console.info("è¨­å®šç”»é¢ã‚’é–‹ãã¾ã—ãŸ");
    });
    closeSettingsButton.addEventListener('click', () => {
        settingsContainer.style.display = 'none';
        console.info("è¨­å®šç”»é¢ã‚’é–‰ã˜ã¾ã—ãŸ");
    });
    applySettingsButton.addEventListener('click', () => {
        const newPath = savePathInput.value.trim();
        if (newPath !== currentRecommendedSavePath) {
            currentRecommendedSavePath = newPath;
            setUnsavedChanges(true); // è¨­å®šå¤‰æ›´ã‚‚æœªä¿å­˜æ‰±ã„
            console.info("æ¨å¥¨ä¿å­˜å…ˆãƒ‘ã‚¹ã‚’å¤‰æ›´ï¼ˆé©ç”¨ï¼‰:", newPath);
            alert("æ¨å¥¨ä¿å­˜å…ˆãƒ‘ã‚¹ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚\nJSONä¿å­˜æ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«ã¸åæ˜ ã•ã‚Œã¾ã™ã€‚");
        }
        settingsContainer.style.display = 'none'; // é©ç”¨å¾Œé–‰ã˜ã‚‹
    });

    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆï¼ˆdebounceå‡¦ç†ä»˜ãï¼‰
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => { requestAnimationFrame(adjustRowHeights); }, RESIZE_DEBOUNCE_TIME);
    });

    // --- åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ ---
    initializeSchedule();

</script>

</body>
</html>
