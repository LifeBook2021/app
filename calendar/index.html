<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯</title>
    <!-- Favicon ã¯JavaScriptã§å‹•çš„ã«è¨­å®š -->
    <style>
        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        body { font-family: sans-serif; margin: 15px; background-color: #f8f9fa; }
        .schedule-container { background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 100%; }
        h1 { font-size: 1.5em; margin-bottom: 15px; }

        /* æ“ä½œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .controls { display: flex; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 8px; }
        .controls button, .controls select, .controls input[type="number"] { padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; cursor: pointer; transition: background-color 0.2s, border-color 0.2s, color 0.2s, opacity 0.2s, box-shadow 0.2s; font-size: 0.9em; }
        .controls button:hover { background-color: #eee; }
        .controls button.primary { background-color: #007bff; color: white; border-color: #007bff; }
        .controls button.primary:hover { background-color: #0056b3; }
        .controls button.info { background-color: #17a2b8; color: white; border-color: #17a2b8; }
        .controls button.info:hover { background-color: #117a8b; }
        .controls button.success { background-color: #28a745; color: white; border-color: #28a745; }
        .controls button.success:hover { background-color: #218838; }
        /* æœªä¿å­˜æ™‚ã®ä¿å­˜ãƒœã‚¿ãƒ³å¼·èª¿ã‚¹ã‚¿ã‚¤ãƒ« */
        .controls button.success.unsaved {
            background-color: #ff9800; /* ã‚ªãƒ¬ãƒ³ã‚¸è‰² */
            border-color: #fb8c00;    /* å°‘ã—æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸ */
            color: white;
            box-shadow: 0 0 0 0.2rem rgba(255, 152, 0, 0.5);
        }
        .controls button.success.unsaved:hover {
            background-color: #f57c00; /* ã•ã‚‰ã«æ¿ƒã„ã‚ªãƒ¬ãƒ³ã‚¸ */
            border-color: #ef6c00;
        }
        .controls span#monthYear { font-size: 1.1em; font-weight: bold; margin: 0 8px; }
        .controls input[type="number"] { width: 60px; }

        /* ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œç³»ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .file-controls { margin-left: auto; display: flex; align-items: center; gap: 8px; }
        #fileInput { display: none; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #scheduleTable { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; border: 1px solid #ccc; }
        #table-wrapper { max-height: 65vh; overflow-y: auto; border-bottom: 1px solid #ccc; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ (thead) */
        #scheduleTable thead th {
            background-color: #f2f2f2; font-weight: bold; position: sticky; top: 0; z-index: 2;
            vertical-align: middle; padding: 4px; border: 1px solid #ddd; font-size: 0.85em;
            line-height: 1.2; text-align: center;
        }
        #scheduleTable thead th:first-child { /* ãƒ¡ãƒ³ãƒãƒ¼åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ */
            width: 120px; background-color: #e9ecef; z-index: 3;
            text-align: left; padding-left: 10px; vertical-align: middle;
        }
        #scheduleTable thead th.date-header { font-size: 0.8em; }
        #scheduleTable thead th .day-number { display: block; font-size: 1.1em; line-height: 1; }
        #scheduleTable thead th .day-of-week { display: block; font-size: 0.9em; color: #555; }

        /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœãƒ‡ã‚£ (tbody) */
        #scheduleTable tbody th, #scheduleTable tbody td {
            border: 1px solid #ddd; padding: 0; text-align: center; white-space: normal;
            overflow: hidden; text-overflow: ellipsis; font-size: 0.85em;
            vertical-align: middle; cursor: default;
        }
        #scheduleTable tbody th { /* ãƒ¡ãƒ³ãƒãƒ¼åã‚»ãƒ« */
            background-color: #f8f9fa; font-weight: normal; text-align: left;
            z-index: 1; width: 120px; border-right: 1px solid #ccc;
            padding-left: 10px;
            vertical-align: middle;
        }
        #scheduleTable tbody th[contenteditable="true"] { cursor: text; background-color: #fff; }
        #scheduleTable tbody th[contenteditable="true"]:focus { outline: 2px solid #007bff; background-color: #eef; }
        #scheduleTable tbody td { /* æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ« */
            background-color: #fff; cursor: pointer; transition: background-color 0.1s ease-in-out;
        }

        /* æ›œæ—¥ãƒ»ç¥æ—¥ã«ã‚ˆã‚‹èƒŒæ™¯è‰² */
        .saturday { background-color: #e3f2fd !important; }
        .sunday { background-color: #ffebee !important; }
        .holiday { background-color: #fff3e0 !important; }
        #scheduleTable tbody tr td.saturday-cell { background-color: #f0f8ff; }
        #scheduleTable tbody tr td.sunday-cell { background-color: #fff7f7; }
        #scheduleTable tbody tr td.holiday-cell { background-color: #fffaf0; }

        /* ä»Šæ—¥ã®åˆ—ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
        #scheduleTable th.today-column, #scheduleTable td.today-column {
             border-left: 2px solid red !important; border-right: 2px solid red !important;
             background-color: #fffde7 !important;
        }
        #scheduleTable thead th.today-column { border-top: 2px solid red !important; }
        #scheduleTable tbody tr:last-child td.today-column { border-bottom: 2px solid red !important; }

        /* ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚»ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #scheduleTable tbody td.clicked-cell { background-color: #007bff !important; }
        #scheduleTable td.today-column.clicked-cell { background-color: #007bff !important; }

        /* åˆ—ã‚’éè¡¨ç¤ºã«ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ« */
        .hidden-column { display: none; }

        /* èª­ã¿è¾¼ã¿ä¸­ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .loading { font-style: italic; color: #888; text-align: center; padding: 20px; }
        #error-message { color: red; margin-top: 10px; min-height: 1.2em; }

        /* éæ´»æ€§ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .controls button:disabled { background-color: #e9ecef; color: #6c757d; border-color: #ced4da; cursor: not-allowed; opacity: 0.65; }
        .controls button.success:disabled { background-color: #a3d9af; border-color: #a3d9af; color: #6c757d; box-shadow: none; }

    </style>
</head>
<body>

<h1>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯</h1>

<div class="schedule-container">
    <!-- æ“ä½œãƒœã‚¿ãƒ³ç¾¤ -->
    <div class="controls">
        <button id="prevMonth">&lt; å‰æœˆ</button>
        <span id="monthYear">èª­ã¿è¾¼ã¿ä¸­...</span>
        <button id="nextMonth">æ¬¡æœˆ &gt;</button>
        <input type="number" id="yearInput" placeholder="å¹´">
        <input type="number" id="monthInput" placeholder="æœˆ" min="1" max="12">
        <button id="moveButton">ç§»å‹•</button>
        <button id="todayButton">ä»Šæ—¥ã¸</button>
        <button id="addMemberButton" class="primary">ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </button>
        <div class="file-controls">
            <button id="loadButton" class="info">JSONèª­è¾¼</button>
            <input type="file" id="fileInput" accept=".json">
            <button id="saveButton" class="success" disabled>JSONä¿å­˜</button>
        </div>
    </div>

    <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="table-wrapper">
        <table id="scheduleTable">
            <thead><tr id="headerRow"><th>ãƒ¡ãƒ³ãƒãƒ¼</th></tr></thead>
            <tbody id="scheduleBody"><tr><td colspan="32" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</td></tr></tbody>
        </table>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <p id="error-message"></p>

</div>

<script>
    // =====================================================================
    // å®šæ•°
    // =====================================================================
    const MAX_DAYS = 31; // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§è¡¨ç¤ºã™ã‚‹æœ€å¤§æ—¥æ•° (åˆ—æ•°)
    const MIN_CELL_HEIGHT = 30; // ã‚»ãƒ«ã®æœ€ä½é«˜ã• (px)
    const RESIZE_DEBOUNCE_TIME = 150; // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®å†è¨ˆç®—é…å»¶æ™‚é–“ (ms)
    const WEEK_DAY_SHORT_NAMES = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"]; // æ›œæ—¥ã®ç•¥ç§°

    // =====================================================================
    // DOMè¦ç´ å–å¾—
    // =====================================================================
    const scheduleBody = document.getElementById('scheduleBody');
    const headerRow = document.getElementById('headerRow');
    const monthYearElement = document.getElementById('monthYear');
    const prevMonthButton = document.getElementById('prevMonth');
    const nextMonthButton = document.getElementById('nextMonth');
    const yearInput = document.getElementById('yearInput');
    const monthInput = document.getElementById('monthInput');
    const moveButton = document.getElementById('moveButton');
    const todayButton = document.getElementById('todayButton');
    const addMemberButton = document.getElementById('addMemberButton');
    const loadButton = document.getElementById('loadButton');
    const fileInput = document.getElementById('fileInput');
    const saveButton = document.getElementById('saveButton');
    const errorMessageElement = document.getElementById('error-message');
    const tableWrapper = document.getElementById('table-wrapper');
    const scheduleTable = document.getElementById('scheduleTable');

    // =====================================================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° (ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹)
    // =====================================================================
    let currentDate = new Date();      // ç¾åœ¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒè¡¨ç¤ºã—ã¦ã„ã‚‹å¹´æœˆ
    let holidaysData = {};           // ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ ({"YYYY-MM-DD": "ç¥æ—¥å"})
    let members = [];                // ãƒ¡ãƒ³ãƒãƒ¼åã®ãƒªã‚¹ãƒˆ (è¡¨ç¤ºé †, ã‚¢ãƒ—ãƒªå…¨ä½“ã§å…±æœ‰)
    let scheduleData = {};           // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ ({"ãƒ¡ãƒ³ãƒãƒ¼å": {"YYYY-MM-DD": true}}, ã‚¢ãƒ—ãƒªå…¨ä½“ã§å…±æœ‰)
    let hasUnsavedChanges = false;   // æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹ã‹ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
    let resizeTimeout;               // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºæ™‚ã®å‡¦ç†é…å»¶ç”¨ã‚¿ã‚¤ãƒãƒ¼ID

    // =====================================================================
    // é–¢æ•°å®šç¾©
    // =====================================================================

    /**
     * ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’ holidays-jp API ã‹ã‚‰éåŒæœŸã§å–å¾—ã™ã‚‹ã€‚
     * @returns {Promise<boolean>} ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æˆå¦ã€‚
     */
    async function fetchHolidays() {
        const apiUrl = 'https://holidays-jp.github.io/api/v1/date.json';
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`APIã‚¨ãƒ©ãƒ¼ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status})`);
            holidaysData = await response.json();
            errorMessageElement.textContent = ''; // æˆåŠŸã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
            console.info("ç¥æ—¥ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ");
            return true;
        } catch (error) {
            console.error('ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            errorMessageElement.textContent = `ã‚¨ãƒ©ãƒ¼: ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚(${error.message})`;
            holidaysData = {}; // å–å¾—å¤±æ•—æ™‚ã¯ç©ºãƒ‡ãƒ¼ã‚¿ã«ãƒªã‚»ãƒƒãƒˆ
            return false;
        }
    }

    /**
     * å¹´æœˆæ—¥ã‹ã‚‰ 'YYYY-MM-DD' å½¢å¼ã®æ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹ã€‚
     * @param {number} year - å¹´ã€‚
     * @param {number} month - æœˆ (0-11)ã€‚
     * @param {number} day - æ—¥ (1-31)ã€‚
     * @returns {string} 'YYYY-MM-DD' å½¢å¼ã®æ–‡å­—åˆ—ã€‚
     */
    function formatDate(year, month, day) {
        return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    }

    /**
     * ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã®é«˜ã•ã‚’èª¿æ•´ã—ã€æ—¥ä»˜ã‚»ãƒ«ãŒæ­£æ–¹å½¢ã«è¿‘ã¥ãã‚ˆã†ã«ã™ã‚‹ã€‚
     * ã‚»ãƒ«ã®é«˜ã•ã¨ line-height ã‚’åŒæœŸã•ã›ã‚‹ã€‚
     */
    function adjustRowHeights() {
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚„ãƒ˜ãƒƒãƒ€ãƒ¼ã€ãƒœãƒ‡ã‚£ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å‡¦ç†ä¸­æ–­
        if (!scheduleTable || !headerRow || scheduleBody.children.length === 0) return;
        const memberNameHeader = headerRow.querySelector('th:first-child');
        if (!memberNameHeader) return; // ãƒ¡ãƒ³ãƒãƒ¼åãƒ˜ãƒƒãƒ€ãƒ¼ãŒãªã„å ´åˆã‚‚ä¸­æ–­

        // ã‚»ãƒ«å¹…ã‚’è¨ˆç®— (å¸¸ã«31æ—¥åˆ†ã®åˆ—ãŒã‚ã‚‹å‰æ)
        const memberNameWidth = memberNameHeader.offsetWidth;
        const dateColumnCount = MAX_DAYS;
        const tableVisibleWidth = scheduleTable.clientWidth;
        const availableWidthForDates = tableVisibleWidth - memberNameWidth;
        const cellWidth = Math.max(10, availableWidthForDates / dateColumnCount); // æœ€ä½å¹…10px

        // ã‚»ãƒ«ã®é«˜ã•ã‚’è¨ˆç®— (å¹…ã¨æœ€ä½é«˜ã•ã‚’æ¯”è¼ƒ)
        const calculatedHeight = Math.max(cellWidth, MIN_CELL_HEIGHT);
        const finalHeight = `${calculatedHeight}px`; // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨ç”¨ã®æ–‡å­—åˆ—

        // ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ãƒœãƒ‡ã‚£ã®å…¨ã‚»ãƒ«ã®é«˜ã•ã¨è¡Œé«˜ã•ã‚’è¨­å®š
        headerRow.querySelectorAll('th').forEach(th => { th.style.height = finalHeight; });
        Array.from(scheduleBody.children).forEach(row => {
            row.querySelectorAll('th, td').forEach(cell => {
                cell.style.height = finalHeight;
                cell.style.lineHeight = finalHeight; // th, td ä¸¡æ–¹ã«é©ç”¨
            });
        });
    }

    /**
     * æŒ‡å®šã•ã‚ŒãŸå¹´æœˆã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«è¡¨ã‚’æç”»ï¼ˆã¾ãŸã¯å†æç”»ï¼‰ã™ã‚‹ã€‚
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª `members` é…åˆ—ã«åŸºã¥ã„ã¦è¡Œã‚’ç”Ÿæˆã™ã‚‹ã€‚
     * @param {number} year - è¡¨ç¤ºã™ã‚‹å¹´ã€‚
     * @param {number} month - è¡¨ç¤ºã™ã‚‹æœˆ (0-11)ã€‚
     */
    function generateSchedule(year, month) {
        // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã®æ›´æ–°
        headerRow.innerHTML = '<th>ãƒ¡ãƒ³ãƒãƒ¼</th>'; // ãƒ˜ãƒƒãƒ€ãƒ¼åˆæœŸåŒ– (ãƒ¡ãƒ³ãƒãƒ¼åˆ—ã®ã¿æ®‹ã™)
        monthYearElement.textContent = `${year}å¹´ ${month + 1}æœˆ`;
        yearInput.value = year;
        monthInput.value = month + 1;
        const daysInMonth = new Date(year, month + 1, 0).getDate(); // è¡¨ç¤ºæœˆã®æ—¥æ•°
        const today = new Date();
        const todayYear = today.getFullYear();
        const todayMonth = today.getMonth();
        const todayDate = today.getDate();

        // æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ã‚»ãƒ«ç”Ÿæˆ (å¸¸ã«1æ—¥ã‹ã‚‰MAX_DAYSã¾ã§)
        for (let day = 1; day <= MAX_DAYS; day++) {
            const th = document.createElement('th');
            if (day <= daysInMonth) { // æœˆã®æ—¥ä»˜ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å†…å®¹ã‚’è¨­å®š
                const currentDay = new Date(year, month, day);
                const dayOfWeek = currentDay.getDay();
                const dateStr = formatDate(year, month, day);
                th.classList.add('date-header');
                th.innerHTML = `<span class="day-number">${day}</span><span class="day-of-week">(${WEEK_DAY_SHORT_NAMES[dayOfWeek]})</span>`;
                // æ›œæ—¥ãƒ»ç¥æ—¥ã‚¯ãƒ©ã‚¹è¨­å®š
                if (holidaysData[dateStr]) { th.classList.add('holiday'); th.title = holidaysData[dateStr]; }
                else if (dayOfWeek === 0) { th.classList.add('sunday'); }
                else if (dayOfWeek === 6) { th.classList.add('saturday'); }
                // ä»Šæ—¥ã®æ—¥ä»˜ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                if (year === todayYear && month === todayMonth && day === todayDate) {
                    th.classList.add('today-column');
                }
            } else { // æœˆã®æ—¥ä»˜ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯éè¡¨ç¤º
                th.classList.add('hidden-column');
            }
            headerRow.appendChild(th);
        }

        // ãƒœãƒ‡ã‚£éƒ¨åˆ†ã®ç”Ÿæˆ (ã‚°ãƒ­ãƒ¼ãƒãƒ«ã® `members` é…åˆ—ã‚’ä½¿ç”¨)
        scheduleBody.innerHTML = ''; // ãƒœãƒ‡ã‚£ã‚¯ãƒªã‚¢
        members.forEach(memberName => {
            const memberRow = createMemberRowElement(memberName, year, month, daysInMonth);
            scheduleBody.appendChild(memberRow);
        });

        // ãƒœãƒ‡ã‚£éƒ¨åˆ†ã®ä»Šæ—¥ã®åˆ—ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        if (year === todayYear && month === todayMonth) {
            const todayCellIndex = todayDate - 1; // 0å§‹ã¾ã‚Šã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
            Array.from(scheduleBody.querySelectorAll('tr')).forEach(row => {
                const cellsInRow = row.querySelectorAll('td');
                if (todayCellIndex >= 0 && cellsInRow.length > todayCellIndex) {
                     const bodyCell = cellsInRow[todayCellIndex];
                     if (bodyCell && !bodyCell.classList.contains('hidden-column')) { // éè¡¨ç¤ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
                         bodyCell.classList.add('today-column');
                    }
                }
            });
        }

        // DOMæ›´æ–°å¾Œã«é«˜ã•ã‚’èª¿æ•´
        requestAnimationFrame(adjustRowHeights);
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼1äººåˆ†ã®è¡Œè¦ç´ ï¼ˆ<tr>ï¼‰ã‚’ä½œæˆã™ã‚‹ã€‚
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª `scheduleData` ã‚’å‚ç…§ã—ã¦ã‚¯ãƒªãƒƒã‚¯çŠ¶æ…‹ã‚’å¾©å…ƒã™ã‚‹ã€‚
     * @param {string} memberName - ãƒ¡ãƒ³ãƒãƒ¼åã€‚
     * @param {number} year - å¹´ã€‚
     * @param {number} month - æœˆ (0-11)ã€‚
     * @param {number} daysInMonth - ãã®æœˆã®æ—¥æ•°ã€‚
     * @returns {HTMLTableRowElement} ä½œæˆã•ã‚ŒãŸè¡Œè¦ç´  (<tr>)ã€‚
     */
    function createMemberRowElement(memberName, year, month, daysInMonth) {
        const row = document.createElement('tr');
        // è¡Œè‡ªä½“ã«ãƒ¡ãƒ³ãƒãƒ¼åã‚’ data å±æ€§ã¨ã—ã¦ä¿æŒ (ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã§ã®ç‰¹å®šç”¨)
        row.dataset.memberName = memberName;

        // ãƒ¡ãƒ³ãƒãƒ¼åã‚»ãƒ« (th) ã‚’ä½œæˆãƒ»è¨­å®š
        const th = document.createElement('th');
        th.setAttribute('contenteditable', 'true');
        th.textContent = memberName;
        th.addEventListener('input', handleMemberNameInput);
        th.addEventListener('keypress', handleMemberNameEnter);
        th.addEventListener('keydown', handleMemberNameBackspace);
        row.appendChild(th);

        // æ—¥ä»˜ã‚»ãƒ« (td) ã‚’ç”Ÿæˆ (å¸¸ã«1æ—¥ã‹ã‚‰MAX_DAYSã¾ã§)
        for (let day = 1; day <= MAX_DAYS; day++) {
            const td = document.createElement('td');
            if (day <= daysInMonth) { // æœˆã®æ—¥ä»˜ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å†…å®¹ã‚’è¨­å®š
                const dateStr = formatDate(year, month, day);
                td.dataset.date = dateStr; // æ—¥ä»˜æƒ…å ±ã‚’ data å±æ€§ã¨ã—ã¦ä¿æŒ
                // æ›œæ—¥ã‚¯ãƒ©ã‚¹è¨­å®š
                const currentDay = new Date(year, month, day);
                const dayOfWeek = currentDay.getDay();
                if (holidaysData[dateStr]) { td.classList.add('holiday-cell'); }
                else if (dayOfWeek === 0) { td.classList.add('sunday-cell'); }
                else if (dayOfWeek === 6) { td.classList.add('saturday-cell'); }
                // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã‚¯ãƒªãƒƒã‚¯çŠ¶æ…‹å¾©å…ƒ (ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª `scheduleData` ã‚’å‚ç…§)
                if (scheduleData[memberName] && scheduleData[memberName][dateStr]) {
                    td.classList.add('clicked-cell');
                }
            } else { // æœˆã®æ—¥ä»˜ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯éè¡¨ç¤º
                td.classList.add('hidden-column');
            }
            row.appendChild(td);
        }
        return row;
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼åã‚»ãƒ« (`th`) ãŒç·¨é›†ã•ã‚ŒãŸã¨ãã®å‡¦ç†ã€‚
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª `members` é…åˆ—ã¨ `scheduleData` ã‚’æ›´æ–°ã™ã‚‹ã€‚
     * @param {Event} event - inputã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
     */
    function handleMemberNameInput(event) {
        setUnsavedChanges(true);
        const cell = event.target;
        const currentRow = cell.closest('tr');
        const newName = cell.textContent.trim(); // æ–°ã—ã„åå‰ (ç©ºç™½é™¤å»)
        const originalName = currentRow.dataset.memberName; // è¡Œã®dataå±æ€§ã‹ã‚‰å…ƒã®åå‰ã‚’å–å¾—

        // ã‚°ãƒ­ãƒ¼ãƒãƒ« `members` é…åˆ—å†…ã®åå‰ã‚’æ›´æ–°
        const memberIndex = members.indexOf(originalName);
        if (memberIndex > -1) { // å…ƒã®åå‰ãŒé…åˆ—å†…ã«è¦‹ã¤ã‹ã£ãŸå ´åˆ
            // æ–°ã—ã„åå‰ãŒä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã¨é‡è¤‡ã—ãªã„ã‹ãƒã‚§ãƒƒã‚¯ (è‡ªåˆ†è‡ªèº«ã‚’é™¤ã)
            if (newName && members.some((m, idx) => m === newName && idx !== memberIndex)) {
                console.warn(`ãƒ¡ãƒ³ãƒãƒ¼åå¤‰æ›´è­¦å‘Š: "${newName}" ã¯æ—¢ã«ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã¨é‡è¤‡ã—ã¦ã„ã¾ã™ã€‚`);
            }
            members[memberIndex] = newName; // é…åˆ—å†…ã®åå‰ã‚’æ›´æ–°
            currentRow.dataset.memberName = newName; // è¡Œã®dataå±æ€§ã‚‚æ›´æ–°

            // ã‚°ãƒ­ãƒ¼ãƒãƒ« `scheduleData` ã®ã‚­ãƒ¼ã‚‚æ›´æ–°
            if (originalName !== newName && scheduleData[originalName]) {
                // æ–°ã—ã„åå‰ã®ã‚­ãƒ¼ãŒæ—¢ã«å­˜åœ¨ã—ãªã‘ã‚Œã°ã€ãƒ‡ãƒ¼ã‚¿ã‚’ç§»å‹•
                if (!scheduleData[newName]) {
                    scheduleData[newName] = scheduleData[originalName];
                } else { // å­˜åœ¨ã™ã‚‹å ´åˆã¯ã€é‡è¤‡è­¦å‘Šã‚’å‡ºã—ã€å…ƒã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ (ãƒãƒ¼ã‚¸ã¯ã—ãªã„)
                    console.warn(`ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°è­¦å‘Š: ã‚­ãƒ¼ "${newName}" ã¯æ—¢ã«å­˜åœ¨ã™ã‚‹ãŸã‚ã€"${originalName}" ã®ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã¾ã™ã€‚`);
                }
                delete scheduleData[originalName]; // å¤ã„ã‚­ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
            } else if (originalName !== newName && !scheduleData[newName]) {
                 // å…ƒã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒãªãã€æ–°ã—ã„åå‰ã®ã‚­ãƒ¼ã‚‚ãªã„å ´åˆã€æ–°ã—ã„ã‚­ãƒ¼ã§ç©ºã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                 scheduleData[newName] = {};
            }

        } else if (originalName === "" && newName) { // ç©ºã®è¡Œã«åˆã‚ã¦åå‰ãŒå…¥åŠ›ã•ã‚ŒãŸå ´åˆ
            // `members` é…åˆ—ã®æœ€å¾Œã®ç©ºè¦ç´  ("") ã‚’æ›´æ–°
            const lastEmptyIndex = members.lastIndexOf("");
            if (lastEmptyIndex > -1) {
                 // æ–°ã—ã„åå‰ãŒä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã¨é‡è¤‡ã—ãªã„ã‹ãƒã‚§ãƒƒã‚¯
                 if (members.some((m, idx) => m === newName && idx !== lastEmptyIndex)) {
                     console.warn(`æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼åè­¦å‘Š: "${newName}" ã¯æ—¢ã«ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã¨é‡è¤‡ã—ã¦ã„ã¾ã™ã€‚`);
                 }
                members[lastEmptyIndex] = newName;
                currentRow.dataset.memberName = newName; // è¡Œã®dataå±æ€§ã‚’æ›´æ–°
                // `scheduleData` ã«ã‚‚ã‚¨ãƒ³ãƒˆãƒªã‚’ä½œæˆ (ã¾ã å­˜åœ¨ã—ãªã„å ´åˆ)
                if (!scheduleData[newName]) {
                    scheduleData[newName] = {};
                }
            }
        }
    }

    /**
     * æ–°ã—ã„ãƒ¡ãƒ³ãƒãƒ¼è¡Œï¼ˆç©ºè¡Œï¼‰ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ«å°¾ã«è¿½åŠ ã—ã€
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª`members`é…åˆ—ã«ã‚‚ç©ºæ–‡å­—åˆ—ã‚’è¿½åŠ ã™ã‚‹ã€‚
     * @param {boolean} [setUnsaved=true] - è¿½åŠ æ™‚ã«æœªä¿å­˜ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ã‹ã€‚
     */
    function addMemberRow(setUnsaved = true) {
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

        // ã‚°ãƒ­ãƒ¼ãƒãƒ« `members` é…åˆ—ã«ç©ºæ–‡å­—åˆ—ã‚’è¿½åŠ 
        const newMemberName = "";
        members.push(newMemberName);

        // æ–°ã—ã„è¡Œè¦ç´ ã‚’ä½œæˆã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ 
        const newRow = createMemberRowElement(newMemberName, currentYear, currentMonth, daysInMonth);
        scheduleBody.appendChild(newRow);

        // æ–°ã—ã„è¡Œã«ã‚‚ä»Šæ—¥ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’é©ç”¨
        const today = new Date();
        if (currentYear === today.getFullYear() && currentMonth === today.getMonth()) {
            const todayCellIndex = today.getDate() - 1;
            const cellsInNewRow = newRow.querySelectorAll('td');
            if (todayCellIndex >= 0 && cellsInNewRow.length > todayCellIndex) {
                 const todayCell = cellsInNewRow[todayCellIndex];
                 if (todayCell && !todayCell.classList.contains('hidden-column')) {
                     todayCell.classList.add('today-column');
                 }
            }
        }

        // UIèª¿æ•´ã¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        requestAnimationFrame(adjustRowHeights);
        tableWrapper.scrollTop = tableWrapper.scrollHeight; // æœ€ä¸‹éƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        const newMemberCell = newRow.querySelector('th[contenteditable="true"]');
        if (newMemberCell) newMemberCell.focus(); // æ–°è¦è¡Œã®ãƒ¡ãƒ³ãƒãƒ¼åã‚»ãƒ«ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        if (setUnsaved) setUnsavedChanges(true);
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼åã‚»ãƒ«ã§Enterã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†ã€‚
     * æ¬¡ã®è¡Œã¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•ã€ã¾ãŸã¯æœ€çµ‚è¡Œãªã‚‰æ–°è¦è¡Œè¿½åŠ ã€‚
     * @param {KeyboardEvent} event - keypressã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
     */
    function handleMemberNameEnter(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ”¹è¡Œå‹•ä½œã‚’æŠ‘åˆ¶
            const cell = event.target;
            const currentRow = cell.closest('tr');
            const rows = Array.from(scheduleBody.children);
            const currentIndex = rows.findIndex(row => row === currentRow);

            if (currentIndex === rows.length - 1) { // æœ€çµ‚è¡Œã®å ´åˆ
                addMemberRow(); // æ–°ã—ã„ãƒ¡ãƒ³ãƒãƒ¼è¡Œã‚’è¿½åŠ 
            } else { // æœ€çµ‚è¡Œã§ãªã„å ´åˆ
                const nextRow = rows[currentIndex + 1]; // æ¬¡ã®è¡Œã‚’å–å¾—
                const nextMemberCell = nextRow?.querySelector('th[contenteditable="true"]');
                if (nextMemberCell) nextMemberCell.focus(); // æ¬¡ã®è¡Œã®ãƒ¡ãƒ³ãƒãƒ¼åã‚»ãƒ«ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            }
        }
    }

    /**
     * ãƒ¡ãƒ³ãƒãƒ¼åã‚»ãƒ«ãŒç©ºã®çŠ¶æ…‹ã§Backspaceã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®å‡¦ç†ã€‚
     * è¡Œã‚’å‰Šé™¤ã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª `members` é…åˆ—ã¨ `scheduleData` ã‹ã‚‰ã‚‚å‰Šé™¤ã™ã‚‹ã€‚
     * @param {KeyboardEvent} event - keydownã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
     */
    function handleMemberNameBackspace(event) {
         if (event.key === 'Backspace') {
            const cell = event.target;
            const currentRow = cell.closest('tr');
            const memberName = currentRow.dataset.memberName; // è¡Œã®dataå±æ€§ã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼åã‚’å–å¾—

            // ã‚»ãƒ«ãŒç©ºã§ã€ã‹ã¤ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¤‡æ•°ã®è¡ŒãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å‡¦ç†
            if (cell.textContent.trim() === '' && members.length > 1) {
                event.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œã‚’æŠ‘åˆ¶

                // ã‚°ãƒ­ãƒ¼ãƒãƒ« `members` é…åˆ—ã‹ã‚‰å‰Šé™¤
                const memberIndex = members.indexOf(memberName);
                if (memberIndex > -1) {
                    members.splice(memberIndex, 1);
                } else { // memberNameãŒç©º("")ã®å ´åˆãªã©ã€è¦‹ã¤ã‹ã‚‰ãªã„ã‚±ãƒ¼ã‚¹ã‚‚è€ƒæ…®
                     const lastEmptyIndex = members.lastIndexOf("");
                     if (lastEmptyIndex > -1) members.splice(lastEmptyIndex, 1);
                }

                // ã‚°ãƒ­ãƒ¼ãƒãƒ« `scheduleData` ã‹ã‚‰å‰Šé™¤
                if (memberName && scheduleData[memberName]) {
                    delete scheduleData[memberName];
                }

                // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•å‡¦ç†
                const rows = Array.from(scheduleBody.children);
                const currentIndex = rows.findIndex(row => row === currentRow);
                let focusMoved = false;
                if (currentIndex > 0) { // ä¸Šã®è¡ŒãŒã‚ã‚Œã°ãã¡ã‚‰ã¸
                    const prevRow = rows[currentIndex - 1];
                    const prevMemberCell = prevRow?.querySelector('th[contenteditable="true"]');
                    if (prevMemberCell) {
                        prevMemberCell.focus();
                        // ã‚«ãƒ¼ã‚½ãƒ«ã‚’æœ«å°¾ã«ç§»å‹•
                        const range = document.createRange(); const sel = window.getSelection();
                        range.selectNodeContents(prevMemberCell); range.collapse(false);
                        sel.removeAllRanges(); sel.addRange(range);
                        focusMoved = true;
                    }
                }
                if (!focusMoved && rows.length > 2) { // ä¸Šã«ç§»å‹•ã§ããšã€ä»–ã«ã¾ã è¡ŒãŒæ®‹ã‚‹å ´åˆ (å‰Šé™¤å¾Œã‚‚1è¡Œä»¥ä¸Šæ®‹ã‚‹)
                     const nextRow = rows[currentIndex + 1] || rows[0]; // å‰Šé™¤å¾Œã®æ¬¡ã®è¡Œ or æœ€åˆã®è¡Œ
                     if(nextRow && nextRow !== currentRow) { // è‡ªåˆ†è‡ªèº«ä»¥å¤–
                         const nextMemberCell = nextRow.querySelector('th[contenteditable="true"]');
                         if (nextMemberCell) nextMemberCell.focus();
                     }
                }

                // è¡Œè¦ç´ ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å‰Šé™¤
                currentRow.remove();
                setUnsavedChanges(true);
                requestAnimationFrame(adjustRowHeights); // é«˜ã•å†èª¿æ•´
            }
        }
    }

    /**
     * æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ« (`td`) ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã®å‡¦ç†ã€‚
     * èƒŒæ™¯è‰²ã‚’ãƒˆã‚°ãƒ«ã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª `scheduleData` ã‚’æ›´æ–°ã™ã‚‹ã€‚
     * @param {MouseEvent} event - clickã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚
     */
    function handleCellClick(event) {
        const target = event.target;
        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ãŒ TD ã§ã€éè¡¨ç¤ºåˆ—ã§ãªãã€æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚’æŒã£ã¦ã„ã‚‹å ´åˆ
        if (target.tagName === 'TD' && !target.classList.contains('hidden-column') && target.dataset.date) {
            const currentRow = target.closest('tr');
            const memberName = currentRow.dataset.memberName; // è¡Œã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼åã‚’å–å¾—
            const dateStr = target.dataset.date; // ã‚»ãƒ«ã‹ã‚‰æ—¥ä»˜ã‚’å–å¾—

            // ãƒ¡ãƒ³ãƒãƒ¼åãŒç©ºã®å ´åˆã¯è­¦å‘Šã—ã€åå‰å…¥åŠ›ã‚»ãƒ«ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            if (memberName === "") {
                 alert("ãƒ¡ãƒ³ãƒãƒ¼åã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚");
                 const memberCell = currentRow?.querySelector('th[contenteditable="true"]');
                 if (memberCell) memberCell.focus();
                 return;
            }

            // `scheduleData` ã®æ›´æ–° (ãƒˆã‚°ãƒ«å‡¦ç†)
            if (!scheduleData[memberName]) { // å¿µã®ãŸã‚ã€ãƒ¡ãƒ³ãƒãƒ¼ã‚¨ãƒ³ãƒˆãƒªãŒãªã‘ã‚Œã°ä½œæˆ
                scheduleData[memberName] = {};
                console.warn(`ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã«ãƒ¡ãƒ³ãƒãƒ¼ "${memberName}" ãŒå­˜åœ¨ã—ãªã‹ã£ãŸãŸã‚ä½œæˆã—ã¾ã—ãŸã€‚`);
            }
            if (!scheduleData[memberName][dateStr]) { // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã‘ã‚Œã° true ã‚’è¨­å®š
                scheduleData[memberName][dateStr] = true;
                target.classList.add('clicked-cell'); // ã‚¯ãƒªãƒƒã‚¯æ¸ˆã¿ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
            } else { // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚Œã°å‰Šé™¤ (ãƒˆã‚°ãƒ«OFF)
                delete scheduleData[memberName][dateStr];
                target.classList.remove('clicked-cell'); // ã‚¯ãƒªãƒƒã‚¯æ¸ˆã¿ã‚¹ã‚¿ã‚¤ãƒ«è§£é™¤
            }
            setUnsavedChanges(true); // æœªä¿å­˜ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
        }
    }

    /**
     * æœªä¿å­˜çŠ¶æ…‹ãƒ•ãƒ©ã‚°ã‚’æ›´æ–°ã—ã€UIï¼ˆä¿å­˜ãƒœã‚¿ãƒ³ã®è‰²ã€æœ‰åŠ¹/ç„¡åŠ¹ï¼‰ã«åæ˜ ã™ã‚‹ã€‚
     * @param {boolean} status - æœªä¿å­˜çŠ¶æ…‹ã«ã™ã‚‹å ´åˆã¯ trueã€‚
     */
    function setUnsavedChanges(status) {
        // çŠ¶æ…‹ãŒå®Ÿéš›ã«å¤‰åŒ–ã—ãŸå ´åˆã®ã¿å‡¦ç†
        if (hasUnsavedChanges !== status) {
            hasUnsavedChanges = status;
            saveButton.disabled = !status; // ä¿å­˜ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
            // æœªä¿å­˜çŠ¶æ…‹ã«å¿œã˜ã¦ä¿å­˜ãƒœã‚¿ãƒ³ã®å¼·èª¿è¡¨ç¤ºã‚¯ãƒ©ã‚¹ã‚’ä»˜ã‘å¤–ã—
            if (status) {
                saveButton.classList.add('unsaved');
            } else {
                saveButton.classList.remove('unsaved');
            }
        }
    }

    /**
     * JSONãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã¨ãã®èª­ã¿è¾¼ã¿å‡¦ç†ã€‚
     * ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª `members` ã¨ `scheduleData` ã‚’æ›´æ–°å¾Œã€
     * ç¾åœ¨è¡¨ç¤ºä¸­ã®å¹´æœˆã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»ã™ã‚‹ã€‚
     * @param {Event} event - changeã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ (input[type=file])ã€‚
     */
    function handleFileLoad(event) {
        const file = event.target.files[0];
        if (!file) return; // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œãªã‹ã£ãŸå ´åˆ
        console.info(`JSONãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹: ${file.name}`);
        const reader = new FileReader();

        reader.onload = function(e) {
            const jsonString = e.target.result;
            try {
                const data = JSON.parse(jsonString);
                // å¿…é ˆãƒ‡ãƒ¼ã‚¿ (membersé…åˆ—, scheduleã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ) ã®å­˜åœ¨ã¨å‹ã‚’ãƒã‚§ãƒƒã‚¯
                if (data && Array.isArray(data.members) && typeof data.schedule === 'object' && data.schedule !== null) {
                    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ã
                    members = data.members.filter(m => typeof m === 'string'); // æ–‡å­—åˆ—å‹ã®ã¿å—ã‘å…¥ã‚Œã‚‹
                    scheduleData = data.schedule || {}; // scheduleãŒnullã®å ´åˆã‚’è€ƒæ…®

                    // `scheduleData` ã«å«ã¾ã‚Œã‚‹ã‚­ãƒ¼ãŒ `members` é…åˆ—ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã€ä¸è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                    Object.keys(scheduleData).forEach(key => {
                        if (!members.includes(key)) {
                            delete scheduleData[key];
                            console.warn(`èª­ã¿è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆ: scheduleData ã«ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆå¤–ã®ã‚­ãƒ¼ "${key}" ãŒã‚ã£ãŸãŸã‚å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
                        }
                    });

                    // èª­ã¿è¾¼ã‚“ã  `members` é…åˆ—å†…ã®ç©ºæ–‡å­—åˆ—ã‚’æ•´ç† (æœ€åˆã®1ã¤ã ã‘æ®‹ã™)
                    const emptyMemberIndices = members.map((m, i) => m.trim() === "" ? i : -1).filter(i => i !== -1);
                    if (emptyMemberIndices.length > 1) {
                        // 2ã¤ç›®ä»¥é™ã®ç©ºæ–‡å­—åˆ—ã‚’å‰Šé™¤
                        for (let i = emptyMemberIndices.length - 1; i > 0; i--) {
                            members.splice(emptyMemberIndices[i], 1);
                        }
                        console.warn("èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã«è¤‡æ•°ã®ç©ºãƒ¡ãƒ³ãƒãƒ¼ãŒå«ã¾ã‚Œã¦ã„ãŸãŸã‚ã€1ã¤ã«ã¾ã¨ã‚ã¾ã—ãŸã€‚");
                    }
                    // èª­ã¿è¾¼ã¿å¾Œã«ãƒ¡ãƒ³ãƒãƒ¼ãŒèª°ã‚‚ã„ãªã„å ´åˆ (ç©ºãƒ¡ãƒ³ãƒãƒ¼ã‚‚ã„ãªã„)ã€åˆæœŸçŠ¶æ…‹ã®ç©ºè¡Œã‚’è¿½åŠ 
                    if (members.length === 0) {
                        scheduleData = {}; // scheduleDataã‚‚ãƒªã‚»ãƒƒãƒˆ
                        addMemberRow(false); // æœªä¿å­˜ãƒ•ãƒ©ã‚°ãªã—ã§ç©ºè¡Œè¿½åŠ 
                    }

                    // ç¾åœ¨è¡¨ç¤ºä¸­ã®å¹´æœˆã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
                    generateSchedule(currentDate.getFullYear(), currentDate.getMonth());
                    errorMessageElement.textContent = ''; // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
                    alert(`ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚\nã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¯ç¾åœ¨è¡¨ç¤ºä¸­ã®å¹´æœˆã‚’ç¶­æŒã—ã¾ã™ã€‚`);
                    setUnsavedChanges(false); // èª­ã¿è¾¼ã¿ç›´å¾Œã¯æœªä¿å­˜çŠ¶æ…‹
                    console.info(`JSONãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ: ${file.name}`);
                } else {
                     throw new Error("JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚(members(é…åˆ—), schedule(ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ)ãŒå¿…é ˆã§ã™)");
                }
            } catch (error) {
                console.error(`JSONèª­ã¿è¾¼ã¿/è§£æå¤±æ•— (${file.name}):`, error);
                errorMessageElement.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n${error.message}`);
                initializeSchedule(); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
            } finally {
                fileInput.value = null; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ (åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠã§ãã‚‹ã‚ˆã†ã«)
            }
        };
        reader.onerror = function(e) {
            console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            errorMessageElement.textContent = 'ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            fileInput.value = null;
        };
        reader.readAsText(file);
    }

    /**
     * ç¾åœ¨æ™‚åˆ»ã‹ã‚‰ 'YYYYMMDDHHMMSS' å½¢å¼ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹ã€‚
     * @returns {string} ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ–‡å­—åˆ—ã€‚
     */
    function getTimestampString() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `${year}${month}${day}${hours}${minutes}${seconds}`;
    }

    /**
     * ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼çµµæ–‡å­—ğŸ“…ã‚’Faviconã¨ã—ã¦è¨­å®šã™ã‚‹ã€‚
     */
    function setCalendarFavicon() {
        const emoji = 'ğŸ“…'; const size = 32;
        const canvas = document.createElement('canvas');
        canvas.width = size; canvas.height = size;
        const ctx = canvas.getContext('2d');
        if (!ctx) return; // Canvasæœªå¯¾å¿œã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
        // çµµæ–‡å­—ã‚’Canvasã«æç”»
        ctx.font = `${size * 0.85}px sans-serif`;
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(emoji, size / 2, size / 2 + size * 0.08); // Yåº§æ¨™ã‚’å¾®èª¿æ•´ã—ã¦ä¸­å¤®ã«è¦‹ãˆã‚‹ã‚ˆã†ã«
        try {
            // Canvasã‚’PNGãƒ‡ãƒ¼ã‚¿URLã«å¤‰æ›ã—ã¦Faviconã«è¨­å®š
            const dataURL = canvas.toDataURL('image/png');
            let link = document.querySelector("link[rel*='icon']");
            if (!link) { // linkè¦ç´ ãŒãªã‘ã‚Œã°ä½œæˆ
                link = document.createElement('link');
                link.rel = 'icon';
                document.head.appendChild(link);
            }
            link.type = 'image/png';
            link.href = dataURL;
        } catch (error) {
            console.error("Faviconã®è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
        }
    }

    /**
     * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–å‡¦ç†ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œï¼‰ã€‚
     * ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€ç¾åœ¨ã®å¹´æœˆã§ç©ºã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»ã™ã‚‹ã€‚
     */
    async function initializeSchedule() {
        console.info("ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–é–‹å§‹");
        // UIåˆæœŸçŠ¶æ…‹è¨­å®š
        monthYearElement.textContent = 'ç¥æ—¥ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­...';
        scheduleBody.innerHTML = `<tr><td colspan="${MAX_DAYS + 1}" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</td></tr>`;
        saveButton.disabled = true; // ä¿å­˜ãƒœã‚¿ãƒ³ã¯åˆæœŸçŠ¶æ…‹ã§ã¯ç„¡åŠ¹
        saveButton.classList.remove('unsaved'); // å¼·èª¿è¡¨ç¤ºã‚‚è§£é™¤
        setCalendarFavicon(); // Faviconè¨­å®š

        // ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’éåŒæœŸã§å–å¾—
        await fetchHolidays();

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
        members = []; // ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’ç©ºã«ã™ã‚‹
        scheduleData = {}; // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç©ºã«ã™ã‚‹
        addMemberRow(false); // æœ€åˆã®ç©ºã®ãƒ¡ãƒ³ãƒãƒ¼è¡Œã‚’è¿½åŠ  (æœªä¿å­˜ãƒ•ãƒ©ã‚°ã¯ç«‹ã¦ãªã„)
        currentDate = new Date(); // è¡¨ç¤ºå¹´æœˆã‚’ç¾åœ¨ã«ãƒªã‚»ãƒƒãƒˆ

        // åˆæœŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        generateSchedule(currentDate.getFullYear(), currentDate.getMonth());
        setUnsavedChanges(false); // æœªä¿å­˜ãƒ•ãƒ©ã‚°è§£é™¤
        console.info("ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å®Œäº†");
        requestAnimationFrame(adjustRowHeights); // åˆæœŸé«˜ã•èª¿æ•´
    }


    // =====================================================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    // =====================================================================

    // --- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœãƒ‡ã‚£ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ (ã‚¤ãƒ™ãƒ³ãƒˆå§”ä»») ---
    scheduleBody.addEventListener('click', handleCellClick);

    // --- æ“ä½œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    prevMonthButton.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        generateSchedule(currentDate.getFullYear(), currentDate.getMonth());
    });
    nextMonthButton.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        generateSchedule(currentDate.getFullYear(), currentDate.getMonth());
    });
    moveButton.addEventListener('click', () => {
        const year = parseInt(yearInput.value, 10);
        const month = parseInt(monthInput.value, 10) - 1; // æœˆã¯0-11ã§æ‰±ã†ãŸã‚-1
        // å…¥åŠ›å€¤ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (!isNaN(year) && year > 1900 && year < 3000 && !isNaN(month) && month >= 0 && month < 12) {
             // ç¾åœ¨è¡¨ç¤ºä¸­ã®å¹´æœˆã¨åŒã˜ãªã‚‰ä½•ã‚‚ã—ãªã„
             if (year === currentDate.getFullYear() && month === currentDate.getMonth()) return;
             currentDate = new Date(year, month, 1); // æ–°ã—ã„å¹´æœˆã§Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ›´æ–°
             generateSchedule(currentDate.getFullYear(), currentDate.getMonth());
        } else {
            alert("æœ‰åŠ¹ãªå¹´æœˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (ä¾‹: å¹´=2024, æœˆ=1ï½12)ã€‚");
            // ä¸æ­£ãªå…¥åŠ›ã®å ´åˆã¯å…¥åŠ›æ¬„ã‚’ç¾åœ¨ã®å¹´æœˆã«æˆ»ã™
            yearInput.value = currentDate.getFullYear();
            monthInput.value = currentDate.getMonth() + 1;
        }
    });
    todayButton.addEventListener('click', () => {
        const today = new Date();
        // ç¾åœ¨è¡¨ç¤ºä¸­ã®æœˆãŒä»Šæœˆã§ãªã‘ã‚Œã°ç§»å‹•
        if (currentDate.getFullYear() !== today.getFullYear() || currentDate.getMonth() !== today.getMonth()) {
             currentDate = today; // currentDateã‚’ä»Šæ—¥ã«æ›´æ–°
             generateSchedule(currentDate.getFullYear(), currentDate.getMonth());
        } else { // æ—¢ã«ä»Šæœˆã‚’è¡¨ç¤ºä¸­ã®å ´åˆã¯ä»Šæ—¥ã®åˆ—ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
             console.info("æ—¢ã«ä»Šæœˆã‚’è¡¨ç¤ºä¸­ã§ã™ã€‚ä»Šæ—¥ã®åˆ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¾ã™ã€‚");
             const todayHeader = headerRow.querySelector('.today-column');
             if (todayHeader) { // ä»Šæ—¥ã®åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Œã°
                 todayHeader.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
             }
        }
    });
    addMemberButton.addEventListener('click', () => addMemberRow(true)); // æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼è¡Œè¿½åŠ 

    // --- ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    loadButton.addEventListener('click', () => {
        // æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        if (hasUnsavedChanges && !confirm("æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚èª­ã¿è¾¼ã‚€ã¨ç¾åœ¨ã®å¤‰æ›´ã¯å¤±ã‚ã‚Œã¾ã™ãŒã€ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
            return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‚‰å‡¦ç†ä¸­æ–­
        }
        fileInput.click(); // éè¡¨ç¤ºã® file input ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
    });
    fileInput.addEventListener('change', handleFileLoad); // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã‚‰ handleFileLoad ã‚’å®Ÿè¡Œ

    // ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    saveButton.addEventListener('click', () => {
        console.info("JSONä¿å­˜å‡¦ç†é–‹å§‹");

        // 1. ä¿å­˜ã™ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’ä½œæˆ (åå‰ãŒç©ºã§ãªã„ãƒ¡ãƒ³ãƒãƒ¼ã®ã¿)
        const membersToSave = members.filter(name => name.trim() !== "");

        // 2. ä¿å­˜ã™ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ (membersToSave ã«å«ã¾ã‚Œã€ã‹ã¤ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒ1ä»¶ä»¥ä¸Šã‚ã‚‹ã‚‚ã®)
        const scheduleDataToSave = {};
        membersToSave.forEach(name => {
            if (scheduleData[name] && Object.keys(scheduleData[name]).length > 0) {
                scheduleDataToSave[name] = scheduleData[name];
            }
        });

        // 3. ä¿å­˜ç”¨ãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
        const dataToSave = {
            // year/month ã¯èª­ã¿è¾¼ã¿æ™‚ã®äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã™ãŒã€å€¤ã¯ç¾åœ¨ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºå¹´æœˆ
            year: currentDate.getFullYear(),
            month: currentDate.getMonth() + 1,
            members: membersToSave,     // åå‰ãŒç©ºã§ãªã„ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆ
            schedule: scheduleDataToSave // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã¿
        };

        // 4. JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        try {
            const jsonString = JSON.stringify(dataToSave, null, 2); // è¦‹ã‚„ã™ã„ã‚ˆã†ã«æ•´å½¢
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = getTimestampString();
            a.download = `CL${timestamp}.json`; // ãƒ•ã‚¡ã‚¤ãƒ«åã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ä¸
            document.body.appendChild(a);
            a.click(); // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
            document.body.removeChild(a); // ä¸è¦ã«ãªã£ãŸãƒªãƒ³ã‚¯è¦ç´ ã‚’å‰Šé™¤
            URL.revokeObjectURL(url); // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆURLã‚’è§£æ”¾
            console.info(`JSONä¿å­˜æˆåŠŸ: ${a.download}`);

            // 5. ä¿å­˜æˆåŠŸå¾Œã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã®çŠ¶æ…‹ã‚‚ä¿å­˜å†…å®¹ã«åˆã‚ã›ã¦æ›´æ–°
            members = membersToSave;         // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            scheduleData = scheduleDataToSave; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°

            // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒç©ºã«ãªã£ãŸãƒ¡ãƒ³ãƒãƒ¼ã®ãŸã‚ã«ã€scheduleDataã«ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å†è¨­å®š
            members.forEach(name => {
                if (!scheduleData[name]) {
                    scheduleData[name] = {};
                }
            });

            // ã‚‚ã—ä¿å­˜å¾Œã«ãƒ¡ãƒ³ãƒãƒ¼ãŒèª°ã‚‚ã„ãªããªã£ãŸã‚‰ã€ç©ºè¡Œã‚’1ã¤è¿½åŠ 
            if (members.length === 0) {
                members = []; // å¿µã®ãŸã‚ãƒªã‚»ãƒƒãƒˆ
                scheduleData = {};
                addMemberRow(false);
            }

            setUnsavedChanges(false); // æœªä¿å­˜ãƒ•ãƒ©ã‚°è§£é™¤

            // 6. UIã‚‚æœ€æ–°ã®çŠ¶æ…‹ã«æ›´æ–° (ç©ºè¡ŒãŒæ¶ˆãˆã‚‹ãªã©)
             generateSchedule(currentDate.getFullYear(), currentDate.getMonth());

        } catch (error) {
            console.error("JSONä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:", error);
            errorMessageElement.textContent = "ã‚¨ãƒ©ãƒ¼: JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            alert("JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        }
    });

    // --- ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆ (debounceå‡¦ç†ä»˜ã) ---
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout); // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
        // ä¸€å®šæ™‚é–“å¾Œã«é«˜ã•èª¿æ•´ã‚’å®Ÿè¡Œ
        resizeTimeout = setTimeout(() => {
            requestAnimationFrame(adjustRowHeights);
        }, RESIZE_DEBOUNCE_TIME);
    });

    // =====================================================================
    // åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
    // =====================================================================
    initializeSchedule();

</script>

</body>
</html>
